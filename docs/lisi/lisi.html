<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.20">
<meta name="author" content="Benjamin Kober">
<title>Lisi - LIterate Scripting Interpreter</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
pre.pygments .hll { background-color: #ffffcc }
pre.pygments { background: #f8f8f8; }
pre.pygments .tok-c { color: #3D7B7B; font-style: italic } /* Comment */
pre.pygments .tok-err { border: 1px solid #FF0000 } /* Error */
pre.pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
pre.pygments .tok-o { color: #666666 } /* Operator */
pre.pygments .tok-ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
pre.pygments .tok-cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
pre.pygments .tok-cp { color: #9C6500 } /* Comment.Preproc */
pre.pygments .tok-cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
pre.pygments .tok-c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
pre.pygments .tok-cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
pre.pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
pre.pygments .tok-ge { font-style: italic } /* Generic.Emph */
pre.pygments .tok-gr { color: #E40000 } /* Generic.Error */
pre.pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
pre.pygments .tok-gi { color: #008400 } /* Generic.Inserted */
pre.pygments .tok-go { color: #717171 } /* Generic.Output */
pre.pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
pre.pygments .tok-gs { font-weight: bold } /* Generic.Strong */
pre.pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
pre.pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
pre.pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
pre.pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
pre.pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
pre.pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
pre.pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
pre.pygments .tok-kt { color: #B00040 } /* Keyword.Type */
pre.pygments .tok-m { color: #666666 } /* Literal.Number */
pre.pygments .tok-s { color: #BA2121 } /* Literal.String */
pre.pygments .tok-na { color: #687822 } /* Name.Attribute */
pre.pygments .tok-nb { color: #008000 } /* Name.Builtin */
pre.pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
pre.pygments .tok-no { color: #880000 } /* Name.Constant */
pre.pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
pre.pygments .tok-ni { color: #717171; font-weight: bold } /* Name.Entity */
pre.pygments .tok-ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
pre.pygments .tok-nf { color: #0000FF } /* Name.Function */
pre.pygments .tok-nl { color: #767600 } /* Name.Label */
pre.pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
pre.pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
pre.pygments .tok-nv { color: #19177C } /* Name.Variable */
pre.pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
pre.pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
pre.pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
pre.pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
pre.pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
pre.pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
pre.pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
pre.pygments .tok-sa { color: #BA2121 } /* Literal.String.Affix */
pre.pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
pre.pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
pre.pygments .tok-dl { color: #BA2121 } /* Literal.String.Delimiter */
pre.pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
pre.pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
pre.pygments .tok-se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
pre.pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
pre.pygments .tok-si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
pre.pygments .tok-sx { color: #008000 } /* Literal.String.Other */
pre.pygments .tok-sr { color: #A45A77 } /* Literal.String.Regex */
pre.pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
pre.pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
pre.pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
pre.pygments .tok-fm { color: #0000FF } /* Name.Function.Magic */
pre.pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
pre.pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
pre.pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
pre.pygments .tok-vm { color: #19177C } /* Name.Variable.Magic */
pre.pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Lisi - LIterate Scripting Interpreter</h1>
<div class="details">
<span id="author" class="author">Benjamin Kober</span><br>
<span id="email" class="email"><a href="mailto:benko@kober-systems.com">benko@kober-systems.com</a></span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_programmübersicht">Programmübersicht</a>
<ul class="sectlevel2">
<li><a href="#_motivation">Motivation</a></li>
<li><a href="#_architektur">Architektur</a></li>
</ul>
</li>
<li><a href="#usage">Benutzung</a>
<ul class="sectlevel2">
<li><a href="#_generelle_herangehensweise">Generelle Herangehensweise</a></li>
<li><a href="#_quellcode_generieren">Quellcode generieren</a>
<ul class="sectlevel3">
<li><a href="#usage_extract">Extrahieren</a></li>
<li><a href="#usage_import_snippets">Zusammenfügen</a>
<ul class="sectlevel4">
<li><a href="#_parameterierte_snippets">Parameterierte Snippets</a></li>
</ul>
</li>
<li><a href="#transform">Transformieren</a>
<ul class="sectlevel4">
<li><a href="#usage_save">save (Speichern)</a></li>
<li><a href="#usage_eval">eval (Ausführen)</a></li>
<li><a href="#usage_pipe">pipe</a></li>
<li><a href="#usage_control_flow">Den Ausführungsfluss steuern</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#usage_create_userguides">Benutzerdokumentation erstellen</a>
<ul class="sectlevel3">
<li><a href="#_spezifikationen_unit_tests_schreiben">Spezifikationen (Unit Tests) schreiben</a></li>
</ul>
</li>
<li><a href="#literate-problems">Probleme mit dem literate programing Ansatz</a>
<ul class="sectlevel3">
<li><a href="#_bilder_diagramme_und_charts">Bilder, Diagramme und Charts</a></li>
<li><a href="#_autovervollständigung_und_syntax_highlighting">Autovervollständigung und Syntax Highlighting</a></li>
<li><a href="#_traces_zurückverfolgen">Traces zurückverfolgen</a></li>
<li><a href="#_alternative_lösungsansätze_und_veralteter_code">Alternative Lösungsansätze und veralteter Code</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_beispiele">Beispiele</a>
<ul class="sectlevel2">
<li><a href="#_eine_präsentation_als_literate_program">Eine Präsentation als literate program</a>
<ul class="sectlevel3">
<li><a href="#_vorraussetzungen">Vorraussetzungen</a></li>
</ul>
</li>
<li><a href="#_einen_issue_tracker_aus_todo_adoc_und_changes_adoc_dokumenten_erstellen">Einen Issue-Tracker aus TODO.adoc und Changes.adoc Dokumenten erstellen</a></li>
</ul>
</li>
<li><a href="#_implementierung">Implementierung</a>
<ul class="sectlevel2">
<li><a href="#_codeschnipsel_verarbeiten">Codeschnipsel verarbeiten</a>
<ul class="sectlevel3">
<li><a href="#_eine_datenbank_für_codeschnipsel_anlegen">Eine Datenbank für Codeschnipsel anlegen</a></li>
<li><a href="#_den_ast_filtern_und_die_datenbank_füllen">Den AST filtern und die Datenbank füllen</a>
<ul class="sectlevel4">
<li><a href="#_nur_codeschipsel_verarbeiten_die_auch_von_lisi_verwendet_werden">Nur Codeschipsel verarbeiten, die auch von Lisi verwendet werden</a></li>
<li><a href="#_dem_snippet_alle_wichtigen_attribute_übergeben">Dem Snippet alle wichtigen Attribute übergeben</a></li>
<li><a href="#_snippets_in_der_datenbank_speichern">Snippets in der Datenbank speichern</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_referenzen_in_einem_snippet_finden">Referenzen in einem Snippet finden</a></li>
<li><a href="#_snippets_zusammenfügen">Snippets zusammenfügen</a></li>
<li><a href="#snippet_topo_sort">Die Verarbeitungsreihenfolge der Snippets festlegen</a></li>
<li><a href="#_ausgaben_erzeugen">Ausgaben erzeugen</a>
<ul class="sectlevel3">
<li><a href="#_save_snippet_in_eine_datei_speichern">Save: Snippet in eine Datei speichern</a></li>
<li><a href="#_eval_ein_snippet_ausführen">Eval: Ein Snippet ausführen</a></li>
<li><a href="#_pipe_snippets_dynamisch_erzeugen">Pipe: Snippets dynamisch erzeugen</a></li>
<li><a href="#_umgang_mit_fehlern_beim_raussuchen_der_schnipsel">Umgang mit Fehlern beim Raussuchen der Schnipsel</a></li>
</ul>
</li>
<li><a href="#side-effects">Seiteneffekte (Zugriff auf die Betriebsystem-Umgebung)</a></li>
<li><a href="#_fehlerbehandlung">Fehlerbehandlung</a></li>
<li><a href="#unit-tests">Tests</a></li>
</ul>
</li>
<li><a href="#_installation">Installation</a></li>
<li><a href="#_build">Build</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Ein literate programming Werkzeug.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_programmübersicht">Programmübersicht</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_motivation">Motivation</h3>
<div class="paragraph">
<p>Programme sind festgehaltene Ideen. Die zugrunde liegenden Konzepte sind nicht
an irgendeine Syntax sodern an Gedanken und Modelle gekoppelt. Dieses Programm
soll dem Entwickler helfen sich wieder auf diese Konzepte konzentrieren zu
können statt von einer vorgegebenen Struktur behindert zu werden.</p>
</div>
<div class="paragraph">
<p>Das bringt verschiedene Vorteile mit sich:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Die Konzepte stehen stärker im Vordergrund und grundlegende Architekturfehler
fallen viel schneller auf.</p>
</li>
<li>
<p>Programme werden für andere (und auch für den Autor selbst) erfassbarer und
die Dokumentation deutlich besser.</p>
</li>
<li>
<p>Programme werden spannender.</p>
</li>
<li>
<p>Es regt zu mehr Kreativität an.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Gleichzeitig gibt es auch eine ganze Menge Probleme mit
diesem Programmierkonzept. Diese behandle ich in einem
<a href="#literate-problems">späteren Abschnitt</a> und versuche Lösungsansätze
dafür zu finden.</p>
</div>
</div>
<div class="sect2">
<h3 id="_architektur">Architektur</h3>
<div class="paragraph">
<p>Dieses Programm existiert nicht unabhängig von seinem Kontext. Es ist
dazu gedacht asciidoc Texte in Programmcode und in Programmdokumentation
umzuwandeln. Letzteres ist nicht schwer, denn das ist ja ohnehin die
Hauptaufgabe von asciidoc. Mit <a href="http://asciidoctor.org/">Asciidoctor</a>
besteht bereits ein hervoragendes Programm zu diesem Zweck. Da ich
aber <a href="https://www.rust-lang.org/">rust</a> besser kennenlernen will und
mit <a href="../asciidoctrine/asciidoctrine.html">asciidoctrine</a> einen
eigenen asciidoc Interpreter in rust geschrieben habe, habe ich mich
entschlossen <code>lisi</code> als asciidoctrine-extension zu implementieren.</p>
</div>
<div id="crate_usages" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-k">use</span><span class="tok-w"> </span><span class="tok-n">asciidoctrine</span>::<span class="tok-o">*</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div id="cargo_dependencies" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="toml"><span></span><span class="tok-n">asciidoctrine</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-n">path</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;../asciidoctrine&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">version</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;0.1&quot;</span><span class="tok-w"> </span><span class="tok-p">}</span></code></pre>
</div>
</div>
<div id="lisi-overview" class="imageblock">
<div class="content">
<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAhIAAADgCAIAAADZmhjTAAAkDklEQVR4Xu3df1BVZf4H8ANumhAhKm6ijBvqZk2FleZkRWU/bDZx3dx1h7YdV2fM2mGnaVy3tdlsZzdXs9qhJovaGlT8AYKCCiryyxBBBAVFVFCQH6IIhvwW5Nf3E8+35x6fC4f7nMO5Fy/v1x/Oc5/znHs+9znP83zOvVzPVboBAABspogVAAAAfUPaAAAACZa00QUAANAHpA0AAJCAtAEAABKQNgAAQALSBgAASEDaAAAACUgbAAAgAWkDAAAkIG0AAIAEpA0AAJCAtAEAABKQNgAAQALSBgAASEDaAAAACUgbAAAgAWkDAAAkIG0AAIAEpA0AAJCAtAEAABKQNgAAQALSBgAASEDaAAAACUgbAAAgAWkDAAAkIG0AAIAEpA0AAJCAtAEAABKQNgAAQALSBgAASEDaAAAACUgbAAAgAWkDAAAkIG0AAIAEpA0AAJCAtAEAABKQNgAAQALSBgAASEDaAAAACUgbAAAgAWkDAAAkIG0AAIAEpA0AAJCAtAEAABKQNgAAQALSBgAASEDaAAAACUgbdpKXlxcUFOTj46MMVhQbRUhxiqE7SGtrq5eXlxilUxs/frzYC2bCmAR9kDbsYd++fbQCrl+/vqSkhPfzYEOxUYQU586dO5ubm2nVbm9v7+zsFF+MveTm5j744INilM4rJyfn/vvvr6ura2xsbGlpaWtr6+joEDtl4GBMgm78BCFtmKW2tnbcuHGJiYm8hwczinPs2LGFhYUUdlNTEy1ejpqlmzZtoitNMT7nFRoaGhgYWF5eXlVVxTr/5s2bYqcMEIxJMIKfGqQNs2zYsGHhwoW8ewe/efPmffDBB7R+1dTU0JWveYuXtpUrV65du1YMznm98cYbwcHBBQUFdIl95cqV69ev08W12CkDBGMSjODnBWnDLHQJGRERwbt38AsLC3v66adp/SotLaVZ2tzcbOqnJX2ZO3duXFycGJzzmjVr1po1a44ePXr69GnW8zdu3BA7ZYBgTIIR/LwgbZjFz8+vqKiId+/gR5Nz/PjxmZmZVKioqKirq3PIxZ2Pjw9dXYrBOSl6vV5eXl9//XVSUlJ2dnZhYWFVVVVLS4vYKQMEYxKM4OcFacMsHh4e9Laad+/gV19fP3LkyAMHDhw7duz8+fPV1dXmXfb2hQ5Ky6gYmfOifnZzc6Nr6tjY2LS0tPz8/MrKSvPSBsYkGMHPC9KGWVxdXbtUHT34UbQuLi7q9au5uVl8VSZLTk4OCAgQI3Ne4eHhU6ZM2bx5c1xc3JEjR86ePUvvNtra2sR+GSAYk2AEPy9IG2ZRFEvf3i4o5ujoaFq7c3NzS0tLGxoaxFdlspCQkODgYDEs5/XOO+88++yzW7du3b9//9GjR4uKimpqatrb28V+GSAYk2CE5aTwktgEjLlNp2hkZGRiYmJOTk5JScn169fFV2WypUuXfv3112JYzuull156/fXXIyIiDh48mJ2dXVxcXFtba97XTDEmwQjLSeElsQkYc5tOUVrCEhISaAm7cOECLWHiqzLZzJkzMzMzxbCcl5+f36pVq6Kiouhq+sSJE3Q1XV9fL3bKwMGYBCMsJ4WXxCZgzG06Rbdv305T9NixYzRFf/jhB/FVmamjo8Pd3f32+putETdu3Bg+fPiXX34ZExNz6NChU6dOVVRUmPrZPcYkGGE5KbwkNgFjMEVlnTt3bvLkyWJMzis9Pd3b23vjxo179uw5fPhwQUHB5cuXTf2mEMYkGGE5KbwkNgFjbt8pyr/vaOcpumPHjgULFogxOa9PP/3U398/PDw8Pj4+IyODsubVq1dN/X8JGJNghOWk8JLYBIzBFJW1uocYk/NavHjxK6+8sm3bNurwrKws6vBr166Z+r+gMSbBCMtJ4SWxCRiDKSqL3mpERUWJMTmvWbNmLV++XPiakHlfo+rCmARjLCeFl8QmYAymqKzJkycXFhaKMTkvb2/vDz/8cOfOnSkpKXl5eWVlZY2NjWKnDCiMSTDCclJ4SWwCxmCKSmloaHB3d6drbTEmJ3XlypXhw4d/9913sbGx33//fX5+/qVLl8y7rQiDMQlGWE4KL4lNwBhMUSkZGRkzZ84UA3Jeu3btmjRp0qZNm/bu3Zuenn7mzBlKJObdMp3BmAQjLCeFl8QmYAymqJTQ0NClS5eKATmv9957b/bs2Vu2bNm3b19mZmZhYWF1dbV5txVhMCbBCMtJ4SWxCRiDKSolODg4JCREDMh5zZ8/f9GiRcL/fzb1a1RdGJNgjOWk8JLYBKwEBQXZfm+DIT5FpfqKBAQEpKSkiAE5r2nTpq1YsSIqKiopKenEiRMXL17Ud1sRqX7GmLS9r8Ca5aTwktgErNAI9vX1TU5OFjf0ZohPUam+6ur5taKamhoxIF2UHtZlDTY2Gyj0rsLNze2zzz7btWtXamrqyZMny8vLm5qaxE6xgVQ/2/M1DhQHjkkQWE4KL4lNwApbXFxdXek6sd+bQGCK2t5XZWVlPj4+YjR6sUNblzXY2Gyg5Obmenp6bty4cffu3YcPHz59+rTu24pI9bM9X+NAURw0JsGa5aTwktgErLBhxzz88MN0kSi2UDEyRek6lB3l888/V9dfvXqV3mh7e3vfcccdY8aMeeyxx1i9OjA19b62UAZ6ijL99tXevXvnzp0rRqOXvtduT6GhoQ888EB4eHhcXFxGRsbZs2fpzOr7dSapfjbSLUNtTII1y0nhJbEJWFEPOzJixIhPPvmkr//Wq8jPEIb2ve+++4b1mDZtWpfqbP3mN7+hp6VL1Obm5iNHjrz88suq/X7EAhMqbaeYM0WV/vpq7dq1K1euFKPRix3Runzp0qXFixdPnDiRgrn33ntfe+21tLQ062Z28Oabb7744ovbtm3bv39/VlZWUVGR7tuKsMg57X7W/Rq7ht6YBGuWk8JLYhOwIgw7Zs6cOWVlZWJTA1P04MGDtO/ChQtfffVVKiQmJvJNnp6eVFNZWalqfgsWklhrM8W0Kcr01Vd0ubp582YxGr3YsazLzzzzDJVjYmJaWlro1YWFhfH/KaJuZgcBAQFLliyJjIykc52Tk1NcXKz7tiIsckFf/azofY1DcEyCNctJ4SWxCVgRR9xPRo0atXXrVuvGvG+lzJ8/n/Y9dOhQamoqFX7961/zTb/4xS+oZsyYMXTV/O2331ZVVan2+xGLR6i0nWLyFFX66KsHH3wwLy9PjEYvdiDrsru7O5XpHUaXagIw6mZ2MGHChNWrV0dHR6ekpOTm5tKypfu3Tlnk1nrtZ0XvaxyCYxKsWU4KL4lNhoapU6eKg0her8NO0TVVSktLhw0b9tBDD7GHVKCHtKywh7TkPfroo/y49C57y5Ytlp0HYoqazbqvWltb3dzc2traxGj0YgeyLj/11FPsIR1u+vTpb7/9Nr9GVjczG72xcHFxYUc0j3U/d2FM9qHXvgJrlpPCS2ITsCIOtx59vclVdE2Vd999l3bkv6dNBXr497//Xd2moqLiq6++Gj16NG2aOHGiehMLSV0jRTH5yq7XvqLLbXq3IYZiADuWdbm8vHzJkiW+vr48Hkok1s3MRt3r4+OzadOmPXv2pKenFxQUGLmtCH8tar32M2ssRmODITgmoVeWk8JLYhNHYCdStsZu2KE57T+pKfJThdaOsWPHCkchVEmbhMbnzp1Tei6U1JWsvbpGimLaFNXoK1pAg4KCxFAMYEe0LnP19fX0Mqne3d2d1fTazCQffvjhzJkz6ZI8Pj4+MzOTzmN1dbXuX2dikXMa/dyFMXkr7b6yBXse2Zrbl+Wk8JLYxBGsu9iWGrthh2b6/QKfIj9VNm7cSHu9+OKL6srnn3+eKmlt7e75hYbw8PCSkhKasdHR0VS/aNEidWMWm7pGimLOFNXuq5UrV65du1YMxQB1J6jLTzzxRGRk5MWLF9va2vbt20f1L7zwgnUzs9EpW7BggdDP+r5G1SXTz10Ykyr99pUt2FPJ1ty+LCeFl8QmjmDdxbbU2A07tI3/XUiRnyp0Ear0TBJ15bZt26iSfecnMDDQz8/vrrvuuuOOO3x9fd96663a2lp1YxahukYKO/oATlFb+mru3LlxcXFiKAaoO0Fdpkt7elszadIkusyk3lu6dCn/+626mdn8/f3/8pe/7NixIykp6fjx45TG6urqdF/z2t7PXRiTMn1lC/aEsjW3L8tJ4SWxCVhRZG5OoBiYKo6iDOgUtbGvfHx8ysvLxVCcFKUHT0/P9evX79y5MzU1NS8vj167kV9nsr2fuzAmZfoKrFlOCi+JTcCK1K3QhvgUtbGvqqurvby8xDicF/Wqm5tbWFhYbGxsWlpafn5+ZWWlkV9nsrGfGYxJ2/sKrFlOCi+JTcCYIT5FbUSXfgEBAWIczis8PHzKlCmbN2+Oi4s7cuTI2bNnq6qq9N1WRAeMSTDCclJ4SWwCxmCK2iIkJCQ4OFiMw3m98847zz777NatW/fv33/06NGioqKamhqzf52Jw5gEIywnhZfEJmAMpqgtli5dyv9DwFDw0ksvvf766xEREQcPHszOzi4uLq6trdX993BZGJNghOWk8JLYBIzBFLXFzJkzMzMzxTicl5+f36pVq6KiopKTk0+cOFFaWqrv15n0wZgEIywnhZfEJmAMpmi/Ojo63N3dGxsbxTic1I0bN4YPH/7ll1/GxMQcOnTo1KlTFRUVzc3NYr+YBmMSjLCcFF4Sm4AxmKL9Onfu3OTJk8UgnFd6erq3t/fGjRv37Nlz+PDhgoIC3b/OpA/GJBhhOSm8JDYBYzBF+7Vjx44FCxaIQTivTz/91N/fPzw8PD4+PiMjg7Lm1atXdd9WRAeMSTDCclJ4SWwCxmCK9mt1DzEI57V48eJXXnll27Zt1MNZWVnUw7p/nUkfjEkwwnJSeElsAsZgivaL3mpERUWJQTivWbNmLV++PDIyMjExMScnp6SkRPevM+mDMQlGWE4KL4lNwBhM0X5Nnjy5sLBQDMJ5eXt7f/jhhzt37kxJScnLyysrKzNyWxEdMCbBCMtJ4SWxCRiDKaqtoaHB3d2drrXFIJzUlStXhg8f/t1338XGxn7//ff5+fmXLl0yclsRHTAmwQjLSeElsQkYgymqLSMjg/+U91Cwa9euSZMmbdq0ae/evenp6WfOnDHy60z6YEyCEZaTwktiEzAGU1RbaGjo0qVLxQic13vvvTd79uwtW7bs27cvMzOzsLCwurrabrcVYTAmwQjLSeElsQkYgymqLTg4OCQkRIzAec2fP3/RokUREREJCQnZ2dkXLlyora2159eoujAmwRjLSeElsQkY4+rq2qXq6MGPljAXFxe7TdGAgICUlBQxCOc1bdq0FStWREVFJSUlnThx4uLFi/a8rQiDMQlG8POCtGEWDw+P2+u2GTU1NXfeeSdNUbocpilKl8OmTlEvLy86ohiEk6Llz83N7bPPPtu1a1dqaurJkyfLy8ubmprETjEZxiQYwc8L0oZZ/Pz8ioqKePcOfhkZGWPHjrXPFC0rK/Px8REjcF65ubmenp4bN27cvXv34cOHT58+befbijAYk2AEPy9IG2YJDAyMiIjg3Tv4rVu37qGHHhI+fBdf1QDZu3fv3LlzxQicV2ho6AMPPBAeHh4XF0dL4dmzZ69evWq3X2fiMCbBCH5ekDbM8sUXXyxcuJB37yBHAT/++ONBQUHC/2EWX9UAWbt27cqVK8UgnNebb7754osvbtu2bf/+/VlZWXTJb+fbijAYk2AEPzVIG2ahyyJvb28a7ryHB7MNGzZ4eHiEhIRER0cnJyfn5uaWlpY2NDSIr2qA0FqwefNmMQjnFRAQsGTJElr+Dh48SMtfcXGxnW8rwmBMghH81CBtmCgmJmbUqFFr1qw5f/487+dB5ebNm3Txu2zZMjc3t+Dg4LCwsNjY2LS0tPz8/MrKSvN+CuLBBx/My8sTo3FeEyZMWL16NS1/KSkptPyVlZU5avnDmATd+DlC2jDRjRs3Dh06NG/ePLrEUwYrT0/PGTNmvP/++99++636m47V1dXm/c12/PjxYhxOjVbAb775hpbs77///tSpU5cuXXLU8ocxCbohbdgDXTfV1dVVVFQUFBRkZmbS6N+1a9eOHTsiIiK2DyYUD0VFsVGEFCdFSzFT5Kb+FERLS0tVVVVhYWF2dnZSUtLOnTvFsMyn9PxXMvugnEFvNXJycmj5u3r1qp1vK8JhTIJuSBv20NHRQReVNTU1paWlNO7prXdqampiYmJCjwODAwuGoqLYKEKKk6KlmClyU/9mS5eNrGdOnz599OjR5ORkMTLzUdoQq0xD1/iUM86ePUvL3/Xr1x21/GFMgm5IG3ZCq0NjYyON+PLycrqyPnny5PHjx+n6+thgQvFQVBQbRUhxUrQUs9nrGl1u0+p55cqVkpISWhdoSRXDMh+lDbHKNHl5eerudeDyhzEJ+iBt2ElnZ2dbW1tTU1NtbW1VVRVNAFolL/Q4PziwYCgqio0ipDgpWorZ7O/50BKg7pbi4mIxMvNR2hCrTEPXy5cvX7527VpDQwOlTLO7VwPGJOiDtGE/NNbb29tppaC32HTFVFdXR9Pgh8GE4qGoKDaKkOKkaO0wP+lymxaClpYW1idiTHZBaUOsMo3Qw2J32BfGJOiAtAHw4x1hxSoA6APSBgDSBoAEpA0ApA0ACUgbAEgbABKQNgCQNgAkIG0AIG0ASEDaAEDaAJCAtAGAtAEgAWkDAGkDQALSBgDSBoAEpA0ApA0ACUgbAEgbABKQNgCQNgAkIG0AIG0ASEDaAEDaAJCAtAGAtAEgAWkDAGkDQALSBgDSBoAEpA0ApA0ACUgbAEgbABKQNgCQNgAkIG0AIG0ASEDaAHBw2sjLywsKCvLx8VEA+kYjhMYJjRYaM1OnThU3a1LvaxzSBoAj08a+ffu8vLzWr19fUlLC5yCANRohNE5otOzcubO5ubm1tbW9vb2zs1McUr0pLi7+6KOPaN/4+HhxmzweEtIGDF2OShu1tbXjxo1LTEzksw9AG42WsWPHFhYW0uBpampqa2uzMXOQgwcP0nijHcUNkngwSBswdDkqbWzYsGHhwoV86gHYYt68eR988EF5eXlNTU1jY+PNmzfFgdU3Gm9ffPGFWCuJR4K0AUOXo9JGYGBgREQEn3oAtggLC3v66acLCgpKS0spczQ3N3d0dIhjqw/bt2+nUSfWSuKRIG3A0OWotOHn51dUVMSnHoAtKGGMHz8+MzOTChUVFXV1dba/4SgsLKRRJ9ZK4pEgbcDQ5ai04eHh0djYyKcegC3q6+tHjhx54MCBY8eOnT9/vrq6+saNG+LY6kNDQwONOrFWEo8EaQOGLkelDVdX1y7VJASwBY0ZFxeX2NjYtLS0/Pz8ysrK5uZmcWz1obOzk406I3gkSBswdDkqbdBx+bwDsB2NnOjo6OTk5Nzc3NLSUnoPIY6tvhkf7ZYweElsAuDsjE8kfZA2QB8aOZGRkYmJiTk5OSUlJdevXxfHVt+Mj3ZLGLwkNgFwdsYnkj5IG6APjZyIiIiEhITs7OwLFy5I/VcM46PdEgYviU0AnJ3xiaQP0gboQyNn+/btlDaOHTtGaeOHH34Qx1bfjI92Sxi8JDYBcHbGJ5I+SBugD9IGgIMZn0j6IG2APixt8O/gIm0A2JvxiaQP0gbog7QB4GDGJ5I+SBugD9IGgIMZn0j6IG2APkgbAA5mfCLpg7QB+iBtADiY8YmkD9IG6IO0AeBgxieSPkgboA/SBoCDGZ9I+iBtgD5IGwAOZnwicUFBQbbf6QFpA/RB2gBwMOMTiaOn8vX1TU5OFjf0Rl/aoLQ0fPhw2nfEiBFUFjfbndJDrNVL6tmkGnfLtx+0FKQNAMcyPpE4tjC5urquWLGi3x/P0beEffXVV7QjyxyhoaHiZrsb2LVY6tmkGnfLtx+0FKQNAMcyPpE4tjAxDz/88MmTJ8UWKvqWsCeeeIJ2/Pzzz+nf2bNni5vtjr1YsVYvqWeTauxMFKQNAMcyPpE4tpBxI0aM+OSTTzo7O8V2PRT5Je/ChQu01/3330/ladOmUZlq+FZ2UEvrW2suXbq0ePHiiRMnUlT33nvva6+9lpaWxltu2bJl8uTJbm5ujz766KZNm4Sn2rZtG6uhfX/5y1/+4x//aGtrY5tYPe1CO9Lu9CTh4eF8R3L48OEXXnjBw8Pj7rvvpjwXHx+v3rp582Yjx+X4LhqHk20ZHR0dEBDg5eU1evTowMDAkpIS3sCxFKQNAMcyPpG4/1/DbjVnzpyysjKxqa60sXr1atpr3bp1VF67di2VP/jgA76VHrq4uPCHrIYf5ZlnnqFyTExMS0sLrTVhYWEzZ85km1JSUmgTvY8p7TFr1iz1juTdd9/dv39/U1NTfX39xx9/TJtWrVrFNrGWbN/y8vInn3ySHtITsq2pqak/+9nPaPFlPwvxxz/+UenJMWxrYmIiPaRdynqwfW08brdVGuju73Dq9ra09Pf3z83NbWho+Pe//00PqQPZVodTkDYAHMv4ROLYcmNt1KhRW7dutW7M552N/Pz8hg0bVllZ2d3z7sHV1ZUu1flWekLaaml960Lp7u5OZXqH0aWa+cxzzz1Hm9LT09lDaqPeUdDe3k6bKBL2kLU8cuQIe0gFekhPyB7SukwPT506xR5evXqVHtL7Bvbw2WefpYcZGRnqfW08bndvaUP7cOr2trQ8evQoe9jY2Kj0vONhDx1OQdoAcKwxY8awZcI8A5I2Dh8+TLu8/PLLvGbu3LmKarlXNNPGU089xR66ublNnz797bffZumHjB49muppcWQP6fpavWN1dfWf/vSniRMn0uU5q1d6/uzPtrKHwr7UpewhHYvvwvEgjRy3u7e0oX049tD2lvwDMXayFMnzZR4FaQPAafy0/txioD6keuONN8Sn7rF8+XLWQLl1VaVVjzVgD8vLy5csWeLr68t3pETCNmkv3yw5rVq1qqamhh62traqt7Iy35ddmAtpgxIAeygQjsv2tfG43X2njb4Op25ve8u+ahxIQdoAcBpsceEG8E/itGjSWxZ3d/fm5mZe2dTURDVeXl60lR6yb+XyBllZWSwM3p6pr6+nRYfqaV9Wwz6k4p/JCB9SeXh4KKrF/dChQ+qtrNzXh1TsY6jo6Gj2UMD+3NLXh1TaxyUuLi7qh939HU69u+0t+6pxIAVpA8BpsMWFGdgv4EZFRVH71157TagPCgpSflr+2Of1//nPf2ippUM/8sgjLBLW8oknnoiMjLx48SK9C9m3bx/Vv/DCC2wT+5M4LeL0jsT6T+LPP/88lf/73/9SQqJUNHXqVPVWVmZ/1uZ/Ek9KSmJb09PTKZnde++9lJNo97Nnz37zzTczZsxgWxMSEvi+1n8S1z4u8fHxoYdnzpzhNdqHU+9ue8u+ahxIQdoAcBpscTHjv/vNnz+f2u/du1eo37NnD9XTViqXlJQEBgaOHj3a09Nz9uzZLNPwo2RmZlKOmTRpEr0H8vX1Xbp0aVVVFX8e9gXckSNH+vv70wKqqD7ov3z58qJFi+hpacfp06dv3bpV/bSsvHHjRtqRdqeFmH8ficnOzl6wYMGYMWNomZ4yZcrixYtpseNbw8LC/Pz82HHpSdTPrH1ctu/Pf/5zoVLjcLpb9lrjQArSBoDTUMy/uYgd5OfnU2z33XefuAEGB6QNAOdx+97K8Fe/+tWRI0eamprOnTvHPvcX3jTA4IG0ATBEDaq0ER8fP3v2bDc3t7vvvvuZZ56JiYkRW8CggbQBMETpSBvr1q2jvZ5//nl15e7duwMCAry9vYcNG3bXXXf5+vrOmjVL3cD5KD3E2gEi9eRz5syhxuvXrxc3mAlpA2CIsn1tYtrb2ydMmEB7ZWZm8srQ0FCq+de//nXt2rWmpqaTJ0+GhIT4+/ur9nNCUiu7LKknz8jIoMZ0XujsiNtMg7QBMETZvjYxtEzQLo888oi6csqUKVRZX1+vrnR6Uiu7LNknnz59OrVPSEgQN5gGaQNgiJJam8if//xn2uWjjz5SV7L/7RwYGEiLSF+/2kQr2lNPPUUtR44c+eSTT6oXOOslUl3Dyq2trW+//ba3tzf/L+j5+fm///3v77nnnhEjRjz22GOxsbF8d43bynZr7qgRZHd/N8rVPqg1jfbsmTlerxE5nRFqSWeH15hNQdoAGJrUq5ItaLVSbv2EiqxZs0a9zE2YMOEPf/hDamoqb0DrLy337A61ZWVlVKCHfFFWNG+ay8qffPJJbm5uR0cHq6SlilZ2X1/fpKSkxsbGEydO8P+EqH1bWY0dtYPUvlGu9kGt9dte/eSMRuTdP31ORWdHtYe5FKQNgKFJWJv6NWrUKNqF3aBJjZaP5557btiwYWy9U3oywf/+9z+2lS2y/OYf6enpiupuVIrm3Q9ZOScnR92A/edt9eU2p31bWY0dtYPUvlGu9kGt9dte/eSMRuTdPbdcpK1eXl7iBtMoSBsAQ5OwNvWLJYabN2+KG3q0tLTQerp69eq77rqLmvEbqtNlsmJ1m0KqZA8VG9KGcET2sVivH4hp31ZWY0ftILXvtKh9UGv9tmc1qj20IifUP7SV3sGIG0yjIG0ADE3C2tSvvt5tCOLi4hTVj0MIKzK7yyytg+yhonnTXHWZY2vo9evXhXq+qa/bymrsqB2k9o1ytQ9qrd/21q9aI/JuvNvoRtoAsBdhbeoX+8aO8LcNa2xVnTp1KnsofP7DPuHhn/9o3zRXXebY/1TYvXu3UN/d321lNXbUDlL7RrnaB1W3ZLTbd/d2Y12NyLvxt41upA0AexHWpn4tW7ZMsfom1X333fe3v/0tOTm5pKSktbWV3ov885//pGZff/01a8D+2qy+Q636r83aN81Vl7mjR4/eeeedkyZNSklJaWpqysvL++1vf8s2ad9WVmNH7SC1b5SrfVDrl6Ddvru3G+tqRN790zep3nrrLV5jNgVpA2Bosl6RtcXHx9Mu9J5DXfnqq6/6+/t7e3uPHDmSllovL6/nnnsuKipK3YZ9t3Vkj9mzZ9Nywzdp3zTXes1lKMH87ne/Gzdu3IgRIx599FH134o1biurvaNGkN2aN8rt7vuglZWV1IzSgOWJNNszvd5YVyNy9i5QCNhUCtIGwNDU64qs4ebNm+PHj1dUH9eAto8//pi6669//au4YeDgf4n/SGwCAOaQTRvdP92Tas6cOeIG6M3DDz9M3UVvFMQNA4f92UP45NBsSBsAQ5Srq2uXahIC2KKjo8PFxUVf2ujs7GSjzggeCdIGgL15eHjwL5UC2KimpubOO++ktJGQkEBp48KFC7anjYaGBhp1Yq0kHgnSBoC9+fn5FRUV8akHYIuMjIyxY8fqSxuFhYU06sRaSTwSpA0AewsMDIyIiOBTD8AW69ate+ihh2jkUNrIzs5md9YSx1YfKNnQqBNrJfFIkDYA7O2LL75YuHAhn3oA/aJh8/jjjwcFBUVGRiYmJubk5JSUlFy/fl0cW32g8UajTqyVxINB2gCwN7pI9Pb2psnPZx+Atg0bNnh4eISEhERHRycnJ+fm5paWljY0NIhjqzcHDx4cN26c7W9N+sKDQdoAcICYmJhRo0atWbPm/PnzfA4CCG7evJmVlbVs2TI3N7fg4OCwsLDY2Ni0tLT8/PzKysrm5mZxYN2quLj4o48+8vLyio+PF7fJ41EhbQA4wI0bNw4dOjRv3jx626EA9M3T03PGjBnvv//+t99+e88994ibNfn4+AQFBeXl5YnjTxekDQBHoqvIurq6ioqKgoKCzMzMAwcO7Nq1a8eOHREREdsBbkWjgsYGjRAaJzRaaMzQyKHxQ6NIHFhmQtoAcKSOjo7m5uaamprS0lJaBbKyslJTUxMTExN6HAD4CRsSNDZohNA4odFCY4ZGDo0fGkXiwDIT0gaAg9GlYmNjI83/8vLywsLCkydPHj9+PDs7+xjArWhU0NigEULjhEYLjRkaOXZ+q9GFtAHgcJ2dnW1tbU1NTbW1tVVVVbQclJSUXOhxHuAnbEjQ2KARQuOERguNGRo5NH7EIWUypA0Ax6OZ397e3tra2tzcTNePdXV1tCj8AHArGhU0NmiE0Dih0UJjxv45owtpAwAApCBtAACABKQNAACQgLQBAAASkDYAAEAC0gYAAEhA2gAAAAlIGwAAIAFpAwAAJCBtAACABKQNAACQgLQBAAASkDYAAEAC0gYAAEhA2gAAAAlIGwAAIAFpAwAAJCBtAACABKQNAACQgLQBAAASkDYAAEAC0gYAAEhA2gAAAAlIGwAAIAFpAwAAJCBtAACAhF7SBgAAQL+QNgAAQALSBgAASPg/FpudXZHyZHMAAAAASUVORK5CYII=" alt="Diagram" width="530" height="224">
</div>
<div class="title">Figure 1. Aufbau von lisi</div>
</div>
<div class="paragraph">
<p><code>lisi</code> arbeitet direkt auf einem asciidoc
<a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">AST</a> und erzeugt aus
den darin enthaltenen Quelltext-Snippets (TODO link) Sourcecode Dateien
(und manchmal auch weitere Dateien). Im AST fügt es einige zusätzliche
Informationen hinzu (vor allem Referenzen, wo Code-Snippets verwendet
werden TODO interner link).</p>
</div>
<div class="paragraph">
<p>Die Hauptdatei hat dabei folgendes Gerüst:</p>
</div>
<div class="listingblock">
<div class="title">src/lib.rs</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><div class="lineno"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span></pre></div></td><td class="code"><div><pre><span></span><span class="tok-o">&lt;&lt;</span><span class="tok-n">required_crates</span><span class="tok-o">&gt;&gt;</span>

<span class="tok-o">&lt;&lt;</span><span class="tok-n">internal_modules</span><span class="tok-o">&gt;&gt;</span>

<span class="tok-o">&lt;&lt;</span><span class="tok-n">crate_usages</span><span class="tok-o">&gt;&gt;</span>

<span class="tok-o">&lt;&lt;</span><span class="tok-n">internal_structs</span><span class="tok-o">|</span><span class="tok-n">join</span><span class="tok-o">=</span><span class="tok-s">&quot;</span><span class="tok-se">\n\n</span><span class="tok-s">&quot;</span><span class="tok-o">&gt;&gt;</span>

<span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">struct</span> <span class="tok-nc">Lisi</span><span class="tok-o">&lt;&#39;</span><span class="tok-na">a</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-o">&lt;&lt;</span><span class="tok-n">lisi_internal_variables</span><span class="tok-o">&gt;&gt;</span>
<span class="tok-p">}</span>

<span class="tok-k">impl</span><span class="tok-o">&lt;&#39;</span><span class="tok-na">a</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-n">Lisi</span><span class="tok-o">&lt;&#39;</span><span class="tok-na">a</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-o">&lt;&lt;</span><span class="tok-n">internal_functions</span><span class="tok-o">|</span><span class="tok-n">join</span><span class="tok-o">=</span><span class="tok-s">&quot;</span><span class="tok-se">\n\n</span><span class="tok-s">&quot;</span><span class="tok-o">&gt;&gt;</span>

<span class="tok-w">  </span><span class="tok-sd">/// Gets all snippets from the ast</span>
<span class="tok-w">  </span><span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">fn</span> <span class="tok-nf">extract_ast</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-bp">self</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">input</span>: <span class="tok-kp">&amp;</span><span class="tok-nc">AST</span><span class="tok-p">)</span><span class="tok-w"> </span>-&gt; <span class="tok-nb">Result</span><span class="tok-o">&lt;</span><span class="tok-n">SnippetDB</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">Error</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-w">    </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">snippets</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">SnippetDB</span>::<span class="tok-n">new</span><span class="tok-p">();</span>

<span class="tok-w">    </span><span class="tok-c1">// extract snippets from all inner elements</span>
<span class="tok-w">    </span><span class="tok-n">input</span><span class="tok-p">.</span><span class="tok-n">elements</span><span class="tok-p">.</span><span class="tok-n">iter</span><span class="tok-p">().</span><span class="tok-n">try_fold</span><span class="tok-p">(</span><span class="tok-n">snippets</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-n">snippets</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">element</span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">      </span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-n">extract</span><span class="tok-p">(</span><span class="tok-n">snippets</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">element</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-p">})</span>
<span class="tok-w">  </span><span class="tok-p">}</span>

<span class="tok-w">  </span><span class="tok-sd">/// Build all snippets (Runs the vm)</span>
<span class="tok-w">  </span><span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">fn</span> <span class="tok-nf">generate_outputs</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-bp">self</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">snippets</span>: <span class="tok-nc">SnippetDB</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">ast</span>: <span class="tok-kp">&amp;</span><span class="tok-nc">AST</span><span class="tok-p">)</span><span class="tok-w"> </span>-&gt; <span class="tok-nb">Result</span><span class="tok-o">&lt;</span><span class="tok-p">(),</span><span class="tok-w"> </span><span class="tok-n">Error</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-w">    </span><span class="tok-o">&lt;&lt;</span><span class="tok-n">generate_outputs</span><span class="tok-o">&gt;&gt;</span>

<span class="tok-w">    </span><span class="tok-nb">Ok</span><span class="tok-p">(())</span>
<span class="tok-w">  </span><span class="tok-p">}</span>
<span class="tok-p">}</span>

<span class="tok-k">impl</span><span class="tok-w"> </span><span class="tok-n">Extension</span><span class="tok-w"> </span><span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-n">Lisi</span><span class="tok-o">&lt;&#39;</span><span class="tok-nb">_</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">  </span><span class="tok-k">fn</span> <span class="tok-nf">transform</span><span class="tok-o">&lt;&#39;</span><span class="tok-na">a</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-bp">self</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">input</span>: <span class="tok-nc">AST</span><span class="tok-o">&lt;&#39;</span><span class="tok-na">a</span><span class="tok-o">&gt;</span><span class="tok-p">)</span><span class="tok-w"> </span>-&gt; <span class="tok-nc">anyhow</span>::<span class="tok-nb">Result</span><span class="tok-o">&lt;</span><span class="tok-n">AST</span><span class="tok-o">&lt;&#39;</span><span class="tok-na">a</span><span class="tok-o">&gt;&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">    </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">snippets</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-n">extract_ast</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">input</span><span class="tok-p">)</span><span class="tok-o">?</span><span class="tok-p">;</span><span class="tok-w"> </span><i class="conum" data-value="3"></i><b>(3)</b>

<span class="tok-w">    </span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-n">calculate_snippet_ordering</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">snippets</span><span class="tok-p">);</span><span class="tok-w"> </span><i class="conum" data-value="5"></i><b>(5)</b>

<span class="tok-w">    </span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-n">generate_outputs</span><span class="tok-p">(</span><span class="tok-n">snippets</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">input</span><span class="tok-p">)</span><span class="tok-o">?</span><span class="tok-p">;</span><span class="tok-w"> </span><i class="conum" data-value="4"></i><b>(4)</b>

<span class="tok-w">    </span><span class="tok-nb">Ok</span><span class="tok-p">(</span><span class="tok-n">input</span><span class="tok-p">)</span>
<span class="tok-w">  </span><span class="tok-p">}</span>
<span class="tok-p">}</span>
</pre></div></td></tr></table></div></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Da <code>lisi</code> eine <a href="../asciidoctrine/asciidoctrine.html">asciidoctrine</a> Erweiterung ist, implementiert das Programm die
dafür erforderliche Schnittstelle.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Als erste Funktion aller Erweiterungen wird immer die Funktion <code>transform</code>
aufgerufen. Sie bekommt den von asciidoctrine vorverarbeiteten AST sowie
eventuell vorhandene Argumente übergeben. Sie übernimmt diesen und gibt
hinterher eine modifizierte Version des ASTs zurück (welche dann
weiterverarbeitet werden kann).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Die grundlegende Aufgabe zu Beginn der Transformation ist das Extrahieren
des Quellcodes aus der Datei.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Zum Schluss können alle Dateien generiert und Scripte ausgeführt werden.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Oftmals ist die <a href="#snippet_topo_sort">Reihenfolge der Abarbeitung
der Code-Schnipsel</a> entscheidend. Diese wird vor der Abarbeitung
festgelegt.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="usage">Benutzung</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_generelle_herangehensweise">Generelle Herangehensweise</h3>
<div class="paragraph">
<p>Beim schreiben eines literate Programmes sollte man wie bei einer
wissenschaftlichen Arbeit vorgehen:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Zunächst schreibt man eine Übersicht mit der Ausgangslage, der
Motivation und einer groben Zusammenfassung des eigenen
Lösungsansatzes.</p>
</li>
<li>
<p>Es ist gut sich frühzeitig Gedanken über verschiedene
Lösungsalternativen zu machen und diese gegeneinander abzuwägen (Das
kann man auf jeder Ebene des Programms tun. Sowohl bei der Architektur
als auch bei Details)</p>
<div class="ulist">
<ul>
<li>
<p>Diesen Alternativen kann man einen eigenen Abschnitt oder ein eigenes
Kapitel widmen. Sobald mit der Umsetzung des Programms begonnen wird
sollten sie recht weit nach hinten wandern, da sie für die meisten
Benutzer nicht relevant sind.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Dann sollte man mit der Bedienung beginnen. So hat man eine User
orientierte Herangehensweise (eine Art User Story) und kann von dort
aus leicht die Requirements und darauf aufbauend die Unit Tests
festhalten.</p>
<div class="ulist">
<ul>
<li>
<p>Sollte das Programm größer werden, ist es gut alle weniger
offensichtlichen Unittests (Corner Cases) nach hinten in ein eigenes
Kapitel zu verschieben und einen Link dorthin bereitzustellen.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Dann kommt das Kapitel mit der eigentlichen Implementierung.</p>
</li>
<li>
<p>Bei vielen Programmen wird es nützlich sein Beispiele (als eine Art
Tutorial) bereitzustellen.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Zu Beginn kann man mit einem einzigen Dokument starten aber im Laufe der
Zeit wird es bei größeren Projekten gut sein, sie in Kapitel (Module) zu
gliedern und diese in ein Hauptdokument einzubinden.</p>
</div>
<div class="paragraph">
<p>Die Reihenfolge des Schreibens kann sich überlagern (obwohl es gut
ist mit der Übersicht und den grundlegenden Fragen zu beginnen) aber
wahrscheinlich ist die Anordnung der Kapitel im endgültigen Dokument
immer ähnlich. Im Laufe der Entwicklung wird man immer mal wieder
aufräumen und umstrukturieren müssen (refaktoring).</p>
</div>
<div class="paragraph">
<p>Es ist wichtig eine Begründung für alle Designentscheidungen
aufzuschreiben damit man bei der späteren Pflege des Programmes
weiß, ob diese noch gültig oder obsolet sind. Das ermöglicht auch
bei der gemeinsamen Arbeit mit einem Team an einem Projekt, eine
Argumentationsgrundlage für Designentscheidungen/Änderungen zu haben.</p>
</div>
</div>
<div class="sect2">
<h3 id="_quellcode_generieren">Quellcode generieren</h3>
<div class="sect3">
<h4 id="usage_extract">Extrahieren</h4>
<div class="paragraph">
<p>Die normalen Quellcode Listings können gebraucht werden, um ein Programm
zu erstellen.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="asciidoc"><span></span>Fliestext ... <i class="conum" data-value="3"></i><b>(3)</b>

[[ID]] <i class="conum" data-value="2"></i><b>(2)</b>
[source, lua]
.Überschrift
----
Quelltext ... <i class="conum" data-value="1"></i><b>(1)</b>
----

Fliestext ... <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>lisi</code> kümmert sich nur um Quelltext-Snippets.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Die ID (<code>anchor</code>) kann benutzt werden, um Code-Snippets zu
referenzieren.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Der restliche Text wird von dem Programm ignoriert.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="usage_import_snippets">Zusammenfügen</h4>
<div class="paragraph">
<p>Die verschiedenen Codeschnipsel kann man in anderen Codeschnipseln
einbinden. Dafür verwendet man einfach eine <code>cross reference</code> auf den
<code>anchor</code> des jeweiligen Schnipsels:</p>
</div>
<div id="unittest_sample1_input" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="asciidoc"><div class="lineno"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></pre></div></td><td class="code"><div><pre><span></span>We need the testmodule for this project.

[[sample1_required_modules]] <i class="conum" data-value="1"></i><b>(1)</b>
[source, lua]
----
require &quot;testmodule&quot;
----

This is the importing file. We could print out the version.

[source, lua, save]
.sample1.lua
----
&lt;&lt;sample1_required_modules&gt;&gt; <i class="conum" data-value="2"></i><b>(2)</b>

print(testmodule.version)
----
</pre></div></td></tr></table></div></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Der Codeschnipsel bekommt eine ID (<code>anchor</code>)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Hier wird der obere Codeschnipsel über eine <code>cross reference</code> in diesen
eingebunden.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Das Ergebnis wäre eine Datei:</p>
</div>
<div id="unittest_sample1_output" class="listingblock">
<div class="title">sample1.lua</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="lua"><span></span><span class="tok-nb">require</span> <span class="tok-s2">&quot;testmodule&quot;</span>

<span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-n">testmodule</span><span class="tok-p">.</span><span class="tok-n">version</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Die Reihenfolge ist dabei egal.</p>
</div>
<div id="unittest_sample2_input" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="asciidoc"><div class="lineno"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span></pre></div></td><td class="code"><div><pre><span></span>First we give a short outline of the program. It imports the required modules
and then prints out its version.

[source, lua, save]
.sample2.lua
----
&lt;&lt;sample2_required_modules&gt;&gt;

print(testmodule.version)
----

We need the testmodule for this project.

[[sample2_required_modules]]
[source, lua]
----
require &quot;testmodule&quot;
----
</pre></div></td></tr></table></div></code></pre>
</div>
</div>
<div class="paragraph">
<p>In diesem Beispiel haben wir den Schnipsel <code>sample2_required_modules</code>
erst nach dem importierenden Schnipsel geschrieben. Die Ausgabe bleibt
aber die gleiche:</p>
</div>
<div id="unittest_sample2_output" class="listingblock">
<div class="title">sample2.lua</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="lua"><span></span><span class="tok-nb">require</span> <span class="tok-s2">&quot;testmodule&quot;</span>

<span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-n">testmodule</span><span class="tok-p">.</span><span class="tok-n">version</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Außerdem kann man einen Codeschnipsel beliebig oft in einem oder mehreren
anderen Codeschnipseln einfügen.</p>
</div>
<div id="unittest_sample3_input" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="asciidoc"><div class="lineno"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span></pre></div></td><td class="code"><div><pre><span></span>Lets assume we want to use the following snippet in multiple places.

[[sample3_multiple]]
[source, lua]
----
require &quot;testmodule&quot;
----

Than we could import it in the same snippet multiple times.

[source, lua, save]
.sample3-1.lua
----
&lt;&lt;sample3_multiple&gt;&gt;

print(testmodule.version)

&lt;&lt;sample3_multiple&gt;&gt;
----

And we could even use it again in another snippet.

[source, lua, save]
.sample3-2.lua
----
&lt;&lt;sample3_multiple&gt;&gt;

print(testmodule.version .. &quot;my other snippet&quot;)
----
</pre></div></td></tr></table></div></code></pre>
</div>
</div>
<div class="paragraph">
<p>In diesem Fall würden die folgenden beiden Dateien generiert.</p>
</div>
<div id="unittest_sample3_output1" class="listingblock">
<div class="title">sample3-1.lua</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="lua"><span></span><span class="tok-nb">require</span> <span class="tok-s2">&quot;testmodule&quot;</span>

<span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-n">testmodule</span><span class="tok-p">.</span><span class="tok-n">version</span><span class="tok-p">)</span>

<span class="tok-nb">require</span> <span class="tok-s2">&quot;testmodule&quot;</span></code></pre>
</div>
</div>
<div id="unittest_sample3_output2" class="listingblock">
<div class="title">sample3-2.lua</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="lua"><span></span><span class="tok-nb">require</span> <span class="tok-s2">&quot;testmodule&quot;</span>

<span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-n">testmodule</span><span class="tok-p">.</span><span class="tok-n">version</span> <span class="tok-o">..</span> <span class="tok-s2">&quot;my other snippet&quot;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Verwenden zwei (oder mehr) Schnipsel den gleichen <code>anchor</code>, so wird der
Inhalt in der Reihenfolge, in der die Schnipsel im Quelltext erscheinen,
aneinandergefügt. Auf diese Weise kann man leicht Erklärungen in einen
Quelltext einfügen oder an verschiedenen Stellen Ergänzungen zu einem
Codebereich hinzufügen (z.B. die Imports erweitern).</p>
</div>
<div id="unittest_sample4_input" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="asciidoc"><div class="lineno"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span></pre></div></td><td class="code"><div><pre><span></span>We do some thing in our code.

[source, lua, save]
.sample4.lua
----
&lt;&lt;some_process&gt;&gt;

print(result_of_someprocess)
----

To do this we need to do something with a variable.

[[some_process]]
[source, lua]
----
variable = 42
variable = variable + 42
----

But something else has also to be done. For example we need to set the
result.

[[some_process]]
[source, lua]
----
result_of_someprocess = variable * variable
----

Now lets go on to another thing ...
</pre></div></td></tr></table></div></code></pre>
</div>
</div>
<div class="paragraph">
<p>In der Ergebnisdatei sind nun die beiden Schnipsel
hintereinandergehängt.</p>
</div>
<div id="unittest_sample4_output" class="listingblock">
<div class="title">sample4.lua</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="lua"><span></span><span class="tok-n">variable</span> <span class="tok-o">=</span> <span class="tok-mi">42</span>
<span class="tok-n">variable</span> <span class="tok-o">=</span> <span class="tok-n">variable</span> <span class="tok-o">+</span> <span class="tok-mi">42</span>
<span class="tok-n">result_of_someprocess</span> <span class="tok-o">=</span> <span class="tok-n">variable</span> <span class="tok-o">*</span> <span class="tok-n">variable</span>

<span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-n">result_of_someprocess</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nicht immer möchte man einfach einen Zeilenumbruch zwischen den Snippets
haben. Manchmal ist es z.B. schöner eine Leerzeile zu haben. Bei
Aufzählungen ist oft ein Komma das beste.</p>
</div>
<div class="paragraph">
<p>In diesem Fall kann man an der einfügenden Stelle festlegen, welche
Trennzeichen einem am besten gefallen.</p>
</div>
<div id="unittest_sample5_input" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="asciidoc"><div class="lineno"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span></pre></div></td><td class="code"><div><pre><span></span>Let&#39;s imagine we need some rust struct.

[[mystruct]]
[source, rust]
----
pub struct MyStruct { &lt;&lt;mystruct_fields|join=&quot;, &quot;&gt;&gt; }
----

In our main process we need to define the struct and initialize it.

[source, rust, save]
.sample5.rs
----
&lt;&lt;mystruct&gt;&gt;

impl MyStruct {
  pub fn new {
    MyStruct {
      &lt;&lt;init_fields|join=&quot;,\n&quot;&gt;&gt;
    }
  }
}
----

In our struct we have variable x

[[mystruct_fields]]
[source, rust]
----
x: String
----

And we initialize it properly

[[init_fields]]
[source, rust]
----
x: &quot;this is the x text&quot;.to_string()
----

Now we can talk about all the functions that use x...

After some time we may have a function that use some other variable y.

[[mystruct_fields]]
[source, rust]
----
y: u8
----

And how is it initialized? You know the answer:

[[init_fields]]
[source, rust]
----
y: 42
----

And so on ...
</pre></div></td></tr></table></div></code></pre>
</div>
</div>
<div class="paragraph">
<p>Das Ergebnis ist eine Datei, die die beiden Snippet-Listen
unterschiedlich zusammenfügt.</p>
</div>
<div id="unittest_sample5_output" class="listingblock">
<div class="title">sample5.rs</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">struct</span> <span class="tok-nc">MyStruct</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-n">x</span>: <span class="tok-nb">String</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">y</span>: <span class="tok-kt">u8</span> <span class="tok-p">}</span>

<span class="tok-k">impl</span><span class="tok-w"> </span><span class="tok-n">MyStruct</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">fn</span> <span class="tok-nf">new</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">MyStruct</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">      </span><span class="tok-n">x</span>: <span class="tok-s">&quot;this is the x text&quot;</span><span class="tok-p">.</span><span class="tok-n">to_string</span><span class="tok-p">(),</span>
<span class="tok-w">      </span><span class="tok-n">y</span>: <span class="tok-mi">42</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">  </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Es lohnt sich nicht immer einen eigenen Block anzulegen. Bei kurzen
Snippets kann es praktischer sein ein Inline Code Objekt zu verwenden.
So könnte man den vorigen Quelltext auch folgendermaßen schreiben:</p>
</div>
<div id="unittest_sample6_input" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="asciidoc"><div class="lineno"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span></pre></div></td><td class="code"><div><pre><span></span>Let&#39;s imagine we need some rust struct.

[[mystruct]]
[source, rust]
----
pub struct MyStruct { &lt;&lt;mystruct_fields|join=&quot;, &quot;&gt;&gt; }
----

In our main process we need to define the struct and initialize it.

[source, rust, save]
.sample5.rs
----
&lt;&lt;mystruct&gt;&gt;

impl MyStruct {
  pub fn new {
    MyStruct {
      &lt;&lt;init_fields|join=&quot;,\n&quot;&gt;&gt;
    }
  }
}
----

In our struct we have variable [[mystruct_fields]]`x: String`. And we
initialize it properly

[[init_fields]]
[source, rust]
----
x: &quot;this is the x text&quot;.to_string()
----

Now we can talk about all the functions that use x...

After some time we may have a function that use some other variable
[[mystruct_fields]]`y: u8`. And how is it initialized? You know the
answer:

[[init_fields]]
[source, rust]
----
y: 42
----

And so on ...
</pre></div></td></tr></table></div></code></pre>
</div>
</div>
<div class="paragraph">
<p>Wird eine <code>cross reference</code> im Quelltext eingerückt, so wird der ganze
importierte Quelltext ebenfalls um die gleiche Höhe eingerückt (im Grunde wird
vor jedem Zeilenbeginn der Text vor der <code>cross reference</code> wieder eingefügt).</p>
</div>
<div id="unittest_sample7_input" class="listingblock">
<div class="title">Eingerückte Snippets</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="asciidoc"><div class="lineno"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span></pre></div></td><td class="code"><div><pre><span></span>Imagine you want to print a long pattern of &quot;//***//&quot; around so text to emphasize it.

We can do this:

[[print_pattern_once]]
[source, c]
----
printf(&quot;/&quot;);
printf(&quot;***&quot;);
printf(&quot;/&quot;);
----

But we want this line to be long

[[print_pattern]]
[source, c]
----
for (i=0;i&lt;5;i++) {
  &lt;&lt;print_pattern_once&gt;&gt;
}
print(&quot;\n&quot;);
----

And now lets emphasize the text.

[source, c, save]
.sample7.c
----
&lt;&lt;print_pattern&gt;&gt;
print(&quot;My emphasized text!!\n&quot;
&lt;&lt;print_pattern&gt;&gt;
----
</pre></div></td></tr></table></div></code></pre>
</div>
</div>
<div class="paragraph">
<p>Die generierte Datei wäre folgende:</p>
</div>
<div id="unittest_sample7_output" class="listingblock">
<div class="title">sample7.c</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="c"><span></span><span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">i</span><span class="tok-o">=</span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-n">i</span><span class="tok-o">&lt;</span><span class="tok-mi">5</span><span class="tok-p">;</span><span class="tok-n">i</span><span class="tok-o">++</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s">&quot;/&quot;</span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s">&quot;***&quot;</span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s">&quot;/&quot;</span><span class="tok-p">);</span>
<span class="tok-p">}</span>
<span class="tok-n">print</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-se">\n</span><span class="tok-s">&quot;</span><span class="tok-p">);</span>
<span class="tok-n">print</span><span class="tok-p">(</span><span class="tok-s">&quot;My emphasized text!!</span><span class="tok-se">\n</span><span class="tok-s">&quot;</span>
<span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">i</span><span class="tok-o">=</span><span class="tok-mi">0</span><span class="tok-p">;</span><span class="tok-n">i</span><span class="tok-o">&lt;</span><span class="tok-mi">5</span><span class="tok-p">;</span><span class="tok-n">i</span><span class="tok-o">++</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s">&quot;/&quot;</span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s">&quot;***&quot;</span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s">&quot;/&quot;</span><span class="tok-p">);</span>
<span class="tok-p">}</span>
<span class="tok-n">print</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-se">\n</span><span class="tok-s">&quot;</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Will man das vermeiden, so kann man das Stichwort <code>inline</code> angeben (TODO
wirklich? oder soll man in diesem Fall den Schnipsel einfach anders schreiben?
Was ist mit dem Zeilenende hinter der <code>cross reference</code>? Manchmal wäre es gut
es jedesmal hinten anzuhängen, manchmal nur einmal zu lassen und manchmal gar
nicht einzufügen.)</p>
</div>
<div class="paragraph">
<p>Will man einen den generierten Text in eine Datei speichern, so kann man den
Dateinamen angeben.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>TODO Quellcodebeispiele zwischen jedem Absatz</pre>
</div>
</div>
<div class="paragraph">
<p>Manchmal möchte man keine Ersetzung der <code>cross reference</code> in einem
Snippet haben. In diesem Fall kann man das Attribut <code>lisi-raw</code> übergeben
und der Snippet bleibt unangetastet.</p>
</div>
<div class="paragraph">
<p>TODO Codebeispiel</p>
</div>
<div class="sect4">
<h5 id="_parameterierte_snippets">Parameterierte Snippets</h5>
<div class="paragraph">
<p>Manche Schnipsel sind sehr allgemein und haben eine vielfältige
Verwendung. Mit parameterisierten Schnipseln kann man Bibliotheken
anlegen, welche eine breitere Verwendung von Schnipseln erlauben.</p>
</div>
<div class="paragraph">
<p>Dazu kann man einfach die Platzhalter überschreiben. Zum definieren
eines Parameters wird <code>:=</code> verwendet.</p>
</div>
<div id="unittest_sample8_input" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="asciidoc"><div class="lineno"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">  1</span>
<span class="normal">  2</span>
<span class="normal">  3</span>
<span class="normal">  4</span>
<span class="normal">  5</span>
<span class="normal">  6</span>
<span class="normal">  7</span>
<span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span></pre></div></td><td class="code"><div><pre><span></span>There is a snippet we want to use in different contexts.

[[test_condition]]
[source, sh]
----
if [[ &lt;&lt;condition&gt;&gt; ]] then
  echo &quot;&lt;&lt;err_message| condition:=&lt;&lt;condition&gt;&gt; &gt;&gt;&quot;
  exit &lt;&lt;exit_code&gt;&gt;
fi
----

Normally we exit with the message
[[err_message]]`the condition &lt;&lt;condition&gt;&gt; was not met` and return exit
code [[exit_code]]`1`.

Now we can use this snippet to test some condition before we execute our
script. Lets say we want to make sure `file_xy.txt` exists.

[[checks]]
[source, sh]
----
&lt;&lt;test_condition| condition:=&quot;-f file_xy.txt&quot;&gt;&gt;
----

But we could also override the default snippets with a custom one. For
example to change the error message.

[[checks]]
[source, sh]
----
&lt;&lt;test_condition|condition:=&quot;-f file_yz.txt&quot;,
                 err_message:=&quot;my custom err message yz&quot;&gt;&gt;
----

It&#39;s also possible to nest snippets. We can just reference them. Let&#39;s
say we would like to return the message
[[custom_err_message]]`return from nested param snippet with code &lt;&lt;custom_exit_code&gt;&gt;`
and exit code [[custom_exit_code]]`42`.

[[checks]]
[source, sh]
----
&lt;&lt;test_condition|condition:=&quot;-f nested_params.txt&quot;,
                 err_message:=&lt;&lt;custom_err_message&gt;&gt;,
                 exit_code:=&lt;&lt;custom_exit_code&gt;&gt;&gt;&gt;
----

What about more deeply nested snippets? Let&#39;s say we have another
condition where we want something to be done when it is met instead of
finishing the program.

[[process_condition]]
[source, sh]
----
if [[ &lt;&lt;condition&gt;&gt; ]] then
  echo &quot;&lt;&lt;info_message| condition:=&lt;&lt;condition&gt;&gt; &gt;&gt;&quot;
  &lt;&lt;do_something&gt;&gt;
fi
----

As the default info we put out
[[info_message]]`the condition &lt;&lt;condition&gt;&gt; was met` and call a
function [[do_something]]`myfunc($1)`.

[[checks]]
[source, sh]
----
&lt;&lt;process_condition| condition:=&quot;-f $1&quot;&gt;&gt;
----

But now suppose we want to process a certain function if `$2` exists but
when [[inner_condition]]`-f $1` matches too we want to do something additionally.

In this case we have to nest our snippets at a deeper level.

[[checks]]
[source, sh]
----
&lt;&lt;process_condition|condition:=&quot;-f $2&quot;,
    do_something := &lt;&lt;deep_nested_snippet|
      inner_do_something := &quot;nestedfunc($1, $2)&quot;
      &gt;&gt;
    &gt;&gt;
----

[[deep_nested_snippet]]
[source, sh]
----
&lt;&lt;process_condition|
    condition:=&quot;test_default_condition($2)&quot; &gt;&gt;
&lt;&lt;process_condition|
    condition:=&lt;&lt;inner_condition&gt;&gt;,
    do_something:=&lt;&lt;inner_do_something&gt;&gt; &gt;&gt;
----

Now we put all of these conditions at the beginning of our script.

[source, sh, save]
.sample8.sh
----
&lt;&lt;checks&gt;&gt;

echo &quot;you passed all checks&quot;
----
</pre></div></td></tr></table></div></code></pre>
</div>
</div>
<div class="paragraph">
<p>Das hier erzeugte Script sähe dann folgendermaßen aus:</p>
</div>
<div id="unittest_sample8_output" class="listingblock">
<div class="title">sample8.sh</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span></span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-o">[[</span><span class="tok-w"> </span>-f<span class="tok-w"> </span>file_xy.txt<span class="tok-w"> </span><span class="tok-o">]]</span><span class="tok-w"> </span><span class="tok-k">then</span>
<span class="tok-w">  </span><span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;the condition -f file_xy.txt was not met&quot;</span>
<span class="tok-w">  </span><span class="tok-nb">exit</span><span class="tok-w"> </span><span class="tok-m">1</span>
<span class="tok-k">fi</span>
<span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-o">[[</span><span class="tok-w"> </span>-f<span class="tok-w"> </span>file_yz.txt<span class="tok-w"> </span><span class="tok-o">]]</span><span class="tok-w"> </span><span class="tok-k">then</span>
<span class="tok-w">  </span><span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;my custom err message yz&quot;</span>
<span class="tok-w">  </span><span class="tok-nb">exit</span><span class="tok-w"> </span><span class="tok-m">1</span>
<span class="tok-k">fi</span>
<span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-o">[[</span><span class="tok-w"> </span>-f<span class="tok-w"> </span>nested_params.txt<span class="tok-w"> </span><span class="tok-o">]]</span><span class="tok-w"> </span><span class="tok-k">then</span>
<span class="tok-w">  </span><span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;return from nested param snippet with code 42&quot;</span>
<span class="tok-w">  </span><span class="tok-nb">exit</span><span class="tok-w"> </span><span class="tok-m">42</span>
<span class="tok-k">fi</span>
<span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-o">[[</span><span class="tok-w"> </span>-f<span class="tok-w"> </span><span class="tok-nv">$1</span><span class="tok-w"> </span><span class="tok-o">]]</span><span class="tok-w"> </span><span class="tok-k">then</span>
<span class="tok-w">  </span><span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;the condition -f </span><span class="tok-nv">$1</span><span class="tok-s2"> was met&quot;</span>
<span class="tok-w">  </span>myfunc<span class="tok-o">(</span><span class="tok-nv">$1</span><span class="tok-o">)</span>
<span class="tok-k">fi</span>
<span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-o">[[</span><span class="tok-w"> </span>-f<span class="tok-w"> </span><span class="tok-nv">$2</span><span class="tok-w"> </span><span class="tok-o">]]</span><span class="tok-w"> </span><span class="tok-k">then</span>
<span class="tok-w">  </span><span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;the condition -f </span><span class="tok-nv">$2</span><span class="tok-s2"> was met&quot;</span>
<span class="tok-w">  </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-o">[[</span><span class="tok-w"> </span>test_default_condition<span class="tok-o">(</span><span class="tok-nv">$2</span><span class="tok-o">)</span><span class="tok-w"> </span><span class="tok-o">]]</span><span class="tok-w"> </span><span class="tok-k">then</span>
<span class="tok-w">    </span><span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;the condition test_default_condition(</span><span class="tok-nv">$2</span><span class="tok-s2">) was met&quot;</span>
<span class="tok-w">    </span>myfunc<span class="tok-o">(</span><span class="tok-nv">$1</span><span class="tok-o">)</span>
<span class="tok-w">  </span><span class="tok-k">fi</span>
<span class="tok-w">  </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-o">[[</span><span class="tok-w"> </span>-f<span class="tok-w"> </span><span class="tok-nv">$1</span><span class="tok-w"> </span><span class="tok-o">]]</span><span class="tok-w"> </span><span class="tok-k">then</span>
<span class="tok-w">    </span><span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;the condition -f </span><span class="tok-nv">$1</span><span class="tok-s2"> was met&quot;</span>
<span class="tok-w">    </span>nestedfunc<span class="tok-o">(</span><span class="tok-nv">$1</span>,<span class="tok-w"> </span><span class="tok-nv">$2</span><span class="tok-o">)</span>
<span class="tok-w">  </span><span class="tok-k">fi</span>
<span class="tok-k">fi</span>

<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;you passed all checks&quot;</span></code></pre>
</div>
</div>
<details>
<summary class="title">Details und Edge-Cases</summary>
<div class="content">
<div class="paragraph">
<p>Das funktioniert auch, wenn die Snippets eingerückt wurden</p>
</div>
<div id="unittest_09indented_param_snippets_input" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="asciidoc"><div class="lineno"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span></pre></div></td><td class="code"><div><pre><span></span>We have a snippet

[[inner_snippet]]
[source, yaml]
----
this is my snippet &lt;&lt;text&gt;&gt;
----

And we indent it

[source, yaml, save]
.sample.yaml
----
category:
    &lt;&lt;inner_snippet|
        text:=&quot;my param text&quot;&gt;&gt;

category2:
    &lt;&lt;inner_snippet|
        text:=&lt;&lt;referenced_param&gt;&gt; &gt;&gt;
----

And here we have a param we reference

[[referenced_param]]
[source, yaml]
----
referenced param text
----
</pre></div></td></tr></table></div></code></pre>
</div>
</div>
<div class="paragraph">
<p>Die erzeugte Datei ist folgende:</p>
</div>
<div id="unittest_indented_param_snippets_output" class="listingblock">
<div class="title">sample.yaml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">category</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">this is my snippet my param text</span>

<span class="tok-nt">category2</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">this is my snippet referenced param text</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In einem Snippet kann man Parameter definieren, die in einem aufrufenden
Snippet überschrieben werden. Manchmal will man dabei auch in einem als
Parameter übergebenen Snippet (Unter)parameter überschreiben. Das muss
immer explizit geschehen, denn sonst könnten in einem Snippet Parameter
überschrieben werden, von denen ein aufrufendes Snippet einige Ebenen
höher gar keine Ahnung hat. Da das ein bisschen schwer zu verstehen ist,
schauen wir uns ein Beispiel an:</p>
</div>
<div id="unittest_10deep_nested_param_snippets_input" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="asciidoc"><div class="lineno"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span></pre></div></td><td class="code"><div><pre><span></span>We have a basic snippet

[[snippet_with_param]]
[source, python]
----
print(&quot;&lt;&lt;echo_text&gt;&gt;&quot;)
----

And we have a snippet that uses it.

[[calling_snippet_one]]
[source, python]
----
def my_function():
  &lt;&lt;snippet_with_param&gt;&gt;
  # &lt;&lt;echo_text&gt;&gt;
----

We have onther snippet that uses it too. But it overwrites the parameter.

[[calling_snippet_two]]
[source, python]
----
def my_other_function():
  &lt;&lt;snippet_with_param| echo_text := &lt;&lt;echo_text&gt;&gt; &gt;&gt;
  # &lt;&lt;echo_text&gt;&gt;
----

When we use these snippets we expect them to do different things. The
first should have the nested inner snippet untouched and the second
should use the parameter in the nested snippet.

[source, python, save]
.nested.py
----
&lt;&lt;calling_snippet_one|
    echo_text:=&quot;touch only outer&quot;&gt;&gt;

&lt;&lt;calling_snippet_two|
    echo_text:=&quot;touch inner snippet too&quot;&gt;&gt;
----

The default text is [[echo_text]]`untouched`.
</pre></div></td></tr></table></div></code></pre>
</div>
</div>
<div class="paragraph">
<p>Die generierte Datei ist:</p>
</div>
<div id="unittest_deep_nested_param_snippets_output" class="listingblock">
<div class="title">nested.py</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">my_function</span><span class="tok-p">():</span>
  <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-s2">&quot;untouched&quot;</span><span class="tok-p">)</span>
  <span class="tok-c1"># touch only outer</span>

<span class="tok-k">def</span> <span class="tok-nf">my_other_function</span><span class="tok-p">():</span>
  <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-s2">&quot;touch inner snippet too&quot;</span><span class="tok-p">)</span>
  <span class="tok-c1"># touch inner snippet too</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Man kann auch eine Art Aufruf-Hierarchie machen, indem man
parametrisierte Snippets als Parameter einsetzt. Um das zu erklären
gehen wir nochmal auf das Beispiel einer yaml Konfigurationsdatei ein.</p>
</div>
<div id="unittest_params_in_param_snippets_input" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="asciidoc"><div class="lineno"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span></pre></div></td><td class="code"><div><pre><span></span>We have a snippet

[[inner_snippet]]
[source, yaml]
----
this is my snippet &lt;&lt;text&gt;&gt;
----

And we indent it

[[category_template]]
[source, yaml]
----
category:
    &lt;&lt;inner_snippet|
        text:=&quot;my param text&quot;&gt;&gt;

category2:
    &lt;&lt;value_category2&gt;&gt;
----

Normally our `value_category2` is like this

[[value_category2]]
[source, yaml]
----
&lt;&lt;inner_snippet|
    text:=&lt;&lt;referenced_param&gt;&gt; &gt;&gt;
----

And here we have a param we reference

[[referenced_param]]
[source, yaml]
----
referenced param text
----

But in the end we want to use our `category_template` twice. Once in the
normal way and once with a substtuted inner snippet.

[source, yaml, save]
.sample.yaml
----
&lt;&lt;category_template&gt;&gt;

&lt;&lt;category_template|
    value_category2:=&lt;&lt;inner_snippet|
      text:=&quot;substituted with a param inside a param&quot;&gt;&gt; &gt;&gt;
----
</pre></div></td></tr></table></div></code></pre>
</div>
</div>
<div class="paragraph">
<p>Die erzeugte Datei ist folgende:</p>
</div>
<div id="unittest_params_in_param_snippets_output" class="listingblock">
<div class="title">sample.yaml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">category</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">this is my snippet my param text</span>

<span class="tok-nt">category2</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">this is my snippet referenced param text</span>

<span class="tok-nt">category</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">this is my snippet my param text</span>

<span class="tok-nt">category2</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">this is my snippet substituted with a param inside a param</span></code></pre>
</div>
</div>
</div>
</details>
</div>
</div>
<div class="sect3">
<h4 id="transform">Transformieren</h4>
<div class="paragraph">
<p>Vorhandene Codeschnipsel können nicht nur zu einer größeren Einheit
zusammengesetzt werden, sondern auch manipuliert werden. Auf diese Weise kann
man eine Art Templates generieren um damit dynamisch angepasste Texte zu
erzeugen. Anwendungen wären z.B. Serienbriefe oder die Ergänzung eines
Lizenz-Headers in allen Quellcode Dateien.</p>
</div>
<div class="paragraph">
<p>Die zu diesem Zweck bereitgestellten Funktionen werden jetzt erklärt:</p>
</div>
<div class="sect4">
<h5 id="usage_save">save (Speichern)</h5>
<div class="paragraph">
<p>Um überhaupt ein ausführbares Programm zu erhalten ist es unerlässlich den
erzeugten Quellcode in ein tatsächliches Programm umwandeln zu können. Die
wichtigste Möglichkeit dazu ist einen Schnipsel in eine Datei abspeichern zu
können. Dazu wird das Attribut <code>save</code> verwendet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="asciidoc"><span></span>Lets create a &quot;hello world&quot; program.

[source, lua, save]
.hello.lua
---
print(&quot;Hello World&quot;)
---</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="usage_eval">eval (Ausführen)</h5>
<div class="paragraph">
<p>Eine weitere Methode das Programm zu nutzen ist es direkt auszuführen. Das wird mit dem Atrribut <code>eval</code> gemacht.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="asciidoc"><span></span>Lets run a &quot;hello world&quot; program.

[source, lua, eval]
.hello.lua
---
print(&quot;Hello World&quot;)
---</code></pre>
</div>
</div>
<div class="paragraph">
<p>Dieses Beispiel würde direkt "Hello World" auf der Konsole schreiben.</p>
</div>
<div class="paragraph">
<p>Als Interpreter verwendet <code>lisi</code> standardmäßig die angegebende Scriptsprache (in den meisten Fällen stimmen der Name der Sprache und der Name des Interpreter-Executables überein).</p>
</div>
</div>
<div class="sect4">
<h5 id="usage_pipe">pipe</h5>
<div class="paragraph">
<p>Manchmal möchte man einen Codeschnipsel in leicht modifizierter Form vielfach
verwenden. In diesem Fall ist <code>pipe</code> ein sehr mächtiges Werkzeug.</p>
</div>
<div class="paragraph">
<p>Wird <code>pipe</code> als Attribut an einen Code Block angehangen, wird der darin befindliche Code, wie bei <code>eval</code>, ausgeführt. Im Gegensatz zu <code>eval</code> hat <code>pipe</code> die Möglichkeit die Code-Schnipsel selbst zu manipulieren. Dazu bekommt es eine Variable <code>lisi</code> zu Verfügung gestellt, welche Zugriff auf die Code-Generierung erhält.</p>
</div>
<div class="paragraph">
<p>Die Sprache des <code>pipe</code> Interpreters ist <a href="https://github.com/jonathandturner/rhai">rhai</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="asciidoc"><span></span>Print out the doctument header when running the program.

[source, rhai, pipe]
---
lisi.store(&quot;print_header&quot;, [[=[print(&quot;${doc.header}&quot;)]]=])
---</code></pre>
</div>
</div>
<div class="paragraph">
<p>Damit ist <code>pipe</code> ein äußerst mächtiges Werkzeug da man beliebig komplexe
Programme benutzen kann um Code Schnipsel zu erzeugen. Alle Methoden zum
Transformieren und Zusammenfügen lassen sich auch mit <code>pipe</code> verwenden, so dass
man sogar mit <code>pipe</code> erzeugte Codeschnipsel verwenden könnte um neue <code>pipe</code>
Codeschnipsel zu erzeugen.</p>
</div>
<div class="paragraph">
<p>Folgende Funktionen werden von der <code>lisi</code> Variable zur Verfügung gestellt:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">store(name, schnipsel)</dt>
<dd>
<p>Speichert einen String unter einem Namen als Schnipsel
ab.</p>
</dd>
<dt class="hdlist1">map(liste, function)</dt>
<dd>
<p>Führt eine Funktion über eine Liste von Objekten aus.</p>
</dd>
<dt class="hdlist1">save(path, schnipsel)</dt>
<dd>
<p>Führt den <code>save</code> Befehl auf einem String aus. Dieser
wird unter dem Pfad <code>path</code> abgespeichert.</p>
</dd>
<dt class="hdlist1">eval(schnipsel, interpreter)</dt>
<dd>
<p>Führt den <code>eval</code> Befehl auf einem String aus.
Der String wird von dem übergebenen <code>interpreter</code> ausgeführt (Standard ist
<code>lua</code>).</p>
</dd>
<dt class="hdlist1">pipe(schnipsel_name, parameter)</dt>
<dd>
<p>Führt einen <code>pipe</code> Befehl auf einem anderen
Schnipsel aus.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Einige Variablen sind immer stehen ebenfalls immer zur Verfügung:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">doc</dt>
<dd>
<p>Der ursprüngliche AST, welcher an die Erweiterung übergeben wird.</p>
</dd>
<dt class="hdlist1">args</dt>
<dd>
<p>Die Kommandozeilenparameter, die beim Aufruf zur Verfügung standen.</p>
</dd>
<dt class="hdlist1">rawsnippets</dt>
<dd>
<p>Die Codeschnipsel, wie sie aus dem AST extrahiert wurden, bevor
die inneren Referenzen durch Schnipsel ersetzt wurden.</p>
</dd>
<dt class="hdlist1">snippets</dt>
<dd>
<p>Die Codeschnipsel mit bereits eingesetzten Schnipseln an den
Referenzen.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Die Anwendungsmöglichkeiten von <code>pipe</code> sind extrem vielfältig und
mächtig. Deshalb werden wir in den nächsten Abschnitten einige
Anwendungsfälle besprechen, die sich mit <code>pipe</code> elegant lösen lassen.</p>
</div>
<div class="sect5">
<h6 id="_unit_tests_mit_pipe">Unit Tests mit pipe</h6>
<div class="paragraph">
<p>TODO kann auch einen link auf die Benutzer Dokumentation Beschreibung enthalten</p>
</div>
</div>
<div class="sect5">
<h6 id="_aspect_oriented_programming_mit_pipe">Aspect oriented Programming mit pipe</h6>
<div class="paragraph">
<p><a href="https://en.wikipedia.org/wiki/Aspect-oriented_programming">Aspect
oriented Programming</a> ist ein Programmieransatz welcher die Modifikation
von bestehenden Modulen erlaubt. Das ist oftmals sehr problematisch und
führt (meiner Meinung nach) bei breitem Einsatz zu schlecht wartbarem
und undurchschaubaren Quellcode. Wird es allerdings sparsam eingesetzt
kann es manchmal sehr schwierige Probleme einfach lösen.</p>
</div>
<div class="paragraph">
<p>Ein Beispiel sind Bedingungen an einen Typ welche zur Einführung des
Typs noch nicht klar sind. In <a href="https://www.rust-lang.org/">Rust</a> möchte
man z.B. oft Typen mit einem <code>derive</code> Macro automatisch Funktionen
implementieren lassen (z.B. serde). Zum Zeitpunkt der Definition des
Typs ist diese Notwendigkeit aber noch gar nicht klar oder nicht
offensichtlich. Dies führt zu Problemen in der Erklärung (welche bei
einem Literate Programm ja immer das wichtigste überhaupt ist) da man
anmerken muss, dass diese Code Stelle später noch erklärt wird und in
der späteren Erklärung den Quellcode nicht sieht. &#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect5">
<h6 id="_macro_systeme_mit_pipe">Macro Systeme mit pipe</h6>
<div class="paragraph">
<p>Ein <code>pipe</code> Block kann natürlich selber <a href="#usage_import_snippets">Snippets
importieren</a>. Dadurch ist es möglich Funktionen zu definieren (sogar
in einem anderen Dokument) und diese später in verschiedenen <code>pipe</code>
Schnipseln zu benutzen.</p>
</div>
<div class="paragraph">
<p>TODO</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="asciidoc"><div class="lineno"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span></pre></div></td><td class="code"><div><pre><span></span>First we define our macro lib:

[[pipe_functions]]
[source, rhai]
---
fn mystuff(string) {
  // Do my fancy manipulation functions here
}
---

Then we can use it in our pipes

[source, rhai, pipe]
---
&lt;&lt;pipe_functions&gt;&gt;

lisi.store(&quot;out&quot;, mystuff(&quot;test&quot;));
---

We can also use this functions in other snippets and even in other documents.
</pre></div></td></tr></table></div></code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="usage_control_flow">Den Ausführungsfluss steuern</h5>
<div class="paragraph">
<p>Manchmal ist es wichtig, die Reihenfolge, in der die Funktionen ausgeführt
werden, festlegen zu können. Ist die Reihenfolge nicht explizit definiert kann
die Implementierung die <code>save</code>,<code>eval</code>,<code>pipe</code> etc Funktionen in einer beliebigen
Reihenfolge oder sogar paralell ausführen. Oftmals ist das gut aber in einigen
Fällen möchte man die Reihenfolge explizit festlegen. Hier einige Beispiele:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Wenn man ein Script mit <code>save</code> speichern will und genau danach dieses Script
in einem <code>eval</code> Schritt mit Parametern aufrufen möchte. In diesem Fall muss
der <code>save</code> Schritt vor <code>eval</code> ausgeführt werden. So einen Anwendungsfall hat
man oft bei build-, deploy-, und bootstrap Schritten.</p>
</li>
<li>
<p>Den umgekehrten Fall gibt es genauso: Man möchte mit <code>save</code> Snippets
einbinden, diese sollen aber noch in einem <code>pipe</code> Schritt generiert werden.</p>
</li>
<li>
<p>Manchmal hat man <code>pipe</code> Schritte, die wiederrum von generierten Snippets
(durch andere <code>pipe</code> Schritte) abhängen.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Um diese und weitere Anwendungsfälle zu ermöglichen sind hier ein paar
grundlegende Regeln und Attribute definiert:</p>
</div>
<div class="paragraph">
<p>Sobald ein Snippet ein anderes Snippet einbindet ist es von diesem abhängig.
Daher muss das eingebundene Snippet zuerst bearbeitet werden.</p>
</div>
<div class="paragraph">
<p>Jedes Snippet unterstützt die Attribute <code>provides</code> und <code>depends</code>. Diese bekommen
jeweils eine id oder eine Liste von ids übergeben. Alle Snippets mit einer in
<code>depends</code> aufgelisteten id werden bearbeitet bevor das entsprechende Snippet
bearbeitet wird. Außerdem werden alle Snippets vorher ausgeführt, die eine in
<code>depends</code> aufgeführte id in ihrem <code>provides</code> Attribut aufführen.</p>
</div>
<div class="paragraph">
<p>Bei der Ausführung überprüft <code>lisi</code>, ob alle benötigten Snippets definiert
wurden und ob keine Kreisabhängigkeiten bestehen (z.B. Snippet1 benötigt
Snippet2 welches wiederum Snippet1 benötigt). In beiden Fällen würde der <code>AST</code>
um eine Fehlermeldung erweitert werden, welche einmal direkt an der jeweiligen
Stelle im Asciidoc Code eingefügt wird und einmal in einer Tabelle gleich zu
Beginn des Dokumentes mit einem Link auf die Problemstelle.</p>
</div>
<div class="paragraph">
<p>TODO Implementierung</p>
</div>
<div class="paragraph">
<p>TODO Soll eine graphische Darstellung des Kontrollflusses generiert werden
können? Notfalls wäre das mit <code>pipe</code> leicht implementiert.</p>
</div>
<div class="paragraph">
<p>TODO Während der Ausführung könnte <code>lisi</code> leicht überprüfen, ob <code>pipe</code>
tatsächlich alle ids speichert, die es in <code>provides</code> definiert und ob es keine
weiteres definiert.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="usage_create_userguides">Benutzerdokumentation erstellen</h3>
<div class="paragraph">
<p>Viele Kommentare über Literate Programming habe ich so verstanden, dass der
Gedanke dabei ist die Programmalgorithmen zu beschreiben und dokumentieren aber
<strong>nicht</strong> die Benutzerdokumentation.</p>
</div>
<div class="paragraph">
<p>Ich finde diese Trennung macht keinen Sinn und stellt eine unnötige
Beschränkung da. Eine Auseinandergehen der Benutzerdokumentation und der
Implemntierung ist genauso schlimm, wie Abweichungen der
Entwicklerdokumentation von der Implementierung. Das grosse Problem ist
wahrscheinlich eher:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Man will den Benutzer nicht mit Implementerungsdetails ablenken (die er
mitunter gar nicht verstehen kann und die ihn davon abhalten könnten die
Informationen zu finden, welche er sucht)</p>
</li>
<li>
<p>Benutzerdokumentation ist schwerer auszuführen und damit auch schwerer auf
dem gleichen Stand zu halten, wie die Implementierung.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Diese Probleme versuchte man damit zu umgehen, die Userdoku abzutrennen und
jemand separat damit zu beauftragen sie zu pflegen.</p>
</div>
<div class="paragraph">
<p>Dabei gibt es einen Teil des Quelltextes, welcher geradezu danach schreit, in
die Benutzerdokumentation aufenommen zu werden:</p>
</div>
<div class="sect3">
<h4 id="_spezifikationen_unit_tests_schreiben">Spezifikationen (Unit Tests) schreiben</h4>
<div class="paragraph">
<p>Unit Tests beschreiben das Verhalten und die Schnittstellen eines Programmes.
Damit entsprechen sie genau dem, was den Endnutzer interessiert.</p>
</div>
<div class="paragraph">
<p>Das erste, was man bei einem Projekt erstellen sollte ist ein gutes Lasten- und
Pflichtenheft. Es wird normalerweise in Zusammenarbeit mit dem Kunden oder dem
Auftraggeber erarbeitet und legt genau fest, was von einem Programm erwartet
wird. Eigentlich ist es nur naheliegend diese Informationen unmittelbar im
Quelltext (und zwar in Form von Testcases) zu nutzen.</p>
</div>
<div class="paragraph">
<p>Bisher ist die gängige Praxis (wenn überhaupt systematisch getestet wird), in
den Unittests nochmal seperat die Informationen aus dem Pflichtenheft
abzufassen aber diesmal auf die Implementierung zugeschnitten. Das leistet
einem Auseinanderdriften von Vorgaben und Implementierung Vorschub (oftmals
werden die Tests erst sehr spät in der Entwicklung geschrieben und dann auch
oft nur unvollständig).</p>
</div>
<div class="paragraph">
<p><code>lisi</code> hebt diese Einschränkung auf. Unit Tests können irgendwo in den
Quelltext eingefügt werden. Dass macht es möglich eine normale
Benutzerdokumentation zu schreiben und bei jeder Änderung zu überprüfen, ob
sich das Nutzererlebnis verändert. Gleichzeitig kann man die Doku flexibel
aufteilen z.B. in Getting Started, Tutorials und eine umfangreiche
Dokumentation, welche alle Details genau erläutert. Weder der Stil, noch die
Aufteilung, noch die Struktur sind fest vorgegeben, sondern können durch die in
<a href="#transform">Transformieren</a> beschrebenen Funktionen dynamisch erstellt werden.</p>
</div>
<div class="paragraph">
<p>TODO Beispiele mit Quellcode</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="literate-problems">Probleme mit dem literate programing Ansatz</h3>
<div class="paragraph">
<p>Es gibt einige Probleme, die man speziell beim literate programing hat, welche
bei anderen Herangehensweisen nicht so auftreten. Viele davon hängen allerdings
mehr mit den verfügbaren Tools zusammen als mit dieser Programmiermethode an
sich.</p>
</div>
<div class="sect3">
<h4 id="_bilder_diagramme_und_charts">Bilder, Diagramme und Charts</h4>
<div class="paragraph">
<p>Um mir einen Überblick über ein Programmkonzept oder eine Architektur zu
verschaffen finde ich im Allgemeinen Diagramme am nützlichsten. Oft beginne ich
damit diese zu zeichnen.</p>
</div>
<div class="paragraph">
<p>Im Laufe der Zeit verändern sich jedoch oft die Anforderungen an ein Programm
und damit auch die Architektur. So veralten die Diagramme bald.</p>
</div>
<div class="paragraph">
<p>Ebenso beginnen viele Programme damit, dass sie Daten analysieren (oft als Teil
des Programms) und ausgehend von diesen Erkenntnissen das Programm aufbauen.
Diese Daten können im Laufe der Zeit veralten.</p>
</div>
<div class="paragraph">
<p><strong>Lösungsansatz:</strong> Wenn man Funktionen hätte um aus Quelltext direkt Diagramme
(Flowdiagramme, Zustandsmaschinen, etc) erstellen zu lassen könnte man diese
anzeigen und hätte so immer aktuelle Diagramme. Oder man geht umgekehrt vor und
generiert aus ASCII-Art Quelltext. Auch dieser bliebe dann immer aktuell.</p>
</div>
<div class="paragraph">
<p>Um Charts darzustellen kann man Quelltext direkt als Chart ausgeben. Siehe z.B.
das Jypiter Projekt (TODO link).</p>
</div>
</div>
<div class="sect3">
<h4 id="_autovervollständigung_und_syntax_highlighting">Autovervollständigung und Syntax Highlighting</h4>
<div class="paragraph">
<p>Der Quelltext ist oft nicht leicht zu highlighten und auch die Verweiszeichen
machen es nicht leichter. Zudem ist es sehr schwer eine sinnvolle
Autovervollständigung für Quelltexte zu bekommen, da die Snippets verteilt und
in der Reihenfolge verschoben sind.</p>
</div>
<div class="paragraph">
<p><strong>Lösungsansatz:</strong> Tools wie treesitter (TODO link) und LSP (TODO link) könnten
helfen. Mit dem ersten kann man vielleicht auch sehr kleine Snippets sinnvoll
highlighten und mit dem zweiten kann man vieleicht einen Client machen, der den
Quelltext virtuell zusammensetzt und auch wieder auseinandernimmt (zurückmappt)
dadurch könnte der jeweilige Language-Server unverändert arbeiten und würde gar
nicht merken, dass der Quelltext anders zusammengesetzt wird.</p>
</div>
</div>
<div class="sect3">
<h4 id="_traces_zurückverfolgen">Traces zurückverfolgen</h4>
<div class="paragraph">
<p>Eines der größten Probleme beim Literate Programming scheint mir die
Zurückverfolgung von Stack-Traces zu sein.</p>
</div>
<div class="paragraph">
<p>Sowohl beim Kompilieren als auch beim Debuggen oder dem arbeiten in einer
interaktiven Konsole werden immer wieder Dateinamen und Zeilennummern
angegeben, welche erkennen helfen sollen welche Stelle im Quelltext für ein
Programmverhalten (meistens Fehler) verantwortlich ist. Diese Angaben würden
sich natürlich auf den generierten Quelltext beziehen und man kann nicht mehr
erkennen, wo sie ursprünglich im asciidoc-Dokument stehen. Würde man an die
Stelle im generierten Quellcode navigieren und dort die nötigen Änderungen
vornehmen werden das Ursprungsdokument und der tatsächliche Quellcode immer
stärker voneinander abweichen und die Dokumentation wird bald nicht mehr
korrekt sein. Zudem ist es in diesem Fall schnell nicht mehr möglich das
Programm über das eigentliche Quelldokument weiter zu entwickeln, da sich nicht
mehr feststellen lässt, ob der frisch erzeugte oder der manuell angepasste
Quelltext richtig ist (Merging-Problem). Entscheidet man sich andererseits
immer erst die richtige Stelle im Ursprungsdokument zu suchen und dort zu
ändern verlangsamt man den Entwicklungsprozess enorm. Ausserdem wird man so
viel Energie mit suchen vergeuden, dass nur noch wenig kreative Kraft für die
eigentliche Programmentwicklung bleibt.</p>
</div>
<div class="paragraph">
<p>Daher ist es am besten direkt beim Erzeugen des Quellcodes auch ein Mapping der
Zeilen (und eventuell ihrer Transformation) mit anzulegen. Anschließend sollte
man die Fehlermeldungen automatisiert korrigieren. Das macht man am besten mit
einem Filter, so dass man das (zurück-)mappen nie von Hand anstoßen muss.</p>
</div>
</div>
<div class="sect3">
<h4 id="_alternative_lösungsansätze_und_veralteter_code">Alternative Lösungsansätze und veralteter Code</h4>
<div class="paragraph">
<p>Je länger ein Programm existiert desto mehr wird es verändert werden und mit
alten Codefrakmenten zu kämpfen haben. Es müsste eine Möglichkeit geben Code als
"deprecated" oder als "alternative" zu kennzeichnen, damit der Leser weis, dass
dieser Code nicht relevant für die Programmausführung ist. Zudem wäre es sehr
nützlich gleich zu Beginn des Dokumentes dieses mit einem Status zu versehen
(Entwurf, Proof of Konzept, Beta, Stabil, Veraltet, &#8230;&#8203;) und eventuell direkt
auf ein Nachfolgedokument zu verweisen.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_beispiele">Beispiele</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_eine_präsentation_als_literate_program">Eine Präsentation als literate program</h3>
<div class="paragraph">
<p>TODO Alles in dieser Sektion sollte später in eine eigene Datei ausgelagert
werden. Es ist gleichzeitig ein Beispiel, wie man eine Präsentation als
literate program verfassen kann und eine Präsentation von <code>lisi</code>. &#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>Präsentationen haben oft ein Problem: Sie sind langweilig, da sie lienear
aufgebaut sind, user menschliches Denken aber mit Räumen und Assotiationen
arbeitet. Moderne Tools wie prezi (TODO link) sollen da abhelfen und bieten die
Möglichkeit Ideen auf eine neue Art dazustellen.  Moderne Präsentationen haben
ein neues Problem: Der Nutzer ist so auf seine Darstellungsmöglichkeiten
fixiert, dass der Inhalt untergeht (das gleiche war früher mit Folienübergängen
der Fall).</p>
</div>
<div class="paragraph">
<p>Um dem abzuhelfen bietet sich literate programing an. Da der Nutzer vor allem
versucht seine Ideen als Text zu verfassen stehen sie wieder im Mittelpunkt und
die Effekte helfen wieder die Idee klarer herauszustellen, statt als
Selbstzweck zu dienen. Im folgenden wird gezeigt, wie man eine moderne
Präsentation über den Einsatz von <code>lisi</code> für Präsentationen verfassen kann.</p>
</div>
<div class="sect3">
<h4 id="_vorraussetzungen">Vorraussetzungen</h4>
<div class="paragraph">
<p>Wir wollen, dass unsere Präsentation</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Auf möglichst vielen Geräten lauffähig ist (cross-plattform)</p>
</li>
<li>
<p>Unabhängig von einer Internetverbindung abgespielt werden kann</p>
</li>
<li>
<p>Interaktive elemente enthält</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Als Basis benutzen wir daher ein Werkzeug, welches im Browser ausgeführt werden
kann (aber nicht zwangsläufig eine Verbindung ins Internet benötigt):
<a href="https://github.com/impress/impress.js">impress.js</a>.</p>
</div>
<div class="paragraph">
<p>Da wir zudem einige interaktive charts einbinden möchten benutzen wir noch
<a href="https://d3js.org/:">d3</a>.</p>
</div>
<div id="imports" class="listingblock">
<div class="title">imports</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="html"><span></span>  <span class="tok-p">&lt;</span><span class="tok-nt">script</span> <span class="tok-na">type</span><span class="tok-o">=</span><span class="tok-s">&quot;text/javascript&quot;</span> <span class="tok-na">src</span><span class="tok-o">=</span><span class="tok-s">&quot;js/d3.js&quot;</span><span class="tok-p">&gt;&lt;/</span><span class="tok-nt">script</span><span class="tok-p">&gt;</span>
  <span class="tok-p">&lt;</span><span class="tok-nt">script</span> <span class="tok-na">type</span><span class="tok-o">=</span><span class="tok-s">&quot;text/javascript&quot;</span> <span class="tok-na">src</span><span class="tok-o">=</span><span class="tok-s">&quot;js/impress.js&quot;</span><span class="tok-p">&gt;&lt;/</span><span class="tok-nt">script</span><span class="tok-p">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>TODO Zeigen, wie man eine Übersicht als svg-Datei einbinden kann und
anschließend mit jedem Schritt einen Ausschnitt davon anzeigen und beschreiben
kann&#8230;&#8203;</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_einen_issue_tracker_aus_todo_adoc_und_changes_adoc_dokumenten_erstellen">Einen Issue-Tracker aus TODO.adoc und Changes.adoc Dokumenten erstellen</h3>
<div class="paragraph">
<p>TODO Alles in dieser Sektion sollte später in eine eigene Datei ausgelagert
werden. Es zeigt, wie man <code>asciidoctor</code> und <code>lisi</code> dazu nutzen kann ein
verteiltes Issue-Tracker Programm (samt Webinterface) zu erstellen.</p>
</div>
<div class="paragraph">
<p>Ähnlich wie Programme Dokumentation sind, so sind auch die Tickets in
Issue-Trackern Dokumentation. Sie beschreiben die Fortentwicklung eines
Programms (wichtig unter anderem für support und Kompatibilitäts-Checks), sowie
die Ziele für die Zukunft. In den vorhandenen Programmlösungen werden diese
Informationen vom eigentlichen Programm getrennt. Da man sie oft dennoch
benötigt muss (redundant) eine Changes-Datei gepflegt werden um Nutzer über
Neuerungen und deren Anwendung zu informieren. Dies bedeutet zusätzlichen
Pflegeaufwand und eine potentielle Fehlerquelle.</p>
</div>
<div class="paragraph">
<p>Zudem werden immer mehr Programme verteilt entwickelt (was viele Vorteile mit
sich bringt TODO link zu git Buch), aber die bisherigen Issue-Programme sind
alle zentralisiert und lassen kein verteiltes abarbeiten von Tickets zu.</p>
</div>
<div class="paragraph">
<p>Ausserdem können diese Ticket-Verwaltungen ausschließlich über ein webinterface
bedient werden. Für Entwickler wäre es wünschenswert einfach Textdateien
bearbeiten zu können&#8230;&#8203;</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementierung">Implementierung</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_codeschnipsel_verarbeiten">Codeschnipsel verarbeiten</h3>
<div class="sect3">
<h4 id="_eine_datenbank_für_codeschnipsel_anlegen">Eine Datenbank für Codeschnipsel anlegen</h4>
<div class="paragraph">
<p>Um die Snippets zu verarbeiten müssen wir leicht auf sie zugreifen
können. Das Ziel der <a href="#usage_extract">Extrakt Phase</a> ist es alle
Schnipsel in eine Datenbank (oder Cache je nach Sichtweise) zu
überführen, wo wir wahlfrei darauf zugreifen können. Dafür verwenden wir
eine <code>HashMap</code>.</p>
</div>
<div id="crate_usages" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-k">use</span><span class="tok-w"> </span><span class="tok-n">std</span>::<span class="tok-n">collections</span>::<span class="tok-n">HashMap</span><span class="tok-p">;</span>
<span class="tok-k">use</span><span class="tok-w"> </span><span class="tok-n">std</span>::<span class="tok-n">collections</span>::<span class="tok-n">hash_map</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div id="internal_structs" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">struct</span> <span class="tok-nc">SnippetDB</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-n">snippets</span>: <span class="tok-nc">HashMap</span><span class="tok-o">&lt;</span><span class="tok-nb">String</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">Snippet</span><span class="tok-o">&gt;</span><span class="tok-p">,</span>
<span class="tok-p">}</span>

<span class="tok-k">impl</span><span class="tok-w"> </span><span class="tok-n">SnippetDB</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">fn</span> <span class="tok-nf">new</span><span class="tok-p">()</span><span class="tok-w"> </span>-&gt; <span class="tok-nc">Self</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">SnippetDB</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">      </span><span class="tok-n">snippets</span>: <span class="tok-nc">HashMap</span>::<span class="tok-n">default</span><span class="tok-p">(),</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">  </span><span class="tok-p">}</span>

<span class="tok-w">  </span><span class="tok-o">&lt;&lt;</span><span class="tok-n">snippet_db_functions</span><span class="tok-o">&gt;&gt;</span>

<span class="tok-w">  </span><span class="tok-sd">/// Get the snippet with the name `name`</span>
<span class="tok-w">  </span><span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">fn</span> <span class="tok-nf">get</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-bp">self</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">name</span>: <span class="tok-kp">&amp;</span><span class="tok-kt">str</span><span class="tok-p">)</span><span class="tok-w"> </span>-&gt; <span class="tok-nb">Option</span><span class="tok-o">&lt;&amp;</span><span class="tok-n">Snippet</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-n">snippets</span><span class="tok-p">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">name</span><span class="tok-p">)</span>
<span class="tok-w">  </span><span class="tok-p">}</span>

<span class="tok-w">  </span><span class="tok-sd">/// Get the snippet with the name `name` and</span>
<span class="tok-w">  </span><span class="tok-sd">/// remove it from the snippet database</span>
<span class="tok-w">  </span><span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">fn</span> <span class="tok-nf">pop</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-bp">self</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">name</span>: <span class="tok-kp">&amp;</span><span class="tok-kt">str</span><span class="tok-p">)</span><span class="tok-w"> </span>-&gt; <span class="tok-nb">Option</span><span class="tok-o">&lt;</span><span class="tok-n">Snippet</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-n">snippets</span><span class="tok-p">.</span><span class="tok-n">remove</span><span class="tok-p">(</span><span class="tok-n">name</span><span class="tok-p">)</span>
<span class="tok-w">  </span><span class="tok-p">}</span>

<span class="tok-w">  </span><span class="tok-sd">/// Get iterator over all snippets</span>
<span class="tok-w">  </span><span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">fn</span> <span class="tok-nf">iter</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-bp">self</span><span class="tok-p">)</span><span class="tok-w"> </span>-&gt; <span class="tok-nc">hash_map</span>::<span class="tok-n">Iter</span><span class="tok-o">&lt;</span><span class="tok-nb">String</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">Snippet</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-n">snippets</span><span class="tok-p">.</span><span class="tok-n">iter</span><span class="tok-p">()</span>
<span class="tok-w">  </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Jeder Snippet kann einer von vier Kategorien zugewiesen werden.</p>
</div>
<div id="internal_structs" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-cp">#[derive(Clone, Debug)]</span>
<span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">enum</span> <span class="tok-nc">SnippetType</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-n">Save</span><span class="tok-p">(</span><span class="tok-nb">String</span><span class="tok-p">),</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">  </span><span class="tok-n">Eval</span><span class="tok-p">(</span><span class="tok-nb">String</span><span class="tok-p">),</span><span class="tok-w"> </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">  </span><span class="tok-n">Pipe</span><span class="tok-p">,</span><span class="tok-w">         </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-w">  </span><span class="tok-n">Plain</span><span class="tok-p">,</span><span class="tok-w">        </span><i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Er kann in eine Datei abgespeichert werden (TODO link)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Oder von einem Interpreter ausgeführt werden (TODO link)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Oder zur Erzeugung von dynamischen Snippet benutzt werden (TODO link)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Oder keine besondere Funktion haben. Dann wird er meist von anderen Snippets
eingebunden (TODO link).</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Zusätzlich hat ein Snippet noch einige weitere Eigenschaften, welche die
Verarbeitung ermöglichen.</p>
</div>
<div id="internal_structs" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-cp">#[derive(Clone, Debug)]</span>
<span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">struct</span> <span class="tok-nc">Snippet</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-n">kind</span>: <span class="tok-nc">SnippetType</span><span class="tok-p">,</span>
<span class="tok-w">  </span><span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-n">content</span>: <span class="tok-nb">String</span><span class="tok-p">,</span><span class="tok-w">         </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">  </span><span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-n">raw_content</span>: <span class="tok-nb">String</span><span class="tok-p">,</span>
<span class="tok-w">  </span><span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-n">children</span>: <span class="tok-nb">Vec</span><span class="tok-o">&lt;</span><span class="tok-n">Snippet</span><span class="tok-o">&gt;</span><span class="tok-p">,</span><span class="tok-w">  </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">  </span><span class="tok-sd">/// List of all keys the snippet depends on</span>
<span class="tok-w">  </span><span class="tok-sd">/// before it can be processed</span>
<span class="tok-w">  </span><span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-n">depends_on</span>: <span class="tok-nb">Vec</span><span class="tok-o">&lt;</span><span class="tok-nb">String</span><span class="tok-o">&gt;</span><span class="tok-p">,</span><span class="tok-w"> </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-w">  </span><span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-n">attributes</span>: <span class="tok-nc">HashMap</span><span class="tok-o">&lt;</span><span class="tok-nb">String</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-nb">String</span><span class="tok-o">&gt;</span><span class="tok-p">,</span>
<span class="tok-w">  </span><span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-n">raw</span>: <span class="tok-kt">bool</span><span class="tok-p">,</span>
<span class="tok-p">}</span>

<span class="tok-k">impl</span><span class="tok-w"> </span><span class="tok-n">Snippet</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-o">&lt;&lt;</span><span class="tok-n">snippet_functions</span><span class="tok-o">&gt;&gt;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Ein Snippet kann aus mehreren aneinandergehängten Snippets bestehen (TODO
link).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Dadurch muss der Text des Snippets aus allen anderen Snippets berechnet
werden.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Snippets haben <a href="#usage_import_snippets">andere Snippets, die sie
einbinden</a>, oder man möchte eine explizite Reihenfolge festlegen
(TODO link). Daher werden hier alle Snippets aufgelistet, die vorher
verarbeitet werden müssen.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_den_ast_filtern_und_die_datenbank_füllen">Den AST filtern und die Datenbank füllen</h4>
<div id="internal_functions" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-sd">/// Gets recursively all snippets from an element</span>
<span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">fn</span> <span class="tok-nf">extract</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-bp">self</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">snippets</span>: <span class="tok-nc">SnippetDB</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">input</span>: <span class="tok-kp">&amp;</span><span class="tok-nc">ElementSpan</span><span class="tok-p">)</span><span class="tok-w"> </span>-&gt; <span class="tok-nb">Result</span><span class="tok-o">&lt;</span><span class="tok-n">SnippetDB</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">Error</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-k">match</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">input</span><span class="tok-p">.</span><span class="tok-n">element</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">Element</span>::<span class="tok-n">TypedBlock</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">      </span><span class="tok-n">kind</span>: <span class="tok-nc">BlockType</span>::<span class="tok-n">Listing</span><span class="tok-p">,</span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">      </span><span class="tok-o">&lt;&lt;</span><span class="tok-n">check_is_lisi_code_block</span><span class="tok-o">&gt;&gt;</span>
<span class="tok-w">      </span><span class="tok-o">&lt;&lt;</span><span class="tok-n">extract_attributes</span><span class="tok-o">|</span><span class="tok-n">join</span><span class="tok-o">=</span><span class="tok-s">&quot;</span><span class="tok-se">\n\n</span><span class="tok-s">&quot;</span><span class="tok-o">&gt;&gt;</span>
<span class="tok-w">      </span><span class="tok-o">&lt;&lt;</span><span class="tok-n">find_references</span><span class="tok-o">&gt;&gt;</span>
<span class="tok-w">      </span><span class="tok-o">&lt;&lt;</span><span class="tok-n">store_snippet_in_internal_db</span><span class="tok-o">&gt;&gt;</span>

<span class="tok-w">      </span><span class="tok-nb">Ok</span><span class="tok-p">(</span><span class="tok-n">snippets</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-n">Element</span>::<span class="tok-n">Styled</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">      </span><span class="tok-o">&lt;&lt;</span><span class="tok-n">check_is_inline_code_block</span><span class="tok-o">&gt;&gt;</span>
<span class="tok-w">      </span><span class="tok-o">&lt;&lt;</span><span class="tok-n">inline_extract_attributes</span><span class="tok-o">&gt;&gt;</span>
<span class="tok-w">      </span><span class="tok-o">&lt;&lt;</span><span class="tok-n">store_snippet_in_internal_db</span><span class="tok-o">&gt;&gt;</span>

<span class="tok-w">      </span><span class="tok-nb">Ok</span><span class="tok-p">(</span><span class="tok-n">snippets</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-n">Element</span>::<span class="tok-n">IncludeElement</span><span class="tok-p">(</span><span class="tok-n">ast</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-n">ast</span><span class="tok-w"> </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">      </span><span class="tok-p">.</span><span class="tok-n">inner</span>
<span class="tok-w">      </span><span class="tok-p">.</span><span class="tok-n">elements</span>
<span class="tok-w">      </span><span class="tok-p">.</span><span class="tok-n">iter</span><span class="tok-p">()</span>
<span class="tok-w">      </span><span class="tok-p">.</span><span class="tok-n">try_fold</span><span class="tok-p">(</span><span class="tok-n">snippets</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-n">snippets</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">element</span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-n">extract</span><span class="tok-p">(</span><span class="tok-n">snippets</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">element</span><span class="tok-p">)</span>
<span class="tok-w">      </span><span class="tok-p">}),</span>
<span class="tok-w">    </span><span class="tok-n">_</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-n">input</span><span class="tok-p">.</span><span class="tok-n">children</span><span class="tok-p">.</span><span class="tok-n">iter</span><span class="tok-p">().</span><span class="tok-n">try_fold</span><span class="tok-p">(</span><span class="tok-n">snippets</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-n">snippets</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">element</span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">      </span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-n">extract</span><span class="tok-p">(</span><span class="tok-n">snippets</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">element</span><span class="tok-p">)</span>
<span class="tok-w">    </span><span class="tok-p">}),</span>
<span class="tok-w">  </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Ist ein Element ein Code-Snippet (ob Block oder Inline) wird es weiterverarbeitet.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Falls ein Element zwar kein Snippet ist aber Unterknoten hat, wird rekursiv
weiter nach Quellcode-Snippets gesucht.</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_nur_codeschipsel_verarbeiten_die_auch_von_lisi_verwendet_werden">Nur Codeschipsel verarbeiten, die auch von Lisi verwendet werden</h5>
<div class="paragraph">
<p>Es gibt die verschiedensten Codeschnipsel. Nicht alle werden auch verwendet um
Programme zu generieren. In Asciidoc haben Blocks mit Quellcode als ersten
Parameter <code>source</code>. <code>lisi</code> verarbeitet nur diese Blocks.</p>
</div>
<div id="check_is_lisi_code_block" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">args</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">input</span><span class="tok-p">.</span><span class="tok-n">positional_attributes</span><span class="tok-p">.</span><span class="tok-n">iter</span><span class="tok-p">();</span>
<span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-o">!</span><span class="tok-p">(</span><span class="tok-n">args</span><span class="tok-p">.</span><span class="tok-n">next</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-nb">Some</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">AttributeValue</span>::<span class="tok-n">Ref</span><span class="tok-p">(</span><span class="tok-s">&quot;source&quot;</span><span class="tok-p">)))</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-nb">Ok</span><span class="tok-p">(</span><span class="tok-n">snippets</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Wenn es sich dagegen um ein Inline Snippet handelt erkennt man es daran, dass es einen Anker hat.</p>
</div>
<div id="check_is_inline_code_block" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">match</span><span class="tok-w"> </span><span class="tok-n">input</span><span class="tok-p">.</span><span class="tok-n">get_attribute</span><span class="tok-p">(</span><span class="tok-s">&quot;anchor&quot;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-nb">Some</span><span class="tok-p">(</span><span class="tok-n">id</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-p">.</span><span class="tok-n">to_string</span><span class="tok-p">(),</span>
<span class="tok-w">  </span><span class="tok-nb">None</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-nb">Ok</span><span class="tok-p">(</span><span class="tok-n">snippets</span><span class="tok-p">);</span><span class="tok-w"> </span><span class="tok-p">},</span>
<span class="tok-p">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Das zweite Attribut gibt den Interpreter an. Falls dieser nicht durch eine
spezielle Anpassung überschrieben wird.</p>
</div>
<div id="extract_attributes" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">interpreter</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">None</span><span class="tok-p">;</span>
<span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-nb">Some</span><span class="tok-p">(</span><span class="tok-n">value</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">args</span><span class="tok-p">.</span><span class="tok-n">next</span><span class="tok-p">()</span><span class="tok-w">  </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-k">match</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">value</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">AttributeValue</span>::<span class="tok-n">Ref</span><span class="tok-p">(</span><span class="tok-n">value</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">      </span><span class="tok-n">interpreter</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">Some</span><span class="tok-p">(</span><span class="tok-o">*</span><span class="tok-n">value</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-p">},</span>
<span class="tok-w">    </span><span class="tok-n">AttributeValue</span>::<span class="tok-nb">String</span><span class="tok-p">(</span><span class="tok-n">value</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">      </span><span class="tok-n">interpreter</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">Some</span><span class="tok-p">(</span><span class="tok-n">value</span><span class="tok-p">.</span><span class="tok-n">as_str</span><span class="tok-p">());</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">  </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_dem_snippet_alle_wichtigen_attribute_übergeben">Dem Snippet alle wichtigen Attribute übergeben</h5>
<div class="paragraph">
<p>Es gibt einige Attribute der Codeschnipsel im AST, die für die
Weiterverarbeitung durch <code>lisi</code> wichtig sind.</p>
</div>
<div class="paragraph">
<p>Das Pfad Attribut ist wichtig für alle <code>save</code> Snippets (TODO link). Falls es nicht explizit definiert wurde, gehen wir davon aus, das der Titel des Codeblocks den Pfad enthällt.</p>
</div>
<div id="extract_attributes" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">title</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">input</span><span class="tok-p">.</span><span class="tok-n">get_attribute</span><span class="tok-p">(</span><span class="tok-s">&quot;title&quot;</span><span class="tok-p">);</span>
<span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">path</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">input</span><span class="tok-p">.</span><span class="tok-n">get_attribute</span><span class="tok-p">(</span><span class="tok-s">&quot;path&quot;</span><span class="tok-p">).</span><span class="tok-n">or</span><span class="tok-p">(</span><span class="tok-n">title</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Die <code>id</code> benötigen wir, damit Snippets aufeinander verweisen können. Falls sie im Quelldokument nicht definiert wurde verwenden wir die Anfangs- und Endposition des Blocks um eine eindeutige id zu bekommen.</p>
</div>
<div id="extract_attributes" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">id</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">input</span><span class="tok-p">.</span><span class="tok-n">get_attribute</span><span class="tok-p">(</span><span class="tok-s">&quot;anchor&quot;</span><span class="tok-p">).</span><span class="tok-n">unwrap_or</span><span class="tok-p">(</span>
<span class="tok-w">  </span><span class="tok-o">&amp;</span><span class="tok-fm">format!</span><span class="tok-p">(</span><span class="tok-s">&quot;_id_{}_{}&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">input</span><span class="tok-p">.</span><span class="tok-n">start</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">input</span><span class="tok-p">.</span><span class="tok-n">end</span><span class="tok-p">),</span>
<span class="tok-p">).</span><span class="tok-n">to_string</span><span class="tok-p">();</span><span class="tok-w"> </span><span class="tok-c1">// TODO Vielleicht Datei + Zeile?</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Außerdem gehen wir alle Attribute durch und überschreiben unsere Standardwerte falls das Attribut definiert wurde.</p>
</div>
<div id="extract_attributes" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">interpreter</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">input</span><span class="tok-p">.</span><span class="tok-n">get_attribute</span><span class="tok-p">(</span><span class="tok-s">&quot;interpreter&quot;</span><span class="tok-p">).</span><span class="tok-n">or</span><span class="tok-p">(</span><span class="tok-n">interpreter</span><span class="tok-p">);</span>
<span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">raw</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-kc">false</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ebenso benötigen wir einen Snippet Typ (TODO link). Er wird in den
positionsabhängigen Argumenten definiert. Falls nicht vorgegeben wurde, gehen
wir davon aus, das es ein Snippet ohne besondere Verarbeitung ist.</p>
</div>
<div id="extract_attributes" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">kind</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">SnippetType</span>::<span class="tok-n">Plain</span><span class="tok-p">;</span>

<span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-n">argument</span><span class="tok-w"> </span><span class="tok-k">in</span><span class="tok-w"> </span><span class="tok-n">args</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-k">match</span><span class="tok-w"> </span><span class="tok-n">argument</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">AttributeValue</span>::<span class="tok-n">Ref</span><span class="tok-p">(</span><span class="tok-s">&quot;save&quot;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">      </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">path</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">path</span><span class="tok-p">.</span><span class="tok-n">ok_or</span><span class="tok-p">(</span><span class="tok-n">Error</span>::<span class="tok-n">Missing</span><span class="tok-p">)</span><span class="tok-o">?</span><span class="tok-p">;</span>
<span class="tok-w">      </span><span class="tok-n">kind</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">SnippetType</span>::<span class="tok-n">Save</span><span class="tok-p">(</span><span class="tok-n">path</span><span class="tok-p">.</span><span class="tok-n">to_string</span><span class="tok-p">());</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-n">AttributeValue</span>::<span class="tok-n">Ref</span><span class="tok-p">(</span><span class="tok-s">&quot;eval&quot;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">      </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">interpreter</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">interpreter</span><span class="tok-p">.</span><span class="tok-n">clone</span><span class="tok-p">().</span><span class="tok-n">ok_or</span><span class="tok-p">(</span><span class="tok-n">Error</span>::<span class="tok-n">Missing</span><span class="tok-p">)</span><span class="tok-o">?</span><span class="tok-p">;</span>
<span class="tok-w">      </span><span class="tok-n">kind</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">SnippetType</span>::<span class="tok-n">Eval</span><span class="tok-p">(</span><span class="tok-n">interpreter</span><span class="tok-p">.</span><span class="tok-n">to_string</span><span class="tok-p">());</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-n">AttributeValue</span>::<span class="tok-n">Ref</span><span class="tok-p">(</span><span class="tok-s">&quot;pipe&quot;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">      </span><span class="tok-n">kind</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">SnippetType</span>::<span class="tok-n">Pipe</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-n">AttributeValue</span>::<span class="tok-n">Ref</span><span class="tok-p">(</span><span class="tok-s">&quot;lisi-raw&quot;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">      </span><span class="tok-n">raw</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-kc">true</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-n">_</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">(),</span>
<span class="tok-w">  </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div id="errors" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-cp">#[error(</span><span class="tok-s">&quot;a nessessary attribute is missing&quot;</span><span class="tok-cp">)]</span>
<span class="tok-n">Missing</span><span class="tok-p">,</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Bei inline Snippets ist das etwas einfacher, da es hier nur normale Schnipsel gibt.</p>
</div>
<div id="inline_extract_attributes" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">kind</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">SnippetType</span>::<span class="tok-n">Plain</span><span class="tok-p">;</span>
<span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">raw</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-kc">false</span><span class="tok-p">;</span>
<span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">dependencies</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">Vec</span>::<span class="tok-n">new</span><span class="tok-p">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Alle weiteren Attribute werden in einer HashMap abgelegt, die später von der Pipe (TODO link verarbeitet werden kann).</p>
</div>
<div id="extract_attributes" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">attributes</span>: <span class="tok-nc">HashMap</span><span class="tok-o">&lt;</span><span class="tok-nb">String</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-nb">String</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">HashMap</span>::<span class="tok-n">default</span><span class="tok-p">();</span>

<span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-n">key</span><span class="tok-w"> </span><span class="tok-k">in</span><span class="tok-w"> </span><span class="tok-n">input</span><span class="tok-p">.</span><span class="tok-n">attributes</span><span class="tok-p">.</span><span class="tok-n">iter</span><span class="tok-p">().</span><span class="tok-n">map</span><span class="tok-p">(</span><span class="tok-o">|</span><span class="tok-n">attr</span><span class="tok-o">|</span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-n">attr</span><span class="tok-p">.</span><span class="tok-n">key</span><span class="tok-p">.</span><span class="tok-n">clone</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">})</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-n">attributes</span><span class="tok-p">.</span><span class="tok-n">insert</span><span class="tok-p">(</span><span class="tok-n">key</span><span class="tok-p">.</span><span class="tok-n">clone</span><span class="tok-p">(),</span><span class="tok-w"> </span><span class="tok-n">input</span><span class="tok-p">.</span><span class="tok-n">get_attribute</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">key</span><span class="tok-p">).</span><span class="tok-n">unwrap</span><span class="tok-p">().</span><span class="tok-n">to_string</span><span class="tok-p">());</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div id="inline_extract_attributes" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">attributes</span>: <span class="tok-nc">HashMap</span><span class="tok-o">&lt;</span><span class="tok-nb">String</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-nb">String</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">HashMap</span>::<span class="tok-n">default</span><span class="tok-p">();</span>

<span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-n">key</span><span class="tok-w"> </span><span class="tok-k">in</span><span class="tok-w"> </span><span class="tok-n">input</span><span class="tok-p">.</span><span class="tok-n">attributes</span><span class="tok-p">.</span><span class="tok-n">iter</span><span class="tok-p">().</span><span class="tok-n">map</span><span class="tok-p">(</span><span class="tok-o">|</span><span class="tok-n">attr</span><span class="tok-o">|</span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-n">attr</span><span class="tok-p">.</span><span class="tok-n">key</span><span class="tok-p">.</span><span class="tok-n">clone</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">})</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-n">attributes</span><span class="tok-p">.</span><span class="tok-n">insert</span><span class="tok-p">(</span><span class="tok-n">key</span><span class="tok-p">.</span><span class="tok-n">clone</span><span class="tok-p">(),</span><span class="tok-w"> </span><span class="tok-n">input</span><span class="tok-p">.</span><span class="tok-n">get_attribute</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">key</span><span class="tok-p">).</span><span class="tok-n">unwrap</span><span class="tok-p">().</span><span class="tok-n">to_string</span><span class="tok-p">());</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_snippets_in_der_datenbank_speichern">Snippets in der Datenbank speichern</h5>
<div class="paragraph">
<p>Ist ein Snippet aus dem AST herausgefiltert worden, können wir es in der
Datenbank abspeichern.</p>
</div>
<div id="store_snippet_in_internal_db" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-n">snippets</span><span class="tok-p">.</span><span class="tok-n">store</span><span class="tok-p">(</span>
<span class="tok-w">  </span><span class="tok-n">id</span><span class="tok-p">.</span><span class="tok-n">to_string</span><span class="tok-p">(),</span>
<span class="tok-w">  </span><span class="tok-n">Snippet</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">kind</span><span class="tok-p">,</span>
<span class="tok-w">    </span><span class="tok-n">content</span>: <span class="tok-nc">content</span><span class="tok-p">.</span><span class="tok-n">to_string</span><span class="tok-p">(),</span>
<span class="tok-w">    </span><span class="tok-n">raw_content</span>: <span class="tok-nc">content</span><span class="tok-p">.</span><span class="tok-n">to_string</span><span class="tok-p">(),</span>
<span class="tok-w">    </span><span class="tok-n">children</span>: <span class="tok-nb">Vec</span>::<span class="tok-n">new</span><span class="tok-p">(),</span>
<span class="tok-w">    </span><span class="tok-n">depends_on</span>: <span class="tok-nc">dependencies</span><span class="tok-p">,</span>
<span class="tok-w">    </span><span class="tok-n">attributes</span><span class="tok-p">,</span>
<span class="tok-w">    </span><span class="tok-n">raw</span><span class="tok-p">,</span>
<span class="tok-w">  </span><span class="tok-p">},</span>
<span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Wir rufen dazu die interne Funktion <code>store</code> auf.</p>
</div>
<div id="snippet_db_functions" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-sd">/// Stores a snippet in the internal database</span>
<span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">fn</span> <span class="tok-nf">store</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-bp">self</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">name</span>: <span class="tok-nb">String</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">snippet</span>: <span class="tok-nc">Snippet</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">base</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-n">snippets</span><span class="tok-p">.</span><span class="tok-n">get_mut</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">name</span><span class="tok-p">);</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">  </span><span class="tok-k">match</span><span class="tok-w"> </span><span class="tok-n">base</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-nb">Some</span><span class="tok-p">(</span><span class="tok-n">base</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">      </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">base</span><span class="tok-p">.</span><span class="tok-n">children</span><span class="tok-p">.</span><span class="tok-n">len</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-mi">1</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">other</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">base</span><span class="tok-p">.</span><span class="tok-n">clone</span><span class="tok-p">();</span>
<span class="tok-w">        </span><span class="tok-o">&amp;</span><span class="tok-n">base</span><span class="tok-p">.</span><span class="tok-n">children</span><span class="tok-p">.</span><span class="tok-n">push</span><span class="tok-p">(</span><span class="tok-n">other</span><span class="tok-p">);</span>
<span class="tok-w">      </span><span class="tok-p">}</span>
<span class="tok-w">      </span><span class="tok-o">&lt;&lt;</span><span class="tok-n">copy_dependencies_to_base_snippet</span><span class="tok-o">&gt;&gt;</span>
<span class="tok-w">      </span><span class="tok-n">base</span><span class="tok-p">.</span><span class="tok-n">children</span><span class="tok-p">.</span><span class="tok-n">push</span><span class="tok-p">(</span><span class="tok-n">snippet</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-nb">None</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-w">      </span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-n">snippets</span><span class="tok-p">.</span><span class="tok-n">insert</span><span class="tok-p">(</span><span class="tok-n">name</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">snippet</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">  </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Zunächst wird geprüft, ob bereits ein Snippet mit dieser Id gespeichert
wurde.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Falls ja wird es an das Bestehende angehängt.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Falls nicht kann man es einfach abspeichern.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Der Schnipsel ist natürlich abhängig von allen Referenzen der Sub-Schnipsel. Deshalb müssen diese Abhängigkeiten in den Hauptschnipsel übertagen werden.</p>
</div>
<div id="copy_dependencies_to_base_snippet" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-n">dependency</span><span class="tok-w"> </span><span class="tok-k">in</span><span class="tok-w"> </span><span class="tok-n">snippet</span><span class="tok-p">.</span><span class="tok-n">depends_on</span><span class="tok-p">.</span><span class="tok-n">clone</span><span class="tok-p">().</span><span class="tok-n">into_iter</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-n">base</span><span class="tok-p">.</span><span class="tok-n">depends_on</span><span class="tok-p">.</span><span class="tok-n">push</span><span class="tok-p">(</span><span class="tok-n">dependency</span><span class="tok-p">);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_referenzen_in_einem_snippet_finden">Referenzen in einem Snippet finden</h3>
<div class="paragraph">
<p>Wir möchten, die referenzierten Snippets später einbinden. Dazu müssen sie
verarbeitet werden können, bevor das Snippet, welches sie verwendet, verarbeitet
wird. Aus diesem Grund parsen wir den (unverarbeiteten) Inhalt des Snippets.</p>
</div>
<div class="paragraph">
<p>Beim verwenden, müssen wir zunächst einmal sichergehen, dass das Snippet
überhaupt einen Inhalt definiert hat. Falls nicht gehen wir davon aus, dass es
leer ist.</p>
</div>
<div id="extract_attributes" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">content</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">input</span>
<span class="tok-w">  </span><span class="tok-p">.</span><span class="tok-n">get_attribute</span><span class="tok-p">(</span><span class="tok-s">&quot;content&quot;</span><span class="tok-p">)</span>
<span class="tok-w">  </span><span class="tok-p">.</span><span class="tok-n">unwrap_or</span><span class="tok-p">(</span><span class="tok-n">input</span><span class="tok-p">.</span><span class="tok-n">content</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div id="inline_extract_attributes" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">content</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">input</span>
<span class="tok-w">  </span><span class="tok-p">.</span><span class="tok-n">get_attribute</span><span class="tok-p">(</span><span class="tok-s">&quot;content&quot;</span><span class="tok-p">)</span>
<span class="tok-w">  </span><span class="tok-p">.</span><span class="tok-n">unwrap_or</span><span class="tok-p">(</span><span class="tok-n">input</span><span class="tok-p">.</span><span class="tok-n">content</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Um die Referenzen zu finden verwenden wir die
<a href="https://pest.rs/">Pest</a> Bibliothek. Sie basiert auf
<a href="https://en.wikipedia.org/wiki/Parsing_expression_grammar">Parsing
Expression Grammars</a> und wird bereits von
<a href="../asciidoctrine/asciidoctrine.html">asciidoctrine</a> verwendet. Diese
Art von Parsern ist (für mich) sehr leicht zu lesen und zu schreiben.</p>
</div>
<div id="required_crates" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-cp">#[macro_use]</span>
<span class="tok-k">extern</span><span class="tok-w"> </span><span class="tok-k">crate</span><span class="tok-w"> </span><span class="tok-n">pest_derive</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div id="cargo_dependencies" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="toml"><span></span><span class="tok-n">pest</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;2.1.0&quot;</span>
<span class="tok-n">pest_derive</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;2.1.0&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Wir lagern sie in ein eigenes Modul aus.</p>
</div>
<div id="internal_modules" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-k">mod</span> <span class="tok-nn">codeblock_parser</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/codeblock_parser.rs</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><div class="lineno"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span></pre></div></td><td class="code"><div><pre><span></span><span class="tok-k">use</span><span class="tok-w"> </span><span class="tok-n">pest</span>::<span class="tok-n">Parser</span><span class="tok-p">;</span>

<span class="tok-k">use</span><span class="tok-w"> </span><span class="tok-k">crate</span>::<span class="tok-o">*</span><span class="tok-p">;</span>

<span class="tok-cp">#[derive(Parser, Debug)]</span>
<span class="tok-cp">#[grammar = </span><span class="tok-s">&quot;codeblock.pest&quot;</span><span class="tok-cp">]</span>
<span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">struct</span> <span class="tok-nc">CodeblockParser</span><span class="tok-p">;</span>

<span class="tok-o">&lt;&lt;</span><span class="tok-n">codeblock_parser_internal_structs</span><span class="tok-o">&gt;&gt;</span>

<span class="tok-o">&lt;&lt;</span><span class="tok-n">codeblock_parser_functions</span><span class="tok-o">|</span><span class="tok-n">join</span><span class="tok-o">=</span><span class="tok-s">&quot;</span><span class="tok-se">\n\n</span><span class="tok-s">&quot;</span><span class="tok-o">&gt;&gt;</span>

<span class="tok-sd">/// Extracts the ids of used snippets from a depending snippet</span>
<span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">fn</span> <span class="tok-nf">get_dependencies</span><span class="tok-p">(</span><span class="tok-n">input</span>: <span class="tok-kp">&amp;</span><span class="tok-kt">str</span><span class="tok-p">)</span><span class="tok-w"> </span>-&gt; <span class="tok-nb">Vec</span><span class="tok-o">&lt;</span><span class="tok-nb">String</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-o">&lt;&lt;</span><span class="tok-n">get_dependencies</span><span class="tok-o">&gt;&gt;</span>
<span class="tok-p">}</span>

<span class="tok-sd">/// Merges the snippets into the depending snippet</span>
<span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">fn</span> <span class="tok-nf">merge_dependencies</span><span class="tok-p">(</span><span class="tok-n">input</span>: <span class="tok-kp">&amp;</span><span class="tok-kt">str</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">snippets</span>: <span class="tok-kp">&amp;</span><span class="tok-nc">SnippetDB</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">key</span>: <span class="tok-kp">&amp;</span><span class="tok-kt">str</span><span class="tok-p">)</span><span class="tok-w"> </span>-&gt; <span class="tok-nb">String</span> <span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-o">&lt;&lt;</span><span class="tok-n">merge_dependencies</span><span class="tok-o">&gt;&gt;</span>
<span class="tok-p">}</span>
</pre></div></td></tr></table></div></code></pre>
</div>
</div>
<div class="paragraph">
<p>Sie hat zwei wichtige Funktionen:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">get_dependencies</dt>
<dd>
<p>Parsed einen Snippet und gibt alle intern definierten
Referenzen zurück.</p>
</dd>
<dt class="hdlist1">merge_dependencies</dt>
<dd>
<p>Fügt an den Stellen der Referenzen die tatsächlichen
Inhalte ein. Wir verwenden sie später im Abschnitt Ausgaben erzeugen (TODO
link).</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Zu Beginn bindet das Modul die Parserdatei ein. Ein Codeblock besteht aus ein
paar wesentlichen Elementen.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Code</dt>
<dd>
<p>Dieser wird später vom Compilier oder Interpreter verarbeitet und <code>lisi</code>
muss ihn nicht verändern.</p>
</dd>
<dt class="hdlist1">Referenzen</dt>
<dd>
<p>Enthalten Verweise auf andere Snippets.</p>
</dd>
<dt class="hdlist1">Eingerückte Referenzen</dt>
<dd>
<p>Ist eine Referenz eingerückt, so wollen wir, dass jede
Zeile des eingefügten Snippets ebenfalls eingerückt wird. Ansonsten wäre der
generierte Code nicht schön formattiert.</p>
</dd>
<dt class="hdlist1">Kommentaren</dt>
<dd>
<p>Diese Kommentare sind nur für die Anzeige in Asciidoc gedacht und
sollen später nicht im generierten Quelltext vorhanden sein.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">src/codeblock.pest</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="pest"><div class="lineno"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span>codeblock = _{ (code | indented_reference | reference | comment)* ~ EOI }

reference = { &lt;&lt;reference&gt;&gt; }
indented_reference = { &lt;&lt;indented_reference&gt;&gt; }
code = { &lt;&lt;code_gramma&gt;&gt; }
comment = { &lt;&lt;comment&gt;&gt; }

&lt;&lt;internal_gramma_elements&gt;&gt;
</pre></div></td></tr></table></div></code></pre>
</div>
</div>
<div class="paragraph">
<p>Eine Referenz wird durch eine von doppelten spitzen Klammern umrahmten
id dargestellt. Es ist möglich auch noch Attribute mit zu übergeben um
die Art, wie der Schnipsel eingebunden wird zu modifizieren.</p>
</div>
<div id="reference" class="listingblock">
<div class="title">reference</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="pest"><span></span>&quot;&lt;&lt;&quot; ~ identifier ~ (empty ~ &quot;|&quot; ~ empty ~ attributes)? ~ &quot;&gt;&gt;&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wobei eine id nur aus ASCII Buchstaben, Unterstrich und
Verbindungsstrich bestehen darf. Zudem darf sie nicht mit einem
Verbindungsstrich beginnen, um nicht den wie eine Minus Expression zu
wirken (und damit Verwirrung zu stiften).</p>
</div>
<div id="internal_gramma_elements" class="listingblock">
<div class="title">identifier</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="pest"><span></span>identifier = @{ (ASCII_ALPHANUMERIC | &quot;_&quot;) ~ (ASCII_ALPHANUMERIC | &quot;_&quot; | &quot;-&quot; )* }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Attribute bestehen aus einem Namen und dem dazugehörigen Inhalt (oder
Wert) die durch ein <code>=</code> Zeichen verbunden werden. Der Name ist eine Id
und der Inhalt wird in Hochkommata (") eingerahmt. Es können beliebig
viele Attribute übergeben werden. Diese müssen durch Kommas getrennt
werden. Es können aber auch Snippet Parameter als Inhalt übergeben
werden. In diesem Fall wird <code>:=</code> als Zuweisungszeichen verwendet. Als
Parameter können entweder normale Inhalte in Hochkommata übergeben
werden oder (beliebig tief geschachtelte) Referenzen.</p>
</div>
<div id="internal_gramma_elements" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="pest"><span></span>attributes = { (attribute | attribute_param) ~ empty
  ~ (&quot;,&quot; ~ empty ~ (attribute | attribute_param) ~ empty)* }
attribute = { identifier ~ &quot;=&quot; ~ &quot;\&quot;&quot; ~ value ~ &quot;\&quot;&quot; }
attribute_param = { identifier ~ empty ~ &quot;:=&quot; ~ empty
  ~ ((&quot;\&quot;&quot; ~ value ~ &quot;\&quot;&quot;) | reference) }
value = @{ ( !&quot;\&quot;&quot; ~ ANY | &quot;\\\&quot;&quot;)* }</code></pre>
</div>
</div>
<div id="codeblock_parser_internal_structs" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-cp">#[derive(Debug, Clone)]</span>
<span class="tok-k">enum</span> <span class="tok-nc">ReferenceParam</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-n">Value</span><span class="tok-p">(</span><span class="tok-nb">String</span><span class="tok-p">),</span>
<span class="tok-w">  </span><span class="tok-n">Reference</span><span class="tok-p">(</span><span class="tok-nb">String</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-nb">String</span><span class="tok-p">),</span>
<span class="tok-p">}</span>

<span class="tok-k">type</span> <span class="tok-nc">SnippetParams</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">Vec</span><span class="tok-o">&lt;</span><span class="tok-n">HashMap</span><span class="tok-o">&lt;</span><span class="tok-nb">String</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">ReferenceParam</span><span class="tok-o">&gt;&gt;</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Bei einer eingerückten Referenz definieren wir die Einrückung seperat um sie
später (TODO link) wiederverwenden zu können.</p>
</div>
<div id="indented_reference" class="listingblock">
<div class="title">Eingerückte Referenz</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="pest"><span></span>(SOI | NEWLINE) ~ indentation ~ reference</code></pre>
</div>
</div>
<div id="internal_gramma_elements" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="pest"><span></span>whitespace = @{ (&quot; &quot; | &quot;\t&quot;) }
indentation = @{ whitespace+ }
empty = @{ (&quot; &quot; | &quot;\t&quot; | &quot;\n&quot; | &quot;\r&quot;)* }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Als Quellcode betrachten wir alles, was keine Referenz und kein Kommentar ist.</p>
</div>
<div id="code_gramma" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="pest"><span></span>(!indented_reference ~ !reference ~ !comment ~ ANY)+</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ein Kommentar ist ein typischer Kommentarbeginn zusammen mit einem Callout (TODO
link auf asciidoctor oder asciidoctrine Dokumentation).</p>
</div>
<div id="comment" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="pest"><span></span>optspaces ~ (&quot;//&quot; | &quot;#&quot; | &quot;;;&quot; ) ~ optspaces ~ &quot;&lt;&quot; ~ ASCII_DIGIT+ ~ &quot;&gt;&quot; ~ optspaces ~ &amp;(EOI | NEWLINE)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Dabei dürfen whitespaces zwischen den Elementen vorkommen</p>
</div>
<div id="internal_gramma_elements" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="pest"><span></span>optspaces = @{ whitespace* }</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_snippets_zusammenfügen">Snippets zusammenfügen</h3>
<div class="paragraph">
<p>Bevor die Snippets verwendet werden, müssen alle Referenzen durch die
tatsächlichen Inhalte ersetzt werden. Dazu benutzen wir die Funktion
<code>merge_dependencies</code> (TODO link).</p>
</div>
<div id="merge_snippet_content" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-n">snippet</span><span class="tok-p">.</span><span class="tok-n">children</span><span class="tok-p">.</span><span class="tok-n">len</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">children</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">Vec</span>::<span class="tok-n">new</span><span class="tok-p">();</span>
<span class="tok-w">  </span><span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">child</span><span class="tok-w"> </span><span class="tok-k">in</span><span class="tok-w"> </span><span class="tok-n">snippet</span><span class="tok-p">.</span><span class="tok-n">children</span><span class="tok-p">.</span><span class="tok-n">into_iter</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">content</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">child</span><span class="tok-p">.</span><span class="tok-n">content</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">content</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">codeblock_parser</span>::<span class="tok-n">merge_dependencies</span><span class="tok-p">(</span><span class="tok-n">content</span><span class="tok-p">.</span><span class="tok-n">as_str</span><span class="tok-p">(),</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">snippets</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">key</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-n">child</span><span class="tok-p">.</span><span class="tok-n">content</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">content</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-n">children</span><span class="tok-p">.</span><span class="tok-n">push</span><span class="tok-p">(</span><span class="tok-n">child</span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-p">}</span>
<span class="tok-w">  </span><span class="tok-n">snippet</span><span class="tok-p">.</span><span class="tok-n">children</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">children</span><span class="tok-p">;</span>
<span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">else</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">content</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">snippet</span><span class="tok-p">.</span><span class="tok-n">content</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">content</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">codeblock_parser</span>::<span class="tok-n">merge_dependencies</span><span class="tok-p">(</span><span class="tok-n">content</span><span class="tok-p">.</span><span class="tok-n">as_str</span><span class="tok-p">(),</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">snippets</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">key</span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-n">snippet</span><span class="tok-p">.</span><span class="tok-n">content</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">content</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In dieser Funktion wird ein String erzeugt, die Referenzen im Snippet durch den
tatsächlichen Inhalt ersetzt.</p>
</div>
<div id="merge_dependencies" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">ast</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">CodeblockParser</span>::<span class="tok-n">parse</span><span class="tok-p">(</span><span class="tok-n">Rule</span>::<span class="tok-n">codeblock</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">input</span><span class="tok-p">).</span><span class="tok-n">expect</span><span class="tok-p">(</span><span class="tok-s">&quot;couldn&#39;t parse input.&quot;</span><span class="tok-p">);</span>
<span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">snippet_params</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">extract_snippet_params</span><span class="tok-p">(</span><span class="tok-nb">Vec</span>::<span class="tok-n">from</span><span class="tok-p">([</span><span class="tok-n">HashMap</span>::<span class="tok-n">default</span><span class="tok-p">()]),</span><span class="tok-w"> </span><span class="tok-n">input</span><span class="tok-p">);</span>

<span class="tok-n">merge_dependencies_inner</span><span class="tok-p">(</span><span class="tok-n">ast</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">snippets</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">snippet_params</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">key</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div id="codeblock_parser_functions" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-k">fn</span> <span class="tok-nf">merge_dependencies_inner</span><span class="tok-o">&lt;&#39;</span><span class="tok-na">a</span><span class="tok-o">&gt;</span><span class="tok-p">(</span>
<span class="tok-w">  </span><span class="tok-n">ast</span>: <span class="tok-nc">pest</span>::<span class="tok-n">iterators</span>::<span class="tok-n">Pairs</span><span class="tok-o">&lt;&#39;</span><span class="tok-na">a</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">codeblock_parser</span>::<span class="tok-n">Rule</span><span class="tok-o">&gt;</span><span class="tok-p">,</span>
<span class="tok-w">  </span><span class="tok-n">snippets</span>: <span class="tok-kp">&amp;</span><span class="tok-nc">SnippetDB</span><span class="tok-p">,</span>
<span class="tok-w">  </span><span class="tok-n">snippet_params</span>: <span class="tok-nc">SnippetParams</span><span class="tok-p">,</span>
<span class="tok-w">  </span><span class="tok-n">key</span>: <span class="tok-kp">&amp;</span><span class="tok-kt">str</span><span class="tok-p">,</span>
<span class="tok-p">)</span><span class="tok-w"> </span>-&gt; <span class="tok-nb">String</span> <span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">output</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">String</span>::<span class="tok-n">new</span><span class="tok-p">();</span>

<span class="tok-w">  </span><span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-n">element</span><span class="tok-w"> </span><span class="tok-k">in</span><span class="tok-w"> </span><span class="tok-n">ast</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-k">match</span><span class="tok-w"> </span><span class="tok-n">element</span><span class="tok-p">.</span><span class="tok-n">as_rule</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">      </span><span class="tok-n">Rule</span>::<span class="tok-n">reference</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-o">&lt;&lt;</span><span class="tok-n">get_modified_snippet</span><span class="tok-o">&gt;&gt;</span>
<span class="tok-w">      </span><span class="tok-p">}</span>
<span class="tok-w">      </span><span class="tok-n">Rule</span>::<span class="tok-n">indented_reference</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">indented_output</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">String</span>::<span class="tok-n">new</span><span class="tok-p">();</span>
<span class="tok-w">        </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">indentation</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">extract_indentation</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">element</span><span class="tok-p">);</span>
<span class="tok-w">        </span><span class="tok-o">&lt;&lt;</span><span class="tok-n">get_modified_snippet</span><span class="tok-o">|</span>
<span class="tok-w">            </span><span class="tok-n">output_variable</span><span class="tok-w"> </span>:<span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-o">&lt;&lt;</span><span class="tok-n">indented_output</span><span class="tok-o">&gt;&gt;&gt;&gt;</span>
<span class="tok-w">        </span><span class="tok-n">indent</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">indented_output</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">indentation</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">output</span><span class="tok-p">);</span><span class="tok-w"> </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">      </span><span class="tok-p">}</span>
<span class="tok-w">      </span><span class="tok-n">Rule</span>::<span class="tok-n">code</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">output</span><span class="tok-p">.</span><span class="tok-n">push_str</span><span class="tok-p">(</span><span class="tok-n">element</span><span class="tok-p">.</span><span class="tok-n">as_str</span><span class="tok-p">());</span>
<span class="tok-w">      </span><span class="tok-p">}</span>
<span class="tok-w">      </span><span class="tok-n">_</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">(),</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">  </span><span class="tok-p">}</span>
<span class="tok-w">  </span><span class="tok-n">output</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Bei eingerückten Referenzen muss zusätzlich jede Zeile des Inhalts
eingerückt werden. Deswegen wird statt <a id="output_variable"></a><code>output</code>
zunächst <a id="indented_output"></a><code>indented_output</code> verwendet.</td>
</tr>
</table>
</div>
<div id="get_modified_snippet" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">key</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">element</span><span class="tok-p">.</span><span class="tok-n">as_str</span><span class="tok-p">().</span><span class="tok-n">trim_start</span><span class="tok-p">();</span>
<span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">identifier</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">extract_identifier</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">element</span><span class="tok-p">);</span>
<span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">join_str</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">extract_join_str</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">element</span><span class="tok-p">).</span><span class="tok-n">replace</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-se">\\</span><span class="tok-s">n&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\n</span><span class="tok-s">&quot;</span><span class="tok-p">);</span>

<span class="tok-n">substitude_params</span><span class="tok-p">(</span>
<span class="tok-w">  </span><span class="tok-n">identifier</span><span class="tok-p">,</span>
<span class="tok-w">  </span><span class="tok-n">snippets</span><span class="tok-p">,</span>
<span class="tok-w">  </span><span class="tok-n">snippet_params</span><span class="tok-p">.</span><span class="tok-n">clone</span><span class="tok-p">(),</span>
<span class="tok-w">  </span><span class="tok-o">&amp;</span><span class="tok-n">join_str</span><span class="tok-p">,</span>
<span class="tok-w">  </span><span class="tok-n">key</span><span class="tok-p">,</span>
<span class="tok-w">  </span><span class="tok-o">&amp;</span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-o">&lt;&lt;</span><span class="tok-n">output_variable</span><span class="tok-o">&gt;&gt;</span><span class="tok-p">,</span>
<span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Das einsetzen der Snippets läuft immer etwa gleich ab: Entweder es
gibt einen Parameter welcher ersetzt werden muss oder man ersetzt die
Referenzen durch Snippets aus der Datenbank.</p>
</div>
<div id="codeblock_parser_functions" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-k">fn</span> <span class="tok-nf">substitude_params</span><span class="tok-p">(</span>
<span class="tok-w">  </span><span class="tok-n">identifier</span>: <span class="tok-kp">&amp;</span><span class="tok-kt">str</span><span class="tok-p">,</span>
<span class="tok-w">  </span><span class="tok-n">snippets</span>: <span class="tok-kp">&amp;</span><span class="tok-nc">SnippetDB</span><span class="tok-p">,</span>
<span class="tok-w">  </span><span class="tok-n">snippet_params_history</span>: <span class="tok-nc">SnippetParams</span><span class="tok-p">,</span>
<span class="tok-w">  </span><span class="tok-n">join_str</span>: <span class="tok-kp">&amp;</span><span class="tok-kt">str</span><span class="tok-p">,</span>
<span class="tok-w">  </span><span class="tok-n">key</span>: <span class="tok-kp">&amp;</span><span class="tok-kt">str</span><span class="tok-p">,</span>
<span class="tok-w">  </span><span class="tok-n">output</span>: <span class="tok-kp">&amp;</span><span class="tok-nc">mut</span><span class="tok-w"> </span><span class="tok-nb">String</span><span class="tok-p">,</span>
<span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">snippet_params_history</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">snippet_params_history</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">snippet_params</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">snippet_params_history</span><span class="tok-p">.</span><span class="tok-n">pop</span><span class="tok-p">().</span><span class="tok-n">unwrap_or_default</span><span class="tok-p">();</span>

<span class="tok-w">  </span><span class="tok-k">match</span><span class="tok-w"> </span><span class="tok-n">snippet_params</span><span class="tok-p">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">identifier</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-nb">Some</span><span class="tok-p">(</span><span class="tok-n">param</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-k">match</span><span class="tok-w"> </span><span class="tok-n">param</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">      </span><span class="tok-n">ReferenceParam</span>::<span class="tok-n">Value</span><span class="tok-p">(</span><span class="tok-n">param</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-n">output</span><span class="tok-p">.</span><span class="tok-n">push_str</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">param</span><span class="tok-p">),</span>
<span class="tok-w">      </span><span class="tok-n">ReferenceParam</span>::<span class="tok-n">Reference</span><span class="tok-p">(</span><span class="tok-n">param</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">subparams</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-o">&lt;&lt;</span><span class="tok-n">use_snippet_parameter</span><span class="tok-o">&gt;&gt;</span>
<span class="tok-w">      </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-nb">None</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-k">match</span><span class="tok-w"> </span><span class="tok-n">snippets</span><span class="tok-p">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">identifier</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">      </span><span class="tok-o">&lt;&lt;</span><span class="tok-n">use_snippet_from_database</span><span class="tok-o">&gt;&gt;</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">  </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Wenn es einen Parameter gibt und der Parameter eine Referenz ist,
versuchen wir diese Referenz herauszusuchen. Das ist im Grunde die
gleiche Prozedur die wir bis jetzt auch schon angewendet haben. Die
Funktion kann also sich selbst aufrufen.</p>
</div>
<div class="paragraph">
<p>Dabei müssen wir einiges beachten:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Zunächst müssen wir sicher gehen, dass der Name des Parameters nicht
der gleiche ist, wie die Referenz. Ansonsten würde sich die Funktion
endlos selbst aufrufen.</p>
<div class="ulist">
<ul>
<li>
<p>Falls der Parameter identisch ist, durchsuchen wir die
Aufrufhierarchie um zu überprüfen, ob einer der aufrufenden Snippets
den Parameter definert hat.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Außerdem haben Referenzen manchmal eigene Parameter. Diese müssen wir
ebenfalls auslesen.</p>
</li>
</ul>
</div>
<div id="use_snippet_parameter" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-n">param</span><span class="tok-w"> </span><span class="tok-o">!=</span><span class="tok-w"> </span><span class="tok-n">identifier</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-n">snippet_params_history</span><span class="tok-p">.</span><span class="tok-n">push</span><span class="tok-p">(</span><span class="tok-n">snippet_params</span><span class="tok-p">.</span><span class="tok-n">clone</span><span class="tok-p">());</span>
<span class="tok-p">}</span>
<span class="tok-n">substitude_params</span><span class="tok-p">(</span>
<span class="tok-w">  </span><span class="tok-o">&amp;</span><span class="tok-n">param</span><span class="tok-p">,</span>
<span class="tok-w">  </span><span class="tok-n">snippets</span><span class="tok-p">,</span>
<span class="tok-w">  </span><span class="tok-n">snippet_params_history</span><span class="tok-p">,</span>
<span class="tok-w">  </span><span class="tok-n">join_str</span><span class="tok-p">,</span>
<span class="tok-w">  </span><span class="tok-o">&amp;</span><span class="tok-n">subparams</span><span class="tok-p">,</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">  </span><span class="tok-n">output</span><span class="tok-p">,</span>
<span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Beim extrahieren der Parameter verwenden wir im Fall einer Referenz
die beim Aufruf festgelegten Parameter.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Wenn der Snippet aus der Datenbank übernommen wird, gibt es zwei
Möglichkeiten:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Wenn er vorhanden ist können wir ihn einfach übernehmen (und natürlich
die Parameter ersetzen)</p>
</li>
<li>
<p>Wenn er nicht vorhanden ist, prüfen wir, ob Parameter in einer
Referenz übergeben wurden. Falls ja, übernehmen wir diese. Falls
nicht, geben wir eine Warnung aus und lassen den Snippet leer.</p>
</li>
</ul>
</div>
<div id="use_snippet_from_database" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-nb">Some</span><span class="tok-p">(</span><span class="tok-n">snippet</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">SnippetType</span>::<span class="tok-n">Pipe</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">snippet</span><span class="tok-p">.</span><span class="tok-n">kind</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">warn</span><span class="tok-o">!</span><span class="tok-p">(</span><span class="tok-s">&quot;depends on pipe snippet {}&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">identifier</span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-p">}</span>

<span class="tok-w">  </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">input</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">snippet</span><span class="tok-p">.</span><span class="tok-n">get_raw_content</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">join_str</span><span class="tok-p">);</span>

<span class="tok-w">  </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">content</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-n">snippet</span><span class="tok-p">.</span><span class="tok-n">raw</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">input</span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">else</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">ast</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">CodeblockParser</span>::<span class="tok-n">parse</span><span class="tok-p">(</span><span class="tok-n">Rule</span>::<span class="tok-n">codeblock</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">input</span><span class="tok-p">).</span><span class="tok-n">expect</span><span class="tok-p">(</span><span class="tok-s">&quot;couldn&#39;t parse input.&quot;</span><span class="tok-p">);</span>

<span class="tok-w">    </span><span class="tok-n">snippet_params_history</span><span class="tok-p">.</span><span class="tok-n">push</span><span class="tok-p">(</span><span class="tok-n">snippet_params</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">snippet_params</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">extract_snippet_params</span><span class="tok-p">(</span><span class="tok-n">snippet_params_history</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">key</span><span class="tok-p">);</span>

<span class="tok-w">    </span><span class="tok-n">merge_dependencies_inner</span><span class="tok-p">(</span><span class="tok-n">ast</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">snippets</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">snippet_params</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">key</span><span class="tok-p">)</span>
<span class="tok-w">  </span><span class="tok-p">};</span>
<span class="tok-w">  </span><span class="tok-n">output</span><span class="tok-p">.</span><span class="tok-n">push_str</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">content</span><span class="tok-p">);</span>
<span class="tok-p">}</span>
<span class="tok-nb">None</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-n">snippet_params_history</span><span class="tok-p">.</span><span class="tok-n">pop</span><span class="tok-p">();</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">  </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-nb">Some</span><span class="tok-p">(</span><span class="tok-n">params</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">snippet_params_history</span><span class="tok-p">.</span><span class="tok-n">pop</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-n">params</span><span class="tok-p">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">identifier</span><span class="tok-p">).</span><span class="tok-n">is_some</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">      </span><span class="tok-n">snippet_params_history</span><span class="tok-p">.</span><span class="tok-n">push</span><span class="tok-p">(</span><span class="tok-n">params</span><span class="tok-p">);</span>
<span class="tok-w">      </span><span class="tok-n">substitude_params</span><span class="tok-p">(</span>
<span class="tok-w">        </span><span class="tok-n">identifier</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-n">snippets</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-n">snippet_params_history</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-n">join_str</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-n">key</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-n">output</span><span class="tok-p">,</span>
<span class="tok-w">      </span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">else</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">      </span><span class="tok-n">warn</span><span class="tok-o">!</span><span class="tok-p">(</span>
<span class="tok-w">        </span><span class="tok-s">&quot;Couldn&#39;t find snippet dependency `{}` for `{}`&quot;</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-n">identifier</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">key</span>
<span class="tok-w">      </span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">else</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">warn</span><span class="tok-o">!</span><span class="tok-p">(</span>
<span class="tok-w">      </span><span class="tok-s">&quot;Couldn&#39;t find snippet dependency `{}` for `{}`&quot;</span><span class="tok-p">,</span>
<span class="tok-w">      </span><span class="tok-n">identifier</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">key</span>
<span class="tok-w">    </span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Parameter wurden oft in der vorigen Ebene übergeben. Deshalb gehen
wir in der Historie einen Schritt zurück um zu schauen, ob welche
übergeben wurden.</td>
</tr>
</table>
</div>
<div id="codeblock_parser_functions" class="listingblock">
<div class="title">extract_identifier und extract_indentation</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-k">fn</span> <span class="tok-nf">extract_identifier</span><span class="tok-o">&lt;&#39;</span><span class="tok-na">a</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">element</span>: <span class="tok-kp">&amp;</span><span class="tok-nc">pest</span>::<span class="tok-n">iterators</span>::<span class="tok-n">Pair</span><span class="tok-o">&lt;&#39;</span><span class="tok-na">a</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">codeblock_parser</span>::<span class="tok-n">Rule</span><span class="tok-o">&gt;</span><span class="tok-p">)</span><span class="tok-w"> </span>-&gt; <span class="tok-kp">&amp;</span><span class="tok-o">&#39;</span><span class="tok-na">a</span> <span class="tok-kt">str</span> <span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-k">match</span><span class="tok-w"> </span><span class="tok-n">element</span><span class="tok-p">.</span><span class="tok-n">as_rule</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">Rule</span>::<span class="tok-n">reference</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-n">element</span><span class="tok-p">.</span><span class="tok-n">clone</span><span class="tok-p">().</span><span class="tok-n">into_inner</span><span class="tok-p">().</span><span class="tok-n">next</span><span class="tok-p">().</span><span class="tok-n">unwrap</span><span class="tok-p">().</span><span class="tok-n">as_str</span><span class="tok-p">(),</span>
<span class="tok-w">    </span><span class="tok-n">Rule</span>::<span class="tok-n">indented_reference</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">      </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">output</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;&quot;</span><span class="tok-p">;</span>
<span class="tok-w">      </span><span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-n">element</span><span class="tok-w"> </span><span class="tok-k">in</span><span class="tok-w"> </span><span class="tok-n">element</span><span class="tok-p">.</span><span class="tok-n">clone</span><span class="tok-p">().</span><span class="tok-n">into_inner</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-k">match</span><span class="tok-w"> </span><span class="tok-n">element</span><span class="tok-p">.</span><span class="tok-n">as_rule</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">          </span><span class="tok-n">Rule</span>::<span class="tok-n">reference</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-n">output</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">element</span><span class="tok-p">.</span><span class="tok-n">into_inner</span><span class="tok-p">().</span><span class="tok-n">next</span><span class="tok-p">().</span><span class="tok-n">unwrap</span><span class="tok-p">().</span><span class="tok-n">as_str</span><span class="tok-p">();</span>
<span class="tok-w">            </span><span class="tok-k">break</span><span class="tok-p">;</span>
<span class="tok-w">          </span><span class="tok-p">}</span>
<span class="tok-w">          </span><span class="tok-n">_</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">(),</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">      </span><span class="tok-p">}</span>
<span class="tok-w">      </span><span class="tok-n">output</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-n">_</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-s">&quot;&quot;</span><span class="tok-p">,</span>
<span class="tok-w">  </span><span class="tok-p">}</span>
<span class="tok-p">}</span>

<span class="tok-k">fn</span> <span class="tok-nf">extract_join_str</span><span class="tok-o">&lt;&#39;</span><span class="tok-na">a</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">element</span>: <span class="tok-kp">&amp;</span><span class="tok-nc">pest</span>::<span class="tok-n">iterators</span>::<span class="tok-n">Pair</span><span class="tok-o">&lt;&#39;</span><span class="tok-na">a</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">codeblock_parser</span>::<span class="tok-n">Rule</span><span class="tok-o">&gt;</span><span class="tok-p">)</span><span class="tok-w"> </span>-&gt; <span class="tok-kp">&amp;</span><span class="tok-o">&#39;</span><span class="tok-na">a</span> <span class="tok-kt">str</span> <span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-k">match</span><span class="tok-w"> </span><span class="tok-n">element</span><span class="tok-p">.</span><span class="tok-n">as_rule</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">Rule</span>::<span class="tok-n">reference</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">      </span><span class="tok-k">match</span><span class="tok-w"> </span><span class="tok-n">element</span>
<span class="tok-w">        </span><span class="tok-p">.</span><span class="tok-n">clone</span><span class="tok-p">()</span>
<span class="tok-w">        </span><span class="tok-p">.</span><span class="tok-n">into_inner</span><span class="tok-p">()</span>
<span class="tok-w">        </span><span class="tok-p">.</span><span class="tok-n">find</span><span class="tok-p">(</span><span class="tok-o">|</span><span class="tok-n">element</span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-k">match</span><span class="tok-w"> </span><span class="tok-n">element</span><span class="tok-p">.</span><span class="tok-n">as_rule</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">          </span><span class="tok-n">Rule</span>::<span class="tok-n">attributes</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-kc">true</span><span class="tok-p">,</span>
<span class="tok-w">          </span><span class="tok-n">_</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-kc">false</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-p">})</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-nb">Some</span><span class="tok-p">(</span><span class="tok-n">element</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-n">extract_join_str</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">element</span><span class="tok-p">),</span>
<span class="tok-w">        </span><span class="tok-nb">None</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\n</span><span class="tok-s">&quot;</span><span class="tok-p">,</span>
<span class="tok-w">      </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-n">Rule</span>::<span class="tok-n">attributes</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">      </span><span class="tok-k">match</span><span class="tok-w"> </span><span class="tok-n">element</span>
<span class="tok-w">        </span><span class="tok-p">.</span><span class="tok-n">clone</span><span class="tok-p">()</span>
<span class="tok-w">        </span><span class="tok-p">.</span><span class="tok-n">into_inner</span><span class="tok-p">()</span>
<span class="tok-w">        </span><span class="tok-p">.</span><span class="tok-n">find</span><span class="tok-p">(</span><span class="tok-o">|</span><span class="tok-n">element</span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-k">match</span><span class="tok-w"> </span><span class="tok-n">element</span><span class="tok-p">.</span><span class="tok-n">as_rule</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">          </span><span class="tok-n">Rule</span>::<span class="tok-n">attribute</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">attribute</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">element</span><span class="tok-p">.</span><span class="tok-n">clone</span><span class="tok-p">().</span><span class="tok-n">into_inner</span><span class="tok-p">();</span>
<span class="tok-w">            </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">key</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">attribute</span><span class="tok-p">.</span><span class="tok-n">next</span><span class="tok-p">().</span><span class="tok-n">unwrap</span><span class="tok-p">();</span>

<span class="tok-w">            </span><span class="tok-n">key</span><span class="tok-p">.</span><span class="tok-n">as_str</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-s">&quot;join&quot;</span>
<span class="tok-w">          </span><span class="tok-p">}</span>
<span class="tok-w">          </span><span class="tok-n">_</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-kc">false</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-p">})</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-nb">Some</span><span class="tok-p">(</span><span class="tok-n">element</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">          </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">attribute</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">element</span><span class="tok-p">.</span><span class="tok-n">clone</span><span class="tok-p">().</span><span class="tok-n">into_inner</span><span class="tok-p">();</span>
<span class="tok-w">          </span><span class="tok-n">attribute</span><span class="tok-p">.</span><span class="tok-n">next</span><span class="tok-p">();</span>
<span class="tok-w">          </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">value</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">attribute</span><span class="tok-p">.</span><span class="tok-n">next</span><span class="tok-p">().</span><span class="tok-n">unwrap</span><span class="tok-p">();</span>

<span class="tok-w">          </span><span class="tok-n">value</span><span class="tok-p">.</span><span class="tok-n">as_str</span><span class="tok-p">()</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">        </span><span class="tok-nb">None</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\n</span><span class="tok-s">&quot;</span><span class="tok-p">,</span>
<span class="tok-w">      </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-n">Rule</span>::<span class="tok-n">indented_reference</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">      </span><span class="tok-k">match</span><span class="tok-w"> </span><span class="tok-n">element</span>
<span class="tok-w">        </span><span class="tok-p">.</span><span class="tok-n">clone</span><span class="tok-p">()</span>
<span class="tok-w">        </span><span class="tok-p">.</span><span class="tok-n">into_inner</span><span class="tok-p">()</span>
<span class="tok-w">        </span><span class="tok-p">.</span><span class="tok-n">find</span><span class="tok-p">(</span><span class="tok-o">|</span><span class="tok-n">element</span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-k">match</span><span class="tok-w"> </span><span class="tok-n">element</span><span class="tok-p">.</span><span class="tok-n">as_rule</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">          </span><span class="tok-n">Rule</span>::<span class="tok-n">reference</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-kc">true</span><span class="tok-p">,</span>
<span class="tok-w">          </span><span class="tok-n">_</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-kc">false</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-p">})</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-nb">Some</span><span class="tok-p">(</span><span class="tok-n">element</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-n">extract_join_str</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">element</span><span class="tok-p">),</span>
<span class="tok-w">        </span><span class="tok-nb">None</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\n</span><span class="tok-s">&quot;</span><span class="tok-p">,</span>
<span class="tok-w">      </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-n">_</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\n</span><span class="tok-s">&quot;</span><span class="tok-p">,</span>
<span class="tok-w">  </span><span class="tok-p">}</span>
<span class="tok-p">}</span>

<span class="tok-k">fn</span> <span class="tok-nf">extract_indentation</span><span class="tok-o">&lt;&#39;</span><span class="tok-na">a</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-n">element</span>: <span class="tok-kp">&amp;</span><span class="tok-nc">pest</span>::<span class="tok-n">iterators</span>::<span class="tok-n">Pair</span><span class="tok-o">&lt;&#39;</span><span class="tok-na">a</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">codeblock_parser</span>::<span class="tok-n">Rule</span><span class="tok-o">&gt;</span><span class="tok-p">)</span><span class="tok-w"> </span>-&gt; <span class="tok-kp">&amp;</span><span class="tok-o">&#39;</span><span class="tok-na">a</span> <span class="tok-kt">str</span> <span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">output</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;&quot;</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-n">element</span><span class="tok-w"> </span><span class="tok-k">in</span><span class="tok-w"> </span><span class="tok-n">element</span><span class="tok-p">.</span><span class="tok-n">clone</span><span class="tok-p">().</span><span class="tok-n">into_inner</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-k">match</span><span class="tok-w"> </span><span class="tok-n">element</span><span class="tok-p">.</span><span class="tok-n">as_rule</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">      </span><span class="tok-n">Rule</span>::<span class="tok-n">indentation</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">output</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">element</span><span class="tok-p">.</span><span class="tok-n">as_str</span><span class="tok-p">();</span>
<span class="tok-w">        </span><span class="tok-k">break</span><span class="tok-p">;</span>
<span class="tok-w">      </span><span class="tok-p">}</span>
<span class="tok-w">      </span><span class="tok-n">_</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">(),</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">  </span><span class="tok-p">}</span>
<span class="tok-w">  </span><span class="tok-n">output</span>
<span class="tok-p">}</span>

<span class="tok-k">fn</span> <span class="tok-nf">indent</span><span class="tok-p">(</span><span class="tok-n">content</span>: <span class="tok-kp">&amp;</span><span class="tok-kt">str</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">indentation</span>: <span class="tok-kp">&amp;</span><span class="tok-kt">str</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">output</span>: <span class="tok-kp">&amp;</span><span class="tok-nc">mut</span><span class="tok-w"> </span><span class="tok-nb">String</span><span class="tok-p">)</span><span class="tok-w"> </span>-&gt; <span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-n">line</span><span class="tok-w"> </span><span class="tok-k">in</span><span class="tok-w"> </span><span class="tok-n">content</span><span class="tok-p">.</span><span class="tok-n">lines</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">output</span><span class="tok-p">.</span><span class="tok-n">push_str</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-se">\n</span><span class="tok-s">&quot;</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-n">output</span><span class="tok-p">.</span><span class="tok-n">push_str</span><span class="tok-p">(</span><span class="tok-n">indentation</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-n">output</span><span class="tok-p">.</span><span class="tok-n">push_str</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Wir müssen auch mögliche Parameter, welche beim Aufruf des Snippets
eventuell übergeben wurden, herausfiltern und abspeichern.</p>
</div>
<div id="codeblock_parser_functions" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-k">fn</span> <span class="tok-nf">extract_snippet_params</span><span class="tok-p">(</span><span class="tok-n">snippet_params_history</span>: <span class="tok-nc">SnippetParams</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">param</span>: <span class="tok-kp">&amp;</span><span class="tok-kt">str</span><span class="tok-p">)</span><span class="tok-w"> </span>-&gt; <span class="tok-nc">SnippetParams</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">snippet_params</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">snippet_params_history</span><span class="tok-p">.</span><span class="tok-n">clone</span><span class="tok-p">().</span><span class="tok-n">pop</span><span class="tok-p">().</span><span class="tok-n">unwrap_or_default</span><span class="tok-p">();</span>
<span class="tok-w">  </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">new_params</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">HashMap</span>::<span class="tok-n">default</span><span class="tok-p">();</span>
<span class="tok-w">  </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">ast</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">CodeblockParser</span>::<span class="tok-n">parse</span><span class="tok-p">(</span><span class="tok-n">Rule</span>::<span class="tok-n">codeblock</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">param</span><span class="tok-p">).</span><span class="tok-n">expect</span><span class="tok-p">(</span><span class="tok-s">&quot;couldn&#39;t parse input.&quot;</span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">snippet_params_history</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">snippet_params_history</span><span class="tok-p">;</span>

<span class="tok-w">  </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">ref_iter</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">ast</span><span class="tok-p">.</span><span class="tok-n">clone</span><span class="tok-p">().</span><span class="tok-n">filter</span><span class="tok-p">(</span><span class="tok-o">|</span><span class="tok-n">element</span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-k">match</span><span class="tok-w"> </span><span class="tok-n">element</span><span class="tok-p">.</span><span class="tok-n">as_rule</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">Rule</span>::<span class="tok-n">reference</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-kc">true</span><span class="tok-p">,</span>
<span class="tok-w">    </span><span class="tok-n">_</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-kc">false</span><span class="tok-p">,</span>
<span class="tok-w">  </span><span class="tok-p">});</span>
<span class="tok-w">  </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">indent_ref_iter</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">ast</span>
<span class="tok-w">    </span><span class="tok-p">.</span><span class="tok-n">clone</span><span class="tok-p">()</span>
<span class="tok-w">    </span><span class="tok-p">.</span><span class="tok-n">filter</span><span class="tok-p">(</span><span class="tok-o">|</span><span class="tok-n">element</span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-k">match</span><span class="tok-w"> </span><span class="tok-n">element</span><span class="tok-p">.</span><span class="tok-n">as_rule</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">      </span><span class="tok-n">Rule</span>::<span class="tok-n">indented_reference</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-kc">true</span><span class="tok-p">,</span>
<span class="tok-w">      </span><span class="tok-n">_</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-kc">false</span><span class="tok-p">,</span>
<span class="tok-w">    </span><span class="tok-p">})</span>
<span class="tok-w">    </span><span class="tok-p">.</span><span class="tok-n">flat_map</span><span class="tok-p">(</span><span class="tok-o">|</span><span class="tok-n">element</span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">element</span><span class="tok-p">.</span><span class="tok-n">clone</span><span class="tok-p">().</span><span class="tok-n">into_inner</span><span class="tok-p">())</span>
<span class="tok-w">    </span><span class="tok-p">.</span><span class="tok-n">filter</span><span class="tok-p">(</span><span class="tok-o">|</span><span class="tok-n">element</span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-k">match</span><span class="tok-w"> </span><span class="tok-n">element</span><span class="tok-p">.</span><span class="tok-n">as_rule</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">      </span><span class="tok-n">Rule</span>::<span class="tok-n">reference</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-kc">true</span><span class="tok-p">,</span>
<span class="tok-w">      </span><span class="tok-n">_</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-kc">false</span><span class="tok-p">,</span>
<span class="tok-w">    </span><span class="tok-p">});</span>

<span class="tok-w">  </span><span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-n">element</span><span class="tok-w"> </span><span class="tok-k">in</span><span class="tok-w"> </span><span class="tok-n">ref_iter</span><span class="tok-p">.</span><span class="tok-n">chain</span><span class="tok-p">(</span><span class="tok-n">indent_ref_iter</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-n">element</span><span class="tok-w"> </span><span class="tok-k">in</span><span class="tok-w"> </span><span class="tok-n">element</span>
<span class="tok-w">      </span><span class="tok-p">.</span><span class="tok-n">clone</span><span class="tok-p">()</span>
<span class="tok-w">      </span><span class="tok-p">.</span><span class="tok-n">into_inner</span><span class="tok-p">()</span>
<span class="tok-w">      </span><span class="tok-p">.</span><span class="tok-n">filter</span><span class="tok-p">(</span><span class="tok-o">|</span><span class="tok-n">element</span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-k">match</span><span class="tok-w"> </span><span class="tok-n">element</span><span class="tok-p">.</span><span class="tok-n">as_rule</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">Rule</span>::<span class="tok-n">attributes</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-kc">true</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-n">_</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-kc">false</span><span class="tok-p">,</span>
<span class="tok-w">      </span><span class="tok-p">})</span>
<span class="tok-w">      </span><span class="tok-p">.</span><span class="tok-n">flat_map</span><span class="tok-p">(</span><span class="tok-o">|</span><span class="tok-n">element</span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">element</span><span class="tok-p">.</span><span class="tok-n">clone</span><span class="tok-p">().</span><span class="tok-n">into_inner</span><span class="tok-p">())</span>
<span class="tok-w">      </span><span class="tok-p">.</span><span class="tok-n">filter</span><span class="tok-p">(</span><span class="tok-o">|</span><span class="tok-n">element</span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-k">match</span><span class="tok-w"> </span><span class="tok-n">element</span><span class="tok-p">.</span><span class="tok-n">as_rule</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">Rule</span>::<span class="tok-n">attribute_param</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-kc">true</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-n">_</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-kc">false</span><span class="tok-p">,</span>
<span class="tok-w">      </span><span class="tok-p">})</span>
<span class="tok-w">    </span><span class="tok-p">{</span>
<span class="tok-w">      </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">identifier</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">element</span>
<span class="tok-w">        </span><span class="tok-p">.</span><span class="tok-n">clone</span><span class="tok-p">()</span>
<span class="tok-w">        </span><span class="tok-p">.</span><span class="tok-n">into_inner</span><span class="tok-p">()</span>
<span class="tok-w">        </span><span class="tok-p">.</span><span class="tok-n">find</span><span class="tok-p">(</span><span class="tok-o">|</span><span class="tok-n">element</span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-k">match</span><span class="tok-w"> </span><span class="tok-n">element</span><span class="tok-p">.</span><span class="tok-n">as_rule</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">          </span><span class="tok-n">Rule</span>::<span class="tok-n">identifier</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-kc">true</span><span class="tok-p">,</span>
<span class="tok-w">          </span><span class="tok-n">_</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-kc">false</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-p">})</span>
<span class="tok-w">        </span><span class="tok-p">.</span><span class="tok-n">map</span><span class="tok-p">(</span><span class="tok-o">|</span><span class="tok-n">element</span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-n">element</span><span class="tok-p">.</span><span class="tok-n">as_str</span><span class="tok-p">().</span><span class="tok-n">to_string</span><span class="tok-p">())</span>
<span class="tok-w">        </span><span class="tok-p">.</span><span class="tok-n">unwrap</span><span class="tok-p">();</span>
<span class="tok-w">      </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">value</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">element</span>
<span class="tok-w">        </span><span class="tok-p">.</span><span class="tok-n">into_inner</span><span class="tok-p">()</span>
<span class="tok-w">        </span><span class="tok-p">.</span><span class="tok-n">find</span><span class="tok-p">(</span><span class="tok-o">|</span><span class="tok-n">element</span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-k">match</span><span class="tok-w"> </span><span class="tok-n">element</span><span class="tok-p">.</span><span class="tok-n">as_rule</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">          </span><span class="tok-n">Rule</span>::<span class="tok-n">value</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-kc">true</span><span class="tok-p">,</span>
<span class="tok-w">          </span><span class="tok-n">Rule</span>::<span class="tok-n">reference</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-kc">true</span><span class="tok-p">,</span>
<span class="tok-w">          </span><span class="tok-n">_</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-kc">false</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-p">})</span>
<span class="tok-w">        </span><span class="tok-p">.</span><span class="tok-n">map</span><span class="tok-p">(</span><span class="tok-o">|</span><span class="tok-n">element</span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-k">match</span><span class="tok-w"> </span><span class="tok-n">element</span><span class="tok-p">.</span><span class="tok-n">as_rule</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">          </span><span class="tok-n">Rule</span>::<span class="tok-n">value</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-nb">Some</span><span class="tok-p">(</span><span class="tok-n">ReferenceParam</span>::<span class="tok-n">Value</span><span class="tok-p">(</span><span class="tok-n">element</span><span class="tok-p">.</span><span class="tok-n">as_str</span><span class="tok-p">().</span><span class="tok-n">to_string</span><span class="tok-p">())),</span>
<span class="tok-w">          </span><span class="tok-n">Rule</span>::<span class="tok-n">reference</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-k">match</span><span class="tok-w"> </span><span class="tok-n">snippet_params</span><span class="tok-p">.</span><span class="tok-n">remove</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">identifier</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-nb">Some</span><span class="tok-p">(</span><span class="tok-n">param</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-nb">Some</span><span class="tok-p">(</span><span class="tok-n">param</span><span class="tok-p">),</span>
<span class="tok-w">            </span><span class="tok-nb">None</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">              </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">inner_params</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">element</span><span class="tok-p">.</span><span class="tok-n">as_str</span><span class="tok-p">().</span><span class="tok-n">to_string</span><span class="tok-p">();</span>
<span class="tok-w">              </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">identifier</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">extract_identifier</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">element</span><span class="tok-p">);</span>

<span class="tok-w">              </span><span class="tok-k">match</span><span class="tok-w"> </span><span class="tok-n">snippet_params</span><span class="tok-p">.</span><span class="tok-n">remove</span><span class="tok-p">(</span><span class="tok-n">identifier</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">                </span><span class="tok-nb">Some</span><span class="tok-p">(</span><span class="tok-n">param</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-nb">Some</span><span class="tok-p">(</span><span class="tok-n">param</span><span class="tok-p">),</span>
<span class="tok-w">                </span><span class="tok-nb">None</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-nb">Some</span><span class="tok-p">(</span><span class="tok-n">ReferenceParam</span>::<span class="tok-n">Reference</span><span class="tok-p">(</span>
<span class="tok-w">                  </span><span class="tok-n">identifier</span><span class="tok-p">.</span><span class="tok-n">to_string</span><span class="tok-p">(),</span>
<span class="tok-w">                  </span><span class="tok-n">inner_params</span><span class="tok-p">,</span>
<span class="tok-w">                </span><span class="tok-p">)),</span>
<span class="tok-w">              </span><span class="tok-p">}</span>
<span class="tok-w">            </span><span class="tok-p">}</span>
<span class="tok-w">          </span><span class="tok-p">},</span>
<span class="tok-w">          </span><span class="tok-n">_</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-nb">None</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-p">})</span>
<span class="tok-w">        </span><span class="tok-p">.</span><span class="tok-n">unwrap</span><span class="tok-p">();</span>

<span class="tok-w">      </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-nb">Some</span><span class="tok-p">(</span><span class="tok-n">value</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">value</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">new_params</span><span class="tok-p">.</span><span class="tok-n">insert</span><span class="tok-p">(</span><span class="tok-n">identifier</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">value</span><span class="tok-p">);</span>
<span class="tok-w">      </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">  </span><span class="tok-p">}</span>

<span class="tok-w">  </span><span class="tok-n">snippet_params_history</span><span class="tok-p">.</span><span class="tok-n">push</span><span class="tok-p">(</span><span class="tok-n">new_params</span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-n">snippet_params_history</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Hierfür müssen wir den Inhalt eines Snippets genereieren können.</p>
</div>
<div id="snippet_functions" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-k">fn</span> <span class="tok-nf">get_raw_content</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-bp">self</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">join_str</span>: <span class="tok-kp">&amp;</span><span class="tok-kt">str</span><span class="tok-p">)</span><span class="tok-w"> </span>-&gt; <span class="tok-nb">String</span> <span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-n">children</span><span class="tok-p">.</span><span class="tok-n">len</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-mi">0</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">iter</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-n">children</span><span class="tok-p">.</span><span class="tok-n">iter</span><span class="tok-p">();</span>
<span class="tok-w">    </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">start</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">iter</span><span class="tok-p">.</span><span class="tok-n">next</span><span class="tok-p">().</span><span class="tok-n">unwrap</span><span class="tok-p">().</span><span class="tok-n">raw_content</span><span class="tok-p">.</span><span class="tok-n">clone</span><span class="tok-p">();</span>
<span class="tok-w">    </span><span class="tok-n">iter</span><span class="tok-p">.</span><span class="tok-n">fold</span><span class="tok-p">(</span><span class="tok-n">start</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">|</span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">base</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">snippet</span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">      </span><span class="tok-n">base</span><span class="tok-p">.</span><span class="tok-n">push_str</span><span class="tok-p">(</span><span class="tok-n">join_str</span><span class="tok-p">);</span>
<span class="tok-w">      </span><span class="tok-n">base</span><span class="tok-p">.</span><span class="tok-n">push_str</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">snippet</span><span class="tok-p">.</span><span class="tok-n">raw_content</span><span class="tok-p">);</span>
<span class="tok-w">      </span><span class="tok-n">base</span>
<span class="tok-w">    </span><span class="tok-p">})</span>
<span class="tok-w">  </span><span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">else</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-n">raw_content</span><span class="tok-p">.</span><span class="tok-n">to_string</span><span class="tok-p">()</span>
<span class="tok-w">  </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="snippet_topo_sort">Die Verarbeitungsreihenfolge der Snippets festlegen</h3>
<div class="paragraph">
<p>Eines der wichtigsten Features von <code>lisi</code> (und das, welches, wie ich glaube, es am stärksten von vergleichbaren Tools unterscheidet), ist, dass man den <a href="#usage_control_flow">Kontrollfluss bestimmen kann</a>. Dadurch wird es in gewissem Sinne zu einer <a href="https://en.wikipedia.org/wiki/Dataflow_programming">Dataflow Sprache</a>.</p>
</div>
<div class="paragraph">
<p>Damit das möglich wird muss herausgefunden werden, welches Snippet verarbeitet werden kann, und welches von anderen abhängt, die vorher verarbeitet werden müssen. Dazu verwenden wir die <a href="https://en.wikipedia.org/wiki/Topological_sorting">Topoligical Sorting</a> Methode. Wir implementieren sie nicht selbst, sondern benutzen den <code>topological-sort</code> (TODO link) crate.</p>
</div>
<div id="cargo_dependencies" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="toml"><span></span><span class="tok-n">topological-sort</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;0.2&quot;</span></code></pre>
</div>
</div>
<div id="crate_usages" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-k">use</span><span class="tok-w"> </span><span class="tok-n">topological_sort</span>::<span class="tok-n">TopologicalSort</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Die entsprechende Klasse (Trait, wieauchimmer) nehmen wir in die internen
Variablen auf, denn es ergänzt unsere Snippet Datenbank (TODO link).</p>
</div>
<div id="lisi_internal_variables" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-n">dependencies</span>: <span class="tok-nc">TopologicalSort</span><span class="tok-o">&lt;</span><span class="tok-nb">String</span><span class="tok-o">&gt;</span><span class="tok-p">,</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Und initialisieren sie bei der Initialisierung der Lisi Struktur.</p>
</div>
<div id="lisi_init_variables" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-n">dependencies</span>: <span class="tok-nc">TopologicalSort</span>::<span class="tok-n">new</span><span class="tok-p">(),</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nachdem wir die Snippets in der Datenbank abgelegt haben gehen wir durch und
füllen unsere Sortierstruktur.</p>
</div>
<div id="internal_functions" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-sd">/// Builds the dependency tree for topological sorting</span>
<span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">fn</span> <span class="tok-nf">calculate_snippet_ordering</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-bp">self</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">snippets</span>: <span class="tok-kp">&amp;</span><span class="tok-nc">SnippetDB</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">key</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">snippet</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">in</span><span class="tok-w"> </span><span class="tok-n">snippets</span><span class="tok-p">.</span><span class="tok-n">iter</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-c1">// TODO Vielleicht sollten nur `save` und `eval` snippets</span>
<span class="tok-w">    </span><span class="tok-c1">// unabhängig von dependencies aufgenommen werden?</span>
<span class="tok-w">    </span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-n">dependencies</span><span class="tok-p">.</span><span class="tok-n">insert</span><span class="tok-p">(</span><span class="tok-n">key</span><span class="tok-p">);</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>

<span class="tok-w">    </span><span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-n">child</span><span class="tok-w"> </span><span class="tok-k">in</span><span class="tok-w"> </span><span class="tok-n">snippet</span><span class="tok-p">.</span><span class="tok-n">children</span><span class="tok-p">.</span><span class="tok-n">iter</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">      </span><span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-n">dependency</span><span class="tok-w"> </span><span class="tok-k">in</span><span class="tok-w"> </span><span class="tok-n">child</span><span class="tok-p">.</span><span class="tok-n">depends_on</span><span class="tok-p">.</span><span class="tok-n">iter</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-n">dependencies</span><span class="tok-p">.</span><span class="tok-n">add_dependency</span><span class="tok-p">(</span><span class="tok-n">dependency</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">key</span><span class="tok-p">);</span>
<span class="tok-w">      </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-n">dependency</span><span class="tok-w"> </span><span class="tok-k">in</span><span class="tok-w"> </span><span class="tok-n">snippet</span><span class="tok-p">.</span><span class="tok-n">depends_on</span><span class="tok-p">.</span><span class="tok-n">iter</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">      </span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-n">dependencies</span><span class="tok-p">.</span><span class="tok-n">add_dependency</span><span class="tok-p">(</span><span class="tok-n">dependency</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">key</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">  </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Jedes Snippet muss in die Sortierung mit eingebunden werden, auch, wenn es
keine Abhängigkeiten hat. Sonst könnten direkt ausgeführte Snippets ohne
Abhängigkeiten verloren gehen.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Zudem müssen alle Abhängigkeiten bekanntgegeben werden.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Wir verwenden die <code>calculate_snippet_ordering</code> Funktion um die
abhängigen keys zu einem Snippet zu finden und zu speichern.</p>
</div>
<div id="find_references" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">dependencies</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">Vec</span>::<span class="tok-n">new</span><span class="tok-p">();</span>
<span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-n">dependency</span><span class="tok-w"> </span><span class="tok-k">in</span><span class="tok-w"> </span><span class="tok-n">codeblock_parser</span>::<span class="tok-n">get_dependencies</span><span class="tok-p">(</span><span class="tok-n">content</span><span class="tok-p">).</span><span class="tok-n">iter</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-n">dependencies</span><span class="tok-p">.</span><span class="tok-n">push</span><span class="tok-p">(</span><span class="tok-n">dependency</span><span class="tok-p">.</span><span class="tok-n">to_string</span><span class="tok-p">());</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Intern ist sie folgendermaßen aufgebaut:</p>
</div>
<div id="get_dependencies" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">depends_on_ids</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nb">Vec</span>::<span class="tok-n">new</span><span class="tok-p">();</span>

<span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">ast</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">CodeblockParser</span>::<span class="tok-n">parse</span><span class="tok-p">(</span><span class="tok-n">Rule</span>::<span class="tok-n">codeblock</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">input</span><span class="tok-p">).</span><span class="tok-n">expect</span><span class="tok-p">(</span><span class="tok-s">&quot;couldn&#39;t parse input.&quot;</span><span class="tok-p">);</span>

<span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-n">element</span><span class="tok-w"> </span><span class="tok-k">in</span><span class="tok-w"> </span><span class="tok-n">ast</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-k">match</span><span class="tok-w"> </span><span class="tok-n">element</span><span class="tok-p">.</span><span class="tok-n">as_rule</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">Rule</span>::<span class="tok-n">reference</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">      </span><span class="tok-n">depends_on_ids</span><span class="tok-p">.</span><span class="tok-n">push</span><span class="tok-p">(</span><span class="tok-n">extract_identifier</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">element</span><span class="tok-p">).</span><span class="tok-n">to_string</span><span class="tok-p">());</span>
<span class="tok-w">      </span><span class="tok-o">&lt;&lt;</span><span class="tok-n">get_dependencies_of_parameters</span><span class="tok-o">&gt;&gt;</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-n">Rule</span>::<span class="tok-n">indented_reference</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">      </span><span class="tok-n">depends_on_ids</span><span class="tok-p">.</span><span class="tok-n">push</span><span class="tok-p">(</span><span class="tok-n">extract_identifier</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">element</span><span class="tok-p">).</span><span class="tok-n">to_string</span><span class="tok-p">());</span>
<span class="tok-w">      </span><span class="tok-o">&lt;&lt;</span><span class="tok-n">get_dependencies_of_parameters</span><span class="tok-o">&gt;&gt;</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-n">_</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">(),</span>
<span class="tok-w">  </span><span class="tok-p">}</span>
<span class="tok-p">}</span>

<span class="tok-n">depends_on_ids</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Snippets sind nicht nur von den Referenzen abhängig, die direkt
vorkommen, sondern auch von den Referenzen in den Snippet Parametern.</p>
</div>
<div id="get_dependencies_of_parameters" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">params</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">extract_snippet_params</span><span class="tok-p">(</span><span class="tok-nb">Vec</span>::<span class="tok-n">default</span><span class="tok-p">(),</span><span class="tok-w"> </span><span class="tok-n">element</span><span class="tok-p">.</span><span class="tok-n">as_str</span><span class="tok-p">())</span>
<span class="tok-w">  </span><span class="tok-p">.</span><span class="tok-n">pop</span><span class="tok-p">()</span>
<span class="tok-w">  </span><span class="tok-p">.</span><span class="tok-n">unwrap_or_default</span><span class="tok-p">();</span>
<span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-n">param</span><span class="tok-w"> </span><span class="tok-k">in</span><span class="tok-w"> </span><span class="tok-n">params</span><span class="tok-p">.</span><span class="tok-n">into_values</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">ReferenceParam</span>::<span class="tok-n">Reference</span><span class="tok-p">(</span><span class="tok-n">identifier</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">_</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">param</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">depends_on_ids</span><span class="tok-p">.</span><span class="tok-n">push</span><span class="tok-p">(</span><span class="tok-n">identifier</span><span class="tok-p">.</span><span class="tok-n">clone</span><span class="tok-p">());</span>
<span class="tok-w">  </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ausgaben_erzeugen">Ausgaben erzeugen</h3>
<div class="paragraph">
<p>Um Ausgaben erzeugen zu können holen wir die Code-Schnipsel in
<a href="#snippet_topo_sort">der topologisch sortierten Reihenfolge</a> ab und
verarbeiten sie anschließend gemäß ihrem jeweiligen Typ.</p>
</div>
<div id="generate_outputs" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">source</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">ast</span><span class="tok-p">.</span><span class="tok-n">get_attribute</span><span class="tok-p">(</span><span class="tok-s">&quot;source&quot;</span><span class="tok-p">).</span><span class="tok-n">unwrap_or</span><span class="tok-p">(</span><span class="tok-s">&quot;&quot;</span><span class="tok-p">);</span>
<span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">db</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">Rc</span>::<span class="tok-n">new</span><span class="tok-p">(</span><span class="tok-n">RefCell</span>::<span class="tok-n">new</span><span class="tok-p">(</span><span class="tok-n">snippets</span><span class="tok-p">));</span>
<span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">snippets</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">Rc</span>::<span class="tok-n">clone</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">db</span><span class="tok-p">);</span>

<span class="tok-k">loop</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">key</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-n">dependencies</span><span class="tok-p">.</span><span class="tok-n">pop</span><span class="tok-p">();</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">  </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">snippet</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-k">match</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">key</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-nb">Some</span><span class="tok-p">(</span><span class="tok-n">key</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">      </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">snippets</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">snippets</span><span class="tok-p">.</span><span class="tok-n">borrow_mut</span><span class="tok-p">();</span>
<span class="tok-w">      </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">snippet</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">snippets</span><span class="tok-p">.</span><span class="tok-n">pop</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">key</span><span class="tok-p">);</span>

<span class="tok-w">      </span><span class="tok-k">match</span><span class="tok-w"> </span><span class="tok-n">snippet</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-nb">Some</span><span class="tok-p">(</span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">snippet</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">          </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-o">!</span><span class="tok-n">snippet</span><span class="tok-p">.</span><span class="tok-n">raw</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">            </span><span class="tok-o">&lt;&lt;</span><span class="tok-n">merge_snippet_content</span><span class="tok-o">&gt;&gt;</span>
<span class="tok-w">          </span><span class="tok-p">};</span>

<span class="tok-w">          </span><span class="tok-n">snippets</span><span class="tok-p">.</span><span class="tok-n">store</span><span class="tok-p">(</span><span class="tok-n">key</span><span class="tok-p">.</span><span class="tok-n">to_string</span><span class="tok-p">(),</span><span class="tok-w"> </span><span class="tok-n">snippet</span><span class="tok-p">.</span><span class="tok-n">clone</span><span class="tok-p">());</span>
<span class="tok-w">          </span><span class="tok-nb">Some</span><span class="tok-p">(</span><span class="tok-n">snippet</span><span class="tok-p">)</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">        </span><span class="tok-nb">None</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-w">          </span><span class="tok-c1">// TODO Fehlermeldung im AST. Ein Snippet sollte zu</span>
<span class="tok-w">          </span><span class="tok-c1">// diesem Zeitpunkt immer bereits erstellt sein.</span>
<span class="tok-w">          </span><span class="tok-n">warn</span><span class="tok-o">!</span><span class="tok-p">(</span><span class="tok-s">&quot;{}: Dependency `{}` nicht gefunden&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">source</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">key</span><span class="tok-p">);</span>
<span class="tok-w">          </span><span class="tok-nb">None</span>
<span class="tok-w">        </span><span class="tok-p">}</span>
<span class="tok-w">      </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-nb">None</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">      </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-o">!</span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-n">dependencies</span><span class="tok-p">.</span><span class="tok-n">is_empty</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-w">        </span><span class="tok-n">error</span><span class="tok-o">!</span><span class="tok-p">(</span>
<span class="tok-w">          </span><span class="tok-s">&quot;Es ist ein Ring in den Abhängigkeiten ({:#?})&quot;</span><span class="tok-p">,</span>
<span class="tok-w">          </span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-n">dependencies</span>
<span class="tok-w">        </span><span class="tok-p">);</span>
<span class="tok-w">      </span><span class="tok-p">}</span>
<span class="tok-w">      </span><span class="tok-k">break</span><span class="tok-p">;</span><span class="tok-w"> </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">  </span><span class="tok-p">};</span>

<span class="tok-w">  </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-nb">Some</span><span class="tok-p">(</span><span class="tok-n">snippet</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">snippet</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-o">&lt;&lt;</span><span class="tok-n">execute_snippet_action</span><span class="tok-o">&gt;&gt;</span>
<span class="tok-w">  </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Die Snippets müssen in der richtigen Reihenfolge abgearbeitet werden.
Ansonsten könnte es passieren, dass ein Snippet verwendet werden soll bevor
er überhaupt generiert wurde. (TODO link vielleicht in das andere Kapitel
verschieben?)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Wird kein weiteres Snippet gefunden, so kann das zwei Gründe haben: Entweder
gibt es einen Ring in den Abhängigkeiten oder alle Snippets wurden bereits
verarbeitet. In beiden Fällen wird die Programmausführung beendet.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Ringe in den Abhängigkeiten sind problematisch, da Snippets, die von sich
selbst abhängen, nicht generiert werden können. Daher muss der Benutzer über
seinen Fehler unterrichtet werden.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Wird ein Snippet gefunden, aber es ist keines unter diesem Namen in der
Datenbank abgelegt, muss eine Fehlermeldung generiert werden. Wahrscheinlich
wurde dann ein Snippet referenziert aber nie definiert.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>TODO Wir sollten auch warnen, wenn ein Snippet zwar einen anchor hat aber niergendwo eingebunden wird. Das würde auf einen Fehler in der Logik deuten, da man wahrscheinlich vergessen hat ihn einzubinden. Diese Überprüfung sollte erst nach der Abarbeitung der Pipes abgeschlossen werden, da manche Snippets eventuell dynamisch eingebunden werden und dementsprechend doch nicht vergessen wurden.</p>
</div>
<div class="paragraph">
<p>Je nach Snippet Typ können wir nun die entsprechende Aktion ausführen.</p>
</div>
<div id="execute_snippet_action" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-k">match</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">snippet</span><span class="tok-p">.</span><span class="tok-n">kind</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-n">SnippetType</span>::<span class="tok-n">Eval</span><span class="tok-p">(</span><span class="tok-n">interpreter</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-n">eval</span><span class="tok-p">(</span><span class="tok-n">interpreter</span><span class="tok-p">.</span><span class="tok-n">to_string</span><span class="tok-p">(),</span><span class="tok-w"> </span><span class="tok-n">snippet</span><span class="tok-p">.</span><span class="tok-n">content</span><span class="tok-p">)</span><span class="tok-o">?</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-p">}</span>
<span class="tok-w">  </span><span class="tok-n">SnippetType</span>::<span class="tok-n">Plain</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{}</span>
<span class="tok-w">  </span><span class="tok-n">SnippetType</span>::<span class="tok-n">Save</span><span class="tok-p">(</span><span class="tok-n">path</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-o">&lt;&lt;</span><span class="tok-n">get_filepath</span><span class="tok-o">&gt;&gt;</span>
<span class="tok-w">    </span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-n">save</span><span class="tok-p">(</span><span class="tok-n">path</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">snippet</span><span class="tok-p">.</span><span class="tok-n">content</span><span class="tok-p">)</span><span class="tok-o">?</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-p">}</span>
<span class="tok-w">  </span><span class="tok-n">SnippetType</span>::<span class="tok-n">Pipe</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-n">pipe</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">snippet</span><span class="tok-p">.</span><span class="tok-n">content</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">db</span><span class="tok-p">)</span><span class="tok-o">?</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_save_snippet_in_eine_datei_speichern">Save: Snippet in eine Datei speichern</h4>
<div class="paragraph">
<p>Um eine Datei zu speichern haben wir eine eigene Funktion.</p>
</div>
<div id="internal_functions" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-sd">/// Saves a Snippet to a file</span>
<span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">fn</span> <span class="tok-nf">save</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-bp">self</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">path</span>: <span class="tok-kp">&amp;</span><span class="tok-kt">str</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">content</span>: <span class="tok-kp">&amp;</span><span class="tok-kt">str</span><span class="tok-p">)</span><span class="tok-w"> </span>-&gt; <span class="tok-nb">Result</span><span class="tok-o">&lt;</span><span class="tok-p">(),</span><span class="tok-w"> </span><span class="tok-n">Error</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-o">&lt;&lt;</span><span class="tok-n">strip_all_lines_in_content</span><span class="tok-o">&gt;&gt;</span>

<span class="tok-w">  </span><span class="tok-c1">// TODO Allow directory prefix from options</span>
<span class="tok-w">  </span><span class="tok-o">&lt;&lt;</span><span class="tok-n">check_path_not_allready_used_by_lisi</span><span class="tok-o">&gt;&gt;</span>

<span class="tok-w">  </span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-n">env</span><span class="tok-p">.</span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">path</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">content</span><span class="tok-p">)</span><span class="tok-o">?</span><span class="tok-p">;</span>

<span class="tok-w">  </span><span class="tok-nb">Ok</span><span class="tok-p">(())</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Um Dateien schreiben zu können müssen wir auf die <a href="#side-effects">Betriebsystem-Umgebung</a> zugreifen.</p>
</div>
<div class="paragraph">
<p>Fehler, die dabei auftreten können, müssen wir abfangen.</p>
</div>
<div id="errors" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-cp">#[error(transparent)]</span>
<span class="tok-n">Asciidoctrine</span><span class="tok-p">(</span><span class="tok-cp">#[from]</span><span class="tok-w"> </span><span class="tok-n">asciidoctrine</span>::<span class="tok-n">AsciidoctrineError</span><span class="tok-p">),</span>
<span class="tok-cp">#[error(</span><span class="tok-s">&quot;io problem&quot;</span><span class="tok-cp">)]</span>
<span class="tok-n">Io</span><span class="tok-p">(</span><span class="tok-cp">#[from]</span><span class="tok-w"> </span><span class="tok-n">std</span>::<span class="tok-n">io</span>::<span class="tok-n">Error</span><span class="tok-p">),</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In einer Datei kann es sehr nervig sein, Whithespaces an den Zeilenenden zu
haben. Dies kann aber geschehen wenn in der Quelldatei Whitespaces am Ende der
Zeilen sind. Selbst wenn das nicht der Fall ist geschieht es durch unsere
Einrückungen mitunter automatisch (TODO link). Wir lösen das Problem, indem wir
unmittelbar vor dem schreiben in eine Datei "aufräumen".</p>
</div>
<div id="strip_all_lines_in_content" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">content</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">content</span><span class="tok-p">.</span><span class="tok-n">lines</span><span class="tok-p">()</span>
<span class="tok-w">                     </span><span class="tok-p">.</span><span class="tok-n">map</span><span class="tok-p">(</span><span class="tok-o">|</span><span class="tok-n">line</span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-nb">String</span>::<span class="tok-n">from</span><span class="tok-p">(</span><span class="tok-n">line</span><span class="tok-p">.</span><span class="tok-n">trim_end</span><span class="tok-p">())</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-s">&quot;</span><span class="tok-se">\n</span><span class="tok-s">&quot;</span><span class="tok-w"> </span><span class="tok-p">})</span>
<span class="tok-w">                     </span><span class="tok-p">.</span><span class="tok-n">collect</span>::<span class="tok-o">&lt;</span><span class="tok-nb">String</span><span class="tok-o">&gt;</span><span class="tok-p">();</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_eval_ein_snippet_ausführen">Eval: Ein Snippet ausführen</h4>
<div id="internal_functions" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-sd">/// Run a snippet in an interpreter</span>
<span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">fn</span> <span class="tok-nf">eval</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-bp">self</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">interpreter</span>: <span class="tok-nb">String</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">content</span>: <span class="tok-nb">String</span><span class="tok-p">)</span><span class="tok-w"> </span>-&gt; <span class="tok-nb">Result</span><span class="tok-o">&lt;</span><span class="tok-p">(),</span><span class="tok-w"> </span><span class="tok-n">Error</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-o">&lt;&lt;</span><span class="tok-n">get_eval_interpreter</span><span class="tok-o">&gt;&gt;</span>

<span class="tok-w">  </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">success</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">out</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">err</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-n">env</span><span class="tok-p">.</span><span class="tok-n">eval</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">interpreter</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">content</span><span class="tok-p">)</span><span class="tok-o">?</span><span class="tok-p">;</span>

<span class="tok-w">  </span><span class="tok-o">&lt;&lt;</span><span class="tok-n">process_stdout_and_stderr</span><span class="tok-o">&gt;&gt;</span>

<span class="tok-w">  </span><span class="tok-nb">Ok</span><span class="tok-p">(())</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Nachdem der Prozess ausgeführt wurde können wir seine Ausgaben (über <code>stdout</code> und <code>stderr</code>) in das Ausgabedokument (den AST) übernehmen. Dabei ist es nicht nur interessant Texte anzuzeigen sondern es ist auch möglich beliebige Inhalte anzuzeigen.</p>
</div>
<div id="process_stdout_and_stderr" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-c1">// TODO in den Asciidoc AST einbinden</span>
<span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-n">success</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-n">info</span><span class="tok-o">!</span><span class="tok-p">(</span><span class="tok-s">&quot;{}&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">out</span><span class="tok-p">);</span><span class="tok-w"> </span><span class="tok-c1">// TODO entfernen</span>
<span class="tok-p">}</span><span class="tok-w"> </span><span class="tok-k">else</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-n">error</span><span class="tok-o">!</span><span class="tok-p">(</span><span class="tok-s">&quot;External command failed:</span><span class="tok-se">\n</span><span class="tok-s"> {}&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">err</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-c1">// TODO entfernen</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>TODO Die Ergebnisse ließen sich sicher auch als Bilder, Audio etc einbinden. Hier kann man bestimmt etwas von <a href="https://jupyter.org/" class="bare">https://jupyter.org/</a> und <a href="https://observablehq.com/" class="bare">https://observablehq.com/</a> lernen.</p>
</div>
<div class="paragraph">
<p>Um die <a href="#usage_display_mime">Daten anzuzeigen welche dargestellt werden sollen</a> wird der <code>stdout</code> Stream nach dem Delimiter (TODO link) abgesucht, welcher den speziellen Inhalt enthält. Dann wird der mime_type (TODO Wikipedia link) ermittelt. Alle binären Daten müssen in base64 (TODO link) Format umgewandelt werden.</p>
</div>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect3">
<h4 id="_pipe_snippets_dynamisch_erzeugen">Pipe: Snippets dynamisch erzeugen</h4>
<div class="paragraph">
<p>Beim <code>pipe</code> Befehl werden snippets als interne Scripte ausgeführt. Wir
verwenden <a href="https://github.com/jonathandturner/rhai">rhai</a> als Interpreter.</p>
</div>
<div id="cargo_dependencies" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="toml"><span></span><span class="tok-n">rhai</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;1.3&quot;</span></code></pre>
</div>
</div>
<div id="internal_functions" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-sd">/// Use a snippet to manipulate the db instead of using it directly</span>
<span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">fn</span> <span class="tok-nf">pipe</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-bp">self</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">content</span>: <span class="tok-kp">&amp;</span><span class="tok-kt">str</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">db</span>: <span class="tok-kp">&amp;</span><span class="tok-nc">Rc</span><span class="tok-o">&lt;</span><span class="tok-n">RefCell</span><span class="tok-o">&lt;</span><span class="tok-n">SnippetDB</span><span class="tok-o">&gt;&gt;</span><span class="tok-p">)</span><span class="tok-w"> </span>-&gt; <span class="tok-nb">Result</span><span class="tok-o">&lt;</span><span class="tok-p">(),</span><span class="tok-w"> </span><span class="tok-n">Error</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-o">&lt;&lt;</span><span class="tok-n">do_pipe</span><span class="tok-o">&gt;&gt;</span>

<span class="tok-w">  </span><span class="tok-nb">Ok</span><span class="tok-p">(())</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Jede <code>pipe</code> bekommt ihre eigene Script Umgebung.</p>
</div>
<div id="do_pipe" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">engine</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">rhai</span>::<span class="tok-n">Engine</span>::<span class="tok-n">new</span><span class="tok-p">();</span>

<span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">scope</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">rhai</span>::<span class="tok-n">Scope</span>::<span class="tok-n">new</span><span class="tok-p">();</span>

<span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">wrapper</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">LisiWrapper</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-n">snippets</span>: <span class="tok-nc">Rc</span>::<span class="tok-n">clone</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-n">db</span><span class="tok-p">)</span>
<span class="tok-p">};</span>
<span class="tok-n">scope</span><span class="tok-p">.</span><span class="tok-n">push_constant</span><span class="tok-p">(</span><span class="tok-s">&quot;lisi&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">wrapper</span><span class="tok-p">);</span>

<span class="tok-n">engine</span><span class="tok-p">.</span><span class="tok-n">register_type_with_name</span>::<span class="tok-o">&lt;</span><span class="tok-n">LisiWrapper</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-s">&quot;LisiType&quot;</span><span class="tok-p">);</span>
<span class="tok-n">engine</span><span class="tok-p">.</span><span class="tok-n">register_fn</span><span class="tok-p">(</span><span class="tok-s">&quot;store&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">LisiWrapper</span>::<span class="tok-n">store</span><span class="tok-p">);</span>
<span class="tok-n">engine</span><span class="tok-p">.</span><span class="tok-n">register_fn</span><span class="tok-p">(</span><span class="tok-s">&quot;get_snippet&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">LisiWrapper</span>::<span class="tok-n">get_snippet</span><span class="tok-p">);</span>
<span class="tok-n">engine</span><span class="tok-p">.</span><span class="tok-n">register_fn</span><span class="tok-p">(</span><span class="tok-s">&quot;get_snippet_names&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">LisiWrapper</span>::<span class="tok-n">get_snippet_names</span><span class="tok-p">);</span>

<span class="tok-n">engine</span><span class="tok-p">.</span><span class="tok-n">eval_with_scope</span>::<span class="tok-o">&lt;</span><span class="tok-p">()</span><span class="tok-o">&gt;</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">scope</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">content</span><span class="tok-p">)</span>
<span class="tok-w">  </span><span class="tok-p">.</span><span class="tok-n">unwrap_or_else</span><span class="tok-p">(</span><span class="tok-o">|</span><span class="tok-n">e</span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">error</span><span class="tok-o">!</span><span class="tok-p">(</span><span class="tok-s">&quot;Piping of snippet failed:</span><span class="tok-se">\n</span><span class="tok-s"> {}&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">e</span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-p">});</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Wir übergeben dem Interpreter eine Funktionsumgebung, welche die grundlegenden Funktionen zulässt.</p>
</div>
<div id="internal_structs" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-cp">#[derive(Clone)]</span>
<span class="tok-k">struct</span> <span class="tok-nc">LisiWrapper</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-n">snippets</span>: <span class="tok-nc">Rc</span><span class="tok-o">&lt;</span><span class="tok-n">RefCell</span><span class="tok-o">&lt;</span><span class="tok-n">SnippetDB</span><span class="tok-o">&gt;&gt;</span><span class="tok-p">,</span>
<span class="tok-p">}</span>

<span class="tok-k">impl</span><span class="tok-w"> </span><span class="tok-n">LisiWrapper</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">fn</span> <span class="tok-nf">store</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-bp">self</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">name</span>: <span class="tok-kp">&amp;</span><span class="tok-kt">str</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">content</span>: <span class="tok-kp">&amp;</span><span class="tok-kt">str</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">snippets</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-n">snippets</span><span class="tok-p">.</span><span class="tok-n">borrow_mut</span><span class="tok-p">();</span>

<span class="tok-w">    </span><span class="tok-n">snippets</span><span class="tok-p">.</span><span class="tok-n">pop</span><span class="tok-p">(</span><span class="tok-n">name</span><span class="tok-p">);</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>

<span class="tok-w">    </span><span class="tok-n">snippets</span><span class="tok-p">.</span><span class="tok-n">store</span><span class="tok-p">(</span>
<span class="tok-w">      </span><span class="tok-n">name</span><span class="tok-p">.</span><span class="tok-n">to_string</span><span class="tok-p">(),</span>
<span class="tok-w">      </span><span class="tok-n">Snippet</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">kind</span>: <span class="tok-nc">SnippetType</span>::<span class="tok-n">Plain</span><span class="tok-p">,</span>
<span class="tok-w">        </span><span class="tok-n">content</span>: <span class="tok-nc">content</span><span class="tok-p">.</span><span class="tok-n">to_string</span><span class="tok-p">(),</span>
<span class="tok-w">        </span><span class="tok-n">raw_content</span>: <span class="tok-nc">content</span><span class="tok-p">.</span><span class="tok-n">to_string</span><span class="tok-p">(),</span>
<span class="tok-w">        </span><span class="tok-n">children</span>: <span class="tok-nb">Vec</span>::<span class="tok-n">new</span><span class="tok-p">(),</span>
<span class="tok-w">        </span><span class="tok-n">depends_on</span>: <span class="tok-nb">Vec</span>::<span class="tok-n">new</span><span class="tok-p">(),</span>
<span class="tok-w">        </span><span class="tok-n">attributes</span>: <span class="tok-nc">HashMap</span>::<span class="tok-n">default</span><span class="tok-p">(),</span>
<span class="tok-w">        </span><span class="tok-n">raw</span>: <span class="tok-nc">true</span><span class="tok-p">,</span>
<span class="tok-w">      </span><span class="tok-p">},</span>
<span class="tok-w">    </span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-p">}</span>

<span class="tok-w">  </span><span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">fn</span> <span class="tok-nf">get_snippet</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-bp">self</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">name</span>: <span class="tok-kp">&amp;</span><span class="tok-kt">str</span><span class="tok-p">)</span><span class="tok-w"> </span>-&gt; <span class="tok-nc">rhai</span>::<span class="tok-n">Dynamic</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">snippets</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-n">snippets</span><span class="tok-p">.</span><span class="tok-n">borrow_mut</span><span class="tok-p">();</span>

<span class="tok-w">    </span><span class="tok-k">match</span><span class="tok-w"> </span><span class="tok-n">snippets</span><span class="tok-p">.</span><span class="tok-n">get</span><span class="tok-p">(</span><span class="tok-n">name</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">      </span><span class="tok-nb">Some</span><span class="tok-p">(</span><span class="tok-n">snippet</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">attributes</span>: <span class="tok-nc">HashMap</span><span class="tok-o">&lt;</span><span class="tok-n">rhai</span>::<span class="tok-n">ImmutableString</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">rhai</span>::<span class="tok-n">Dynamic</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">HashMap</span>::<span class="tok-n">default</span><span class="tok-p">();</span>
<span class="tok-w">        </span><span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">k</span><span class="tok-p">,</span><span class="tok-n">v</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-k">in</span><span class="tok-w"> </span><span class="tok-n">snippet</span><span class="tok-p">.</span><span class="tok-n">attributes</span><span class="tok-p">.</span><span class="tok-n">clone</span><span class="tok-p">().</span><span class="tok-n">drain</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">          </span><span class="tok-n">attributes</span><span class="tok-p">.</span><span class="tok-n">insert</span><span class="tok-p">(</span><span class="tok-n">k</span><span class="tok-p">.</span><span class="tok-n">into</span><span class="tok-p">(),</span><span class="tok-w"> </span><span class="tok-n">v</span><span class="tok-p">.</span><span class="tok-n">into</span><span class="tok-p">());</span>
<span class="tok-w">        </span><span class="tok-p">}</span>

<span class="tok-w">        </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">out</span>: <span class="tok-nc">HashMap</span><span class="tok-o">&lt;</span><span class="tok-n">rhai</span>::<span class="tok-n">ImmutableString</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">rhai</span>::<span class="tok-n">Dynamic</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">HashMap</span>::<span class="tok-n">default</span><span class="tok-p">();</span>
<span class="tok-w">        </span><span class="tok-n">out</span><span class="tok-p">.</span><span class="tok-n">insert</span><span class="tok-p">(</span><span class="tok-s">&quot;content&quot;</span><span class="tok-p">.</span><span class="tok-n">into</span><span class="tok-p">(),</span><span class="tok-w"> </span><span class="tok-n">snippet</span><span class="tok-p">.</span><span class="tok-n">get_raw_content</span><span class="tok-p">(</span><span class="tok-s">&quot;</span><span class="tok-se">\n</span><span class="tok-s">&quot;</span><span class="tok-p">).</span><span class="tok-n">into</span><span class="tok-p">());</span>
<span class="tok-w">        </span><span class="tok-n">out</span><span class="tok-p">.</span><span class="tok-n">insert</span><span class="tok-p">(</span><span class="tok-s">&quot;attrs&quot;</span><span class="tok-p">.</span><span class="tok-n">into</span><span class="tok-p">(),</span><span class="tok-w"> </span><span class="tok-n">attributes</span><span class="tok-p">.</span><span class="tok-n">into</span><span class="tok-p">());</span>

<span class="tok-w">        </span><span class="tok-n">out</span><span class="tok-p">.</span><span class="tok-n">into</span><span class="tok-p">()</span>
<span class="tok-w">      </span><span class="tok-p">},</span>
<span class="tok-w">      </span><span class="tok-nb">None</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-n">rhai</span>::<span class="tok-n">Dynamic</span>::<span class="tok-n">from</span><span class="tok-p">(()),</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">  </span><span class="tok-p">}</span>

<span class="tok-w">  </span><span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">fn</span> <span class="tok-nf">get_snippet_names</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-bp">self</span><span class="tok-p">)</span><span class="tok-w"> </span>-&gt; <span class="tok-nc">rhai</span>::<span class="tok-n">Array</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">snippets</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-n">snippets</span><span class="tok-p">.</span><span class="tok-n">borrow_mut</span><span class="tok-p">();</span>

<span class="tok-w">    </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">out</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">rhai</span>::<span class="tok-n">Array</span>::<span class="tok-n">new</span><span class="tok-p">();</span>

<span class="tok-w">    </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">keys</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">snippets</span>
<span class="tok-w">      </span><span class="tok-p">.</span><span class="tok-n">iter</span><span class="tok-p">()</span>
<span class="tok-w">      </span><span class="tok-p">.</span><span class="tok-n">map</span><span class="tok-p">(</span><span class="tok-o">|</span><span class="tok-p">(</span><span class="tok-n">key</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">_</span><span class="tok-p">)</span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-n">key</span><span class="tok-p">.</span><span class="tok-n">to_string</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">})</span>
<span class="tok-w">      </span><span class="tok-p">.</span><span class="tok-n">collect</span>::<span class="tok-o">&lt;</span><span class="tok-nb">Vec</span><span class="tok-o">&lt;</span><span class="tok-n">_</span><span class="tok-o">&gt;&gt;</span><span class="tok-p">();</span>
<span class="tok-w">    </span><span class="tok-n">keys</span><span class="tok-p">.</span><span class="tok-n">sort</span><span class="tok-p">();</span>
<span class="tok-w">    </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">out</span>: <span class="tok-nc">rhai</span>::<span class="tok-n">Array</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">keys</span>
<span class="tok-w">      </span><span class="tok-p">.</span><span class="tok-n">into_iter</span><span class="tok-p">()</span>
<span class="tok-w">      </span><span class="tok-p">.</span><span class="tok-n">map</span><span class="tok-p">(</span><span class="tok-o">|</span><span class="tok-n">key</span><span class="tok-o">|</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-n">key</span><span class="tok-p">.</span><span class="tok-n">into</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">})</span>
<span class="tok-w">      </span><span class="tok-p">.</span><span class="tok-n">collect</span><span class="tok-p">();</span>

<span class="tok-w">    </span><span class="tok-n">out</span>
<span class="tok-w">  </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Eine wichtige Anwendung von Pipe-Snippets ist sich selbst dynamisch zu schreiben (TODO link). Damit das klappt muss der bestehende Inhalt ersetzt werden (Und nicht angehängt).</td>
</tr>
</table>
</div>
<div id="crate_usages" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-k">use</span><span class="tok-w"> </span><span class="tok-n">core</span>::<span class="tok-n">cell</span>::<span class="tok-n">RefCell</span><span class="tok-p">;</span>
<span class="tok-k">use</span><span class="tok-w"> </span><span class="tok-n">std</span>::<span class="tok-n">rc</span>::<span class="tok-n">Rc</span><span class="tok-p">;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_umgang_mit_fehlern_beim_raussuchen_der_schnipsel">Umgang mit Fehlern beim Raussuchen der Schnipsel</h4>
<div class="paragraph">
<p>Es kann vorkommen, dass der Benutzer ein Schnipsel referenziert, welches er nie definiert. Das zeigt sich dadurch, dass eine Dependency fehlt.</p>
</div>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="side-effects">Seiteneffekte (Zugriff auf die Betriebsystem-Umgebung)</h3>
<div class="paragraph">
<p>Lisi kann Seiteneffekte nutzen (Das ist sogar eine der Hauptaufgaben von <code>lisi</code>). Das bedeutet es erzeugt und nutzt Ein- und Ausgaben welche nicht direkt als Parameter übergeben wurden.</p>
</div>
<div class="paragraph">
<p>Das Schreiben von Dateien im Dateisystem, das Ausführen von Scripten durch externe Interpreter, usw sind alles Seiteneffekte.</p>
</div>
<div class="paragraph">
<p>Das ist sehr schön und einer der Gründe, warum Lisi so mächtig ist, doch in manchen Situationen kann es auch zu Problemen führen:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Beim Testen (TODO link) müssen wir wissen welche Seiteneffekte genutzt werden (und auf welche Art).</p>
</li>
<li>
<p>Wollen wir <code>lisi</code> in eingeschränkten Umgebungen nutzen (embedded Kontext, WASM) stehen uns viele dieser betriebssystemabhängigen Seiteneffekte nicht zur Verfügung und wir müssen Alternative Wege finden sie zu implementieren.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>TODO Die Seiteneffekt API beschreiben sowie dependency injektion. Eventuell auch in asciidoctrine nutzen (z.B. für import)</p>
</div>
<div id="lisi_internal_variables" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-n">env</span>: <span class="tok-kp">&amp;</span><span class="tok-o">&#39;</span><span class="tok-na">a</span> <span class="tok-nc">mut</span><span class="tok-w"> </span><span class="tok-n">asciidoctrine</span>::<span class="tok-n">util</span>::<span class="tok-n">Env</span><span class="tok-p">,</span></code></pre>
</div>
</div>
<div id="lisi_init_variables" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-n">env</span>: <span class="tok-nc">env</span><span class="tok-p">,</span></code></pre>
</div>
</div>
<div id="crate_usages" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-k">use</span><span class="tok-w"> </span><span class="tok-n">asciidoctrine</span>::<span class="tok-n">util</span>::<span class="tok-n">Environment</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Manchmal (insbesondere bei Tests TODO link) müssen wir auf die Seiteneffekte zugreifen können. Dafür verwenden wir eine spezielle Funktion, welche das Environment bei der Initialisierung überschreibt.</p>
</div>
<div id="internal_functions" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">fn</span> <span class="tok-nf">from_env</span><span class="tok-p">(</span><span class="tok-n">env</span>: <span class="tok-kp">&amp;</span><span class="tok-o">&#39;</span><span class="tok-na">a</span> <span class="tok-nc">mut</span><span class="tok-w"> </span><span class="tok-n">util</span>::<span class="tok-n">Env</span><span class="tok-p">)</span><span class="tok-w"> </span>-&gt; <span class="tok-nc">Self</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-n">Lisi</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-o">&lt;&lt;</span><span class="tok-n">lisi_init_variables</span><span class="tok-o">&gt;&gt;</span>
<span class="tok-w">  </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_fehlerbehandlung">Fehlerbehandlung</h3>
<div class="paragraph">
<p>Um Fehler abfangen zu können benutzen wir das <code>thiserror</code> crate.</p>
</div>
<div id="cargo_dependencies" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="toml"><span></span><span class="tok-n">thiserror</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;1.0&quot;</span></code></pre>
</div>
</div>
<div id="internal_structs" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-cp">#[derive(thiserror::Error, Debug)]</span>
<span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">enum</span> <span class="tok-nc">Error</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-o">&lt;&lt;</span><span class="tok-n">errors</span><span class="tok-o">&gt;&gt;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Das betrifft alles Fehler, welche so von der Bibliothek nicht abgefangen werden. Es gibt allerdings auch Fehler, welche erst zur Laufzeit vom Programm abgefangen werden. Für diese benötigen wir einen Logging Mechanismus.</p>
</div>
<div id="cargo_dependencies" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="toml"><span></span><span class="tok-n">log</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;0.4&quot;</span></code></pre>
</div>
</div>
<div id="crate_usages" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-cp">#[macro_use]</span>
<span class="tok-k">extern</span><span class="tok-w"> </span><span class="tok-k">crate</span><span class="tok-w"> </span><span class="tok-n">log</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Das resultierende <code>lisi</code> executable soll allerdings alle Arten von Fehlern abfangen, deshalb verwenden wir hier den <code>anyhow</code> crate.</p>
</div>
<div id="cargo_dependencies" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="toml"><span></span><span class="tok-n">anyhow</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;1.0&quot;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="unit-tests">Tests</h3>
<div class="paragraph">
<p>Um <code>lisi</code> zu testen verwenden wir die in diesem Dokument beschriebenen Beispiele aus der <a href="#usage">Bedienungsanleitung</a> und überprüfen, ob die Ergebnisse wirklich generiert werden.</p>
</div>
<div class="paragraph">
<p>Ein Test hat dabei grundsätzlich folgenden Aufbau:</p>
</div>
<div id="unit-test-template" class="listingblock">
<div class="title">Grundlegender Aufbau eines Unit Tests</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-cp">#[test]</span>
<span class="tok-k">fn</span> <span class="tok-p">{</span><span class="tok-n">test_name</span><span class="tok-p">}()</span><span class="tok-w"> </span>-&gt; <span class="tok-nb">Result</span><span class="tok-o">&lt;</span><span class="tok-p">()</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">content</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">r#&quot;{asciidoc_content}&quot;#</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">reader</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">AsciidocReader</span>::<span class="tok-n">new</span><span class="tok-p">();</span>
<span class="tok-w">  </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">opts</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">options</span>::<span class="tok-n">Opts</span>::<span class="tok-n">parse_from</span><span class="tok-p">(</span><span class="tok-fm">vec!</span><span class="tok-p">[</span><span class="tok-s">&quot;&quot;</span><span class="tok-p">].</span><span class="tok-n">into_iter</span><span class="tok-p">());</span>
<span class="tok-w">  </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">env</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">util</span>::<span class="tok-n">Env</span>::<span class="tok-n">Cache</span><span class="tok-p">(</span><span class="tok-n">util</span>::<span class="tok-n">Cache</span>::<span class="tok-n">new</span><span class="tok-p">());</span>
<span class="tok-w">  </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">ast</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">reader</span><span class="tok-p">.</span><span class="tok-n">parse</span><span class="tok-p">(</span><span class="tok-n">content</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-n">opts</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">env</span><span class="tok-p">)</span><span class="tok-o">?</span><span class="tok-p">;</span>

<span class="tok-w">  </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">lisi</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">Lisi</span>::<span class="tok-n">from_env</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">env</span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">_ast</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">lisi</span><span class="tok-p">.</span><span class="tok-n">transform</span><span class="tok-p">(</span><span class="tok-n">ast</span><span class="tok-p">)</span><span class="tok-o">?</span><span class="tok-p">;</span>

<span class="tok-w">  </span><span class="tok-c1">// TODO ast vergleichen</span>

<span class="tok-w">  </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">outputs</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">env</span><span class="tok-p">.</span><span class="tok-n">get_cache</span><span class="tok-p">().</span><span class="tok-n">unwrap</span><span class="tok-p">();</span>

<span class="tok-w">  </span><span class="tok-p">{</span><span class="tok-n">compare_outputs</span><span class="tok-p">}</span>

<span class="tok-w">  </span><span class="tok-fm">assert!</span><span class="tok-p">(</span><span class="tok-n">outputs</span><span class="tok-p">.</span><span class="tok-n">is_empty</span><span class="tok-p">());</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>

<span class="tok-w">  </span><span class="tok-nb">Ok</span><span class="tok-p">(())</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Nachdem wir unsere erzeugten Dateien überprüft haben, müssen wir noch überprüfen, ob keine weiteren Dateien erzeugt wurden welche von unserem Test nicht abgedeckt wurden.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Das Überprüfen des Inhaltes einer erzeugten Datei läuft immer gleich ab: Wir holen den erzeugten Text aus dem Ausgabepuffer mit dem entsprechenden Dateinamen und vergleichen ihn mit dem dazugeörigen Snippet aus der Dokumentation.</p>
</div>
<div id="unit-test-compare_outputs-template" class="listingblock">
<div class="title">Den Inhalt eines generierten Textes überprüfen</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><span></span><span class="tok-fm">assert_eq!</span><span class="tok-p">(</span>
<span class="tok-w">  </span><span class="tok-n">outputs</span><span class="tok-p">.</span><span class="tok-n">remove</span><span class="tok-p">(</span><span class="tok-s">&quot;{filepath}&quot;</span><span class="tok-p">).</span><span class="tok-n">unwrap</span><span class="tok-p">(),</span>
<span class="tok-w">  </span><span class="tok-s">r#&quot;{expected_content}&quot;#</span>
<span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Unsere Tests packen wir in eine Test Umgebung, welche alle wichtigen crates bereits importiert.</p>
</div>
<div class="listingblock">
<div class="title">tests/lisi_test.rs</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="rust"><div class="lineno"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><span class="tok-k">use</span><span class="tok-w"> </span><span class="tok-n">anyhow</span>::<span class="tok-nb">Result</span><span class="tok-p">;</span>
<span class="tok-k">use</span><span class="tok-w"> </span><span class="tok-n">asciidoctrine</span>::<span class="tok-p">{</span><span class="tok-bp">self</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-p">};</span>
<span class="tok-k">use</span><span class="tok-w"> </span><span class="tok-n">clap</span>::<span class="tok-n">Parser</span><span class="tok-p">;</span>
<span class="tok-k">use</span><span class="tok-w"> </span><span class="tok-n">lisi</span>::<span class="tok-o">*</span><span class="tok-p">;</span>
<span class="tok-k">use</span><span class="tok-w"> </span><span class="tok-n">pretty_assertions</span>::<span class="tok-n">assert_eq</span><span class="tok-p">;</span>

<span class="tok-o">&lt;&lt;</span><span class="tok-n">lisi</span><span class="tok-o">-</span><span class="tok-n">unit</span><span class="tok-o">-</span><span class="tok-n">tests</span><span class="tok-o">&gt;&gt;</span>
</pre></div></td></tr></table></div></code></pre>
</div>
</div>
<div class="paragraph">
<p>Um nun die eigentlichen Tests zu erzeugen müssen wir nur noch alle Beschreibungen (Snippets) aus der Benutzerdokumentation extrahrieren und überprüfen, ob die dort versprochenen AUsgaben auch wirklich erzeugt wurden. Um die entsprechenden Snippets zu finden haben wir sie im Asciidoc Text mit Attributen gekennzeichnet.</p>
</div>
<div id="lisi-unit-tests" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="js"><div class="lineno"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span></pre></div></td><td class="code"><div><pre><span></span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-nx">template</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nx">lisi</span><span class="tok-p">.</span><span class="tok-nx">get_snippet</span><span class="tok-p">(</span><span class="tok-s2">&quot;unit-test-template&quot;</span><span class="tok-p">).</span><span class="tok-nx">content</span><span class="tok-p">;</span>
<span class="tok-nx">template</span><span class="tok-p">.</span><span class="tok-nx">replace</span><span class="tok-p">(</span><span class="tok-s2">&quot; // &lt;1&gt;&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s2">&quot;&quot;</span><span class="tok-p">);</span>
<span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-nx">compare_template</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nx">lisi</span><span class="tok-p">.</span><span class="tok-nx">get_snippet</span><span class="tok-p">(</span><span class="tok-s2">&quot;unit-test-compare_outputs-template&quot;</span><span class="tok-p">).</span><span class="tok-nx">content</span><span class="tok-p">;</span>
<span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-nx">tests</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s2">&quot;&quot;</span><span class="tok-p">;</span>

<span class="tok-nx">fn</span><span class="tok-w"> </span><span class="tok-nx">split</span><span class="tok-p">(</span><span class="tok-nx">input</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-nx">seperator</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-nx">out</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">[];</span>
<span class="tok-w">  </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-nx">start</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mf">0</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-nx">idx</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nx">input</span><span class="tok-p">.</span><span class="tok-nx">index_of</span><span class="tok-p">(</span><span class="tok-nx">seperator</span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-k">while</span><span class="tok-w"> </span><span class="tok-nx">idx</span><span class="tok-w"> </span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-o">-</span><span class="tok-mf">1</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-nx">chunk</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nx">input</span><span class="tok-p">.</span><span class="tok-nx">sub_string</span><span class="tok-p">(</span><span class="tok-nx">start</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-nx">idx</span><span class="tok-w"> </span><span class="tok-o">-</span><span class="tok-w"> </span><span class="tok-nx">start</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-nx">out</span><span class="tok-p">.</span><span class="tok-nx">push</span><span class="tok-p">(</span><span class="tok-nx">chunk</span><span class="tok-p">);</span>

<span class="tok-w">    </span><span class="tok-nx">start</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nx">idx</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-mf">1</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-nx">idx</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nx">input</span><span class="tok-p">.</span><span class="tok-nx">index_of</span><span class="tok-p">(</span><span class="tok-nx">seperator</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-nx">start</span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-p">};</span>
<span class="tok-w">  </span><span class="tok-nx">out</span><span class="tok-p">.</span><span class="tok-nx">push</span><span class="tok-p">(</span><span class="tok-nx">input</span><span class="tok-p">.</span><span class="tok-nx">sub_string</span><span class="tok-p">(</span><span class="tok-nx">start</span><span class="tok-p">));</span>
<span class="tok-w">  </span><span class="tok-k">return</span><span class="tok-w"> </span><span class="tok-nx">out</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-nx">name</span><span class="tok-w"> </span><span class="tok-ow">in</span><span class="tok-w"> </span><span class="tok-nx">lisi.get_snippet_names</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-nx">name</span><span class="tok-p">.</span><span class="tok-nx">contains</span><span class="tok-p">(</span><span class="tok-s2">&quot;unittest_&quot;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">&amp;&amp;</span><span class="tok-w"> </span><span class="tok-nx">name</span><span class="tok-p">.</span><span class="tok-nx">contains</span><span class="tok-p">(</span><span class="tok-s2">&quot;_input&quot;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-nx">out_template</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nx">template</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-nx">compare_out</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s2">&quot;&quot;</span><span class="tok-p">;</span>

<span class="tok-w">    </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-nx">snippet</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nx">lisi</span><span class="tok-p">.</span><span class="tok-nx">get_snippet</span><span class="tok-p">(</span><span class="tok-nx">name</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-nx">out_template</span><span class="tok-p">.</span><span class="tok-nx">replace</span><span class="tok-p">(</span><span class="tok-s2">&quot;{test_name}&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-nx">snippet</span><span class="tok-p">.</span><span class="tok-nx">attrs</span><span class="tok-p">.</span><span class="tok-nx">name</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-nx">asciidoc_content</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s2">&quot;\n&quot;</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-nx">snippet</span><span class="tok-p">.</span><span class="tok-nx">content</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-s2">&quot;\n&quot;</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-nx">asciidoc_content</span><span class="tok-p">.</span><span class="tok-nx">replace</span><span class="tok-p">(</span><span class="tok-s2">&quot; -- &lt;1&gt;&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s2">&quot;&quot;</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-nx">asciidoc_content</span><span class="tok-p">.</span><span class="tok-nx">replace</span><span class="tok-p">(</span><span class="tok-s2">&quot; -- &lt;2&gt;&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s2">&quot;&quot;</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-nx">out_template</span><span class="tok-p">.</span><span class="tok-nx">replace</span><span class="tok-p">(</span><span class="tok-s2">&quot;{asciidoc_content}&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-nx">asciidoc_content</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-nx">outputs_names</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nx">snippet</span><span class="tok-p">.</span><span class="tok-nx">attrs</span><span class="tok-p">.</span><span class="tok-nx">outputs</span><span class="tok-p">;</span>

<span class="tok-w">    </span><span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-nx">output_name</span><span class="tok-w"> </span><span class="tok-ow">in</span><span class="tok-w"> </span><span class="tok-nx">split</span><span class="tok-p">(</span><span class="tok-nx">outputs_names</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s2">&quot;,&quot;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">      </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-nx">compare_out_template</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nx">compare_template</span><span class="tok-p">;</span>
<span class="tok-w">      </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-nx">output_snippet</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-nx">lisi</span><span class="tok-p">.</span><span class="tok-nx">get_snippet</span><span class="tok-p">(</span><span class="tok-nx">output_name</span><span class="tok-p">);</span>
<span class="tok-w">      </span><span class="tok-nx">compare_out_template</span><span class="tok-p">.</span><span class="tok-nx">replace</span><span class="tok-p">(</span><span class="tok-s2">&quot;{expected_content}&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-nx">output_snippet</span><span class="tok-p">.</span><span class="tok-nx">content</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-s2">&quot;\n&quot;</span><span class="tok-p">);</span>
<span class="tok-w">      </span><span class="tok-nx">compare_out_template</span><span class="tok-p">.</span><span class="tok-nx">replace</span><span class="tok-p">(</span><span class="tok-s2">&quot;{filepath}&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-nx">output_snippet</span><span class="tok-p">.</span><span class="tok-nx">attrs</span><span class="tok-p">.</span><span class="tok-nx">title</span><span class="tok-p">);</span>
<span class="tok-w">      </span><span class="tok-nx">compare_out</span><span class="tok-w"> </span><span class="tok-o">+=</span><span class="tok-w"> </span><span class="tok-nx">compare_out_template</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-s2">&quot;\n&quot;</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-p">}</span>

<span class="tok-w">    </span><span class="tok-nx">out_template</span><span class="tok-p">.</span><span class="tok-nx">replace</span><span class="tok-p">(</span><span class="tok-s2">&quot;{compare_outputs}&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-nx">compare_out</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-nx">tests</span><span class="tok-w"> </span><span class="tok-o">+=</span><span class="tok-w"> </span><span class="tok-nx">out_template</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-nx">tests</span><span class="tok-w"> </span><span class="tok-o">+=</span><span class="tok-w"> </span><span class="tok-s2">&quot;\n\n&quot;</span><span class="tok-p">;</span>
<span class="tok-w">  </span><span class="tok-p">}</span>
<span class="tok-p">}</span>

<span class="tok-nx">lisi</span><span class="tok-p">.</span><span class="tok-nx">store</span><span class="tok-p">(</span><span class="tok-s2">&quot;lisi-unit-tests&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-nx">tests</span><span class="tok-p">);</span>
</pre></div></td></tr></table></div></code></pre>
</div>
</div>
<div class="paragraph">
<p>Um schönere diffs angezeigt zu bekommen sobald ein Fehler auftritt verwenden wir den <a href="https://github.com/colin-kiegel/rust-pretty-assertions">pretty_assertions</a> crate.</p>
</div>
<div id="cargo_dev_dependencies" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="toml"><span></span><span class="tok-n">pretty_assertions</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;1&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Zudem brauchen wir die <code>clap</code> Bibliothek um die Kommandozeilenparameter
zu parsen.</p>
</div>
<div id="cargo_dependencies" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="toml"><span></span><span class="tok-n">clap</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><span class="tok-n">version</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;4&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">features</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-s">&quot;derive&quot;</span><span class="tok-p">]</span><span class="tok-w"> </span><span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installation">Installation</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_build">Build</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Da das ganze eine rust Bibliothek ist brauchen wir eine <code>Cargo.toml</code> Datei damit
das Programm (und die Bibliothek) kompiliert werden können.</p>
</div>
<div class="listingblock">
<div class="title">Cargo.toml</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="toml"><div class="lineno"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span></pre></div></td><td class="code"><div><pre><span></span><span class="tok-k">[package]</span>
<span class="tok-n">name</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;lisi&quot;</span>
<span class="tok-n">version</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;0.2.0&quot;</span>
<span class="tok-n">description</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;literate programming with asciidoc&quot;</span>
<span class="tok-n">readme</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;lisi.adoc&quot;</span>
<span class="tok-n">homepage</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;https://kober-systems.github.io/literate_programming_toolsuite/lisi/lisi.html&quot;</span>
<span class="tok-n">repository</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;https://github.com/kober-systems/literate_programming_toolsuite&quot;</span>
<span class="tok-n">authors</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-s">&quot;Benjamin Kober &lt;benko@kober-systems.com&gt;&quot;</span><span class="tok-p">]</span>
<span class="tok-n">edition</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;2018&quot;</span>
<span class="tok-n">license</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;MIT&quot;</span>
<span class="tok-n">keywords</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-s">&quot;literate-programming&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;asciidoc&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;cli&quot;</span><span class="tok-p">]</span>
<span class="tok-n">categories</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">[</span><span class="tok-s">&quot;command-line-utilities&quot;</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;development-tools&quot;</span><span class="tok-p">]</span>
<span class="tok-n">include</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-p">[</span>
<span class="tok-w">  </span><span class="tok-s">&quot;**/*.rs&quot;</span><span class="tok-p">,</span>
<span class="tok-w">  </span><span class="tok-s">&quot;**/*.pest&quot;</span><span class="tok-p">,</span>
<span class="tok-w">  </span><span class="tok-s">&quot;Cargo.toml&quot;</span><span class="tok-p">,</span>
<span class="tok-p">]</span>

<span class="tok-k">[dependencies]</span>
<span class="tok-err">&lt;&lt;</span><span class="tok-n">cargo_dependencies</span><span class="tok-err">&gt;&gt;</span>

<span class="tok-k">[dev-dependencies]</span>
<span class="tok-err">&lt;&lt;</span><span class="tok-n">cargo_dev_dependencies</span><span class="tok-err">&gt;&gt;</span>
</pre></div></td></tr></table></div></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
</div>
</div>
</body>
</html>